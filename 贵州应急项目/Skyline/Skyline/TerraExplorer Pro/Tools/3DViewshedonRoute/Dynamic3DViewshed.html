<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>ToolTitle</title>
   <meta http-equiv="X-UA-Compatible" content="IE=9"/>
   


    <script language="javascript" src="../ToolsCommon65.js"></script>
    <script type="text/javascript" src="./jscalendar/calendar.js"></script>
    <script type="text/javascript" src="./ViewshedQuery.js"></script>
    <link rel="StyleSheet" href="../Style.css" type="text/css">
    <link rel="stylesheet" type="text/css" media="all" href="./jscalendar/skins/aqua/theme.css"/>
    
    <style>
        .MenuButton
        {
            height: 78px;
            width: 70px;
            margin: 5px;
			padding: 0px;
            white-space: normal;
        }
        .MenuButtonHighlight
        {
            color: Red;
            font-weight: bold;
        }
        Select {width:110px;font-family:  Arial, Helvetica, sans-serif; font-size: 11px; font-style: normal; font-weight: normal; color: #000000; text-decoration: none;}
        INPUT {width:110px;font-family:  Arial, Helvetica, sans-serif; font-size: 11px; font-style: normal; font-weight: normal; color: #000000; text-decoration: none;}

    </style>
</head>
<body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" style="border: 0;  width:100%;   overflow: auto;" id="Body" onload="Init()" onunload = "closeTool(toolName);">
    <table border="0" style="width:100%">
        <tr id='ModelTypeTRID'> <!-- Model Type -->
            <td class="s8b i18n" style="width:110px">Text4</td>
            <td align="left">
                &nbsp;<select id="ModelTypeID" size="1" style="z-index: 1;" onchange="ModelTypeChanged()">
                    <option value="1" class="i18n">Text5</option> 
                    <option value="2" class="i18n">Text6</option> 
                    <option value="3" class="i18n">Text7</option>
                    <option value="4" class="i18n" selected = "selected">Text8</option>
                    <option value="5" class="i18n">Text9</option>
                </select>
                <img id="DynamicImage" src="img/car1.gif" align ="middle">
            </td>
        </tr>  
        <tr class='TableOtherLine'  id='StartTimeTRID' hidden=true>
            <td align="top" class="s8b i18n">Text54</td>
            <td align="left"> 
                
                <input type="text" name="date" id="start_date_c" readonly="1" onchange = "StartTimeChangeDynamically()" style="z-index: 1; width:107px;"/>&nbsp;
                <img alt="start" src="./jscalendar/img.gif" id="start_trigger_c" style="cursor: pointer; border: 0px;" title="Start Date and Time" onmouseover="this.style.background='red';" onmouseout="this.style.background=''" />
            </td>   
        </tr>
        <tr class="s8" hidden=true id='EndTimeTRID'>
            <td align="top" class="s8b i18n">Text55</td>
            <td align="left">  
                    
                <input type="text" name="date" id="end_date_c" readonly="1" onchange = "EndTimeChangeDynamically()" style="z-index: 1; width:107px;"/>&nbsp;
                <img alt="End" src="./jscalendar/img.gif" id="end_trigger_c" style="cursor: pointer; border: 0px;" title="End Date and Time" onmouseover="this.style.background='red';" onmouseout="this.style.background=''" />
            </td>
        </tr>
        <tr class='TableOtherLine' id='SpeedTRID'>   <!-- Speed -->
            <td align="top" class="s8b i18n">
                Text10
            </td>
            <td align="left">
                <!--&nbsp;--><input id="SpeedID" type="text" value="60"  onchange="SpeedChangeDynamically()" onkeypress = "enterpressalert(event, this)"/><!--"CheckNumberEx(SpeedID,60,1,999999)">--><!--style="z-index: 1; width:105px;"-->
               <select id="SpeedUnitID" size="1" onchange = "SpeedChangeDynamically()"><!--style="z-index: 1; width:70px;"-->
                    <option value="0.277777777778" class="i18n" selected="selected">Text11</option> 
                    <option value="0.44704"  class="i18n">Text12</option> 
                </select>
            </td>
        </tr>
        <tr id='LoopTRID' >                           
            <td class="s8b ">
                <span id="DistanceText" class="i18n">Text13</span>
            </td>
            <td align="left">
                &nbsp;<select id="LoopID" size="1"  onchange = "LoopChangeDynamically()";><!--style="z-index: 1; width:50px;"-->
                    <option value="0" class="i18n" >Text14</option> 
                    <option value="1" class="i18n" selected="selected">Text15</option> 
                </select>
            </td>
        </tr>
         <tr id='IntervalTRID' hidden=true>                           
            <td class="s8b ">
                <span id="Span2" class="i18n">Text56</span>
            </td>
             <td align="left">
                &nbsp;<input id="IntervalID" type="text" onchange= "CheckNumberEx(IntervalID,40,1,9999);" value="40" size="7" style="z-index: 1; width:105px;"> <!--"CheckNumberEx(DistanceID,300,1,9999)"-->
                <span class="i18n">Text43</span>
            </td>
        </tr>
        <tr class='TableOtherLine'>
            <td align="top" class="s8b i18n">Text59</td>
            <td align="left">
                &nbsp;<input id="ViewerHeightID" type="text" onchange="ViewerHeightChangeDynamically()" value="2" size="7" onkeypress = "enterpressalert(event, this)" style="z-index: 1; width:105px; "><!--"CheckNumberEx(DistanceID,300,1,9999)"-->
                    
                <span class="i18n">Text43</span>
            </td>
        </tr>        
        <tr>
            <td align="top" class="s8b i18n">
                Text16
            </td>
            <td align="left">
                &nbsp;<input id="DistanceID" type="text" onchange="DistanceChangeDynamically()" value="300" size="7" onkeypress="enterpressalert(event, this)" style="z-index: 1; width:105px;"><!--"CheckNumberEx(DistanceID,300,1,9999)"-->
                    
                <span class="i18n">Text43</span>
            </td>
        </tr>

       <tr class='TableOtherLine'> <!-- Use Spherical Viewshed -->
           <td class="s8b ">
                <span id="Span3" class="i18n">Text52</span>
            </td>
            <td align="left">
                &nbsp;<select id="UseSphericalFOV" size="1" style="z-index: 1; width:50px;" onchange="ChangeFOVType(this)" >
                    <option value="0" class="i18n" >Text14</option> 
                    <option value="1" class="i18n" selected="selected">Text15</option> 
                </select>
            </td>
        </tr>                
        <tr id = 'ColorSchemeTR'> <!-- color palette  -->
            <td class="s8b">
                <span  class="i18n">Text23</span>
            </td>
            <td align="left">
                    &nbsp;<select id="ColorSchemeID" size="1" style="z-index: 1; " onchange = "ColorSchemeChangeDynamically()">
                        <option value="0" class="i18n" selected="selected">Text24</option> 
                        <option value="1" class="i18n" >Text25</option> 
                        <option value="2" class="i18n" >Text26</option> 
                        <option value="3" class="i18n" >Text27</option> 
                    </select>
            </td>
        </tr>
        
         <tr id = 'Quality' hidden = true> <!-- Quality of buffer  -->
            <td class="s8b">
                <span  class="i18n">Text80</span>
            </td>
            <td align="left">
                    &nbsp;<select id="QualityVal" size="1" style="z-index: 1; " >
                        <option value="0" class="i18n" >Text83</option> 
                        <option value="1" class="i18n" selected="selected">Text82</option> 
                        <option value="2" class="i18n" >Text81</option> 
                    </select>
            </td>
        </tr>
        



          <tr  id = "minAltitudeTRID" hidden = true> <!-- Min Altitude above ground-->
            <td class="s8b ">
                <span id="Span4" class="i18n">Text62</span>
            </td>
            <td align="left">
                &nbsp;<input id="minAltitude" type="text" value="1.8" size="7" onchange="CheckNumberEx(minAltitude,1.8,0.01,999999)" style = "width:105px;">
                <span class="i18n">Text43</span>
            </td>
        </tr>

        <tr  class='TableOtherLine' id = "maxAltitudeTRID" hidden = true> <!-- max Altitude above ground-->
            <td class="s8b ">
                <span id="Span5" class="i18n">Text63</span>
            </td>
            <td align="left">
                &nbsp;<input id="maxAltitude" type="text" value="1.8" size="7" onchange="CheckNumberEx(maxAltitude,1.8,0.01,999999)" style = "width:105px;">
                <span class="i18n">Text43</span>
            </td>
        </tr>

        <tr id = "SpacingTRID" hidden = true> <!-- Min Altitude above ground-->
            <td class="s8b ">
                <span id="Span6" class="i18n">Text69</span>
            </td>
            <td align="left">
                &nbsp;<input id="distance" type="text" value="25" size="7" onchange="CheckNumberEx(distance,25,0.01,999999)" style = "width:105px;">
                <span class="i18n">Text43</span>
            </td>
        </tr>
        <tr > 
           <td class="s8b ">
                <span id="Span1" class="i18n">Text18</span>
            </td>
            <td align="left">
                  &nbsp;<input type="button" id="ClipboardID" class="i18n" value="Text53" onclick=SelectClipboardObjects() style="width: 110px; " /></td>                             
        </tr>    
    </table>
   
    <object id="SGWorld" classid="CLSID:3A4F9199-65A8-11D5-85C1-0001023952C1" style="visibility:hidden; display:none;">
    </object>

<script type="text/javascript">
    //-------------------
    // load lang file for calendar

    (function () {
        document.write("<script language='javascript' src='./jscalendar/calendar-lang.js'></" + "script>");
        var code = SGLang.getCode();
        document.write("<script  language='javascript' src='./jscalendar/" + code + "/calendar-lang.js'></" + "script>");
    })();
</script>
<script type="text/javascript" src="./jscalendar/calendar-setup.js"></script>

<script language="JavaScript">

   

//** theses are global variables for the polyline/polygon drawings 
var gPolyObj;
var gPolyMethod;
var gPolygonText = "";
var gPolylineText = "";
var gDrawPolyClick = null;
var gEndDrawPoly = DrawPoly;
//**

var bInEdit;
var bFirstTime;
var gModelScale = 1;
var gModelType = 0;
var gModelName = "";
var gModelAttachAlltitude = 2;
var GroupID = null;
var gObjCount = 0;
var gObjCountForceContinue = false;

var gFirstTime;
var IndicatorsLayer
var FOVIsSpherical = true;
var HorizontalFOVID = 360;
var VerticalFOVID = 90;
var dynamicObj = null; 
var viewshedObj; 
var speed = 0;
var EndTimeTemp;
var StartTimeTemp;
var gActionType;
var objArray = [];
var defStartDate;
var defEndDate;
var gPolyline;

var gTotalHours;
var rootId;
var fromClipboard = false;

var toolName;

var closed = false;
function enterpressalert(e, element) {
    var code = (e.keyCode ? e.keyCode : e.which);
    if (code == 13) {
        $(element).change();
        
    }
}

//--------------
// Init
function Init() {

    Reset(0, 0);
	gDrawPolyAltitudeType = 3;
    defStartDate = new Date();
    defEndDate = new Date();
    defEndDate.setHours(defEndDate.getHours() + 2);
    
    gActionType = GetParamValue("Type", 1);
    AnalysisType(gActionType);
    
    rootId = GetParamValue("rootId", SGWorld.ProjectTree.RootID);
    
    ModelTypeChanged();

    CreateObjects(1);
}
function closeTool(toolName) {

    if (!closed) {
        SGWorld.Window.SetInputMode(0);
        SGWorld.Window.RemovePopupByCaption(toolName);
        SGWorld.Window.HideMessageBarText();
        closed = true;
    }
    else SGWorld.Window.RemovePopupByCaption(toolName);
    
}

//function AnalysisType
function AnalysisType(gActionType) {
    
    switch (gActionType) {
        case "1":
            {
                
                SGWorld.Window.RemovePopupByCaption("3D Viewshed on Route - By Time");
                SGWorld.Window.RemovePopupByCaption("3D Viewshed on Route - Query");
                toolName = "3D Viewshed on Route - By Speed";

                gEndDrawPoly = DrawPoly;
                $("#ModelTypeTRID").show();
                $("#SpeedTRID").show(); 
                $("#LoopTRID").show(); 
                $("#StartTimeTRID").hide();
                $("#EndTimeTRID").hide(); 
                $("#btnTRID").hide();
                $("#IntervalTRID").hide();
                $("#minAltitudeTRID").hide();
                $("#maxAltitudeTRID").hide();
                $("#SpacingTRID").hide();
                $("#Quality").hide();
                
                
                break;
            }
        case "2":
            {
                if (SGWorld.Version.Major < 6 && SGWorld.Version.Minor < 6) {
                    alert((SGLang.i18n("Text78")));
                    SGWorld.Window.RemovePopupByCaption("3D Viewshed on Route - By Time");
                }

                SGWorld.Window.RemovePopupByCaption("3D Viewshed on Route - Query");
                SGWorld.Window.RemovePopupByCaption("3D Viewshed on Route - By Speed");
                toolName = "3D Viewshed on Route - By Time";

                gEndDrawPoly = DrawPoly;
                $("#ModelTypeTRID").show();
                $("#SpeedTRID").hide();
                $("#LoopTRID").hide();
                $("#StartTimeTRID").show();
                $("#EndTimeTRID").show();
                $("#btnTRID").hide();
                $("#IntervalTRID").hide();
                $("#minAltitudeTRID").hide();
                $("#maxAltitudeTRID").hide();
                $("#SpacingTRID").hide();
                $("#Quality").hide();
                
                $("#start_date_c").val(prettyDate(defStartDate));
                $("#end_date_c").val(prettyDate(defEndDate));

                startTime = Date.parseDate($("#start_date_c").val(), "%b %e, %Y %H:%M").getTime();
                endTime = Date.parseDate($("#end_date_c").val(), "%b %e, %Y %H:%M").getTime();
                StartTimeTemp = $("#start_date_c").val();
                EndTimeTemp = $("#end_date_c").val();

                
                break;
            }
        case "3":
            {
                SGWorld.Window.RemovePopupByCaption("3D Viewshed on Route - By Time");
                SGWorld.Window.RemovePopupByCaption("3D Viewshed on Route - By Speed");
                toolName = "3D Viewshed on Route - Query";


                

                gFirstTime = true;
                gEndDrawPoly = DrawPolyQuery;
                $("#ColorSchemeTR").hide();
                $("#ModelTypeTRID").hide();
                $("#SpeedTRID").hide();
                $("#LoopTRID").hide();
                $("#StartTimeTRID").hide();
                $("#EndTimeTRID").hide();
                $("#btnTRID").show();
                $("#IntervalTRID").show();
                $("#minAltitudeTRID").show();
                $("#maxAltitudeTRID").show();
                $("#SpacingTRID").show();
                $("#Quality").show();
                
                break;
            }
    }
}
//------------------
// Reset
//------------------
function Reset(FirstTime, FromMouseInputMode) {

    if (!gPolyObj && !fromClipboard) {
        SGWorld.Window.SetInputMode(0);
        return; // fix bug #18359
    }
    
    try {
        if (gPolyObj != null)
            SGWorld.Creator.DeleteObject(gPolyObj.ID);
    } catch (e) { }
  
    bDontAskme = false;
    numObjects = 0;
    
 
    $("#lineButton").removeClass("MenuButtonHighlight");
    $("#groupButton").removeClass("MenuButtonHighlight");
    $("#clipboardButton").removeClass("MenuButtonHighlight");

    SGWorld.ProjectTree.EnableRedraw(1);
    SGWorld.Window.HideMessageBarText();

    if (bInEdit) {
        SGWorld.DetachEvent("OnLButtonDown", DrawPolyLButtonDown);
        SGWorld.DetachEvent("OnRButtonUp", DrawPolyRButtonUp);
        SGWorld.DetachEvent("OnFrame", DrawPolyOnFrame);
        //SGWorld.DetachEvent("OnFrafme", DeleteIfDone);
        SGWorld.DetachEvent("OnInputModeChanged", DrawPolyInputModeChanged);
        SGWorld.DetachEvent("OnFileClosing", closeTool);
        
    }
    bInEdit = false;
    if (objArray != "") $("#ClipboardID").attr("disabled", "disabled");
    if (FirstTime != 1 && FromMouseInputMode == 0) 
    
        
    
    SGWorld.Window.SetInputMode(0);
    
    
    
}
//--------------
// CreateObjects
//--------------
function CreateObjects(method) {
    if (!bInEdit) {
        bInEdit = true;
        SGWorld.AttachEvent("OnLButtonDown", DrawPolyLButtonDown);
        SGWorld.AttachEvent("OnRButtonUp", DrawPolyRButtonUp);
        SGWorld.AttachEvent("OnFrame", DrawPolyOnFrame);
        SGWorld.AttachEvent("OnFileClosing", OnFileClosing);
        
        //detachevent
        SGWorld.AttachEvent("OnInputModeChanged", DrawPolyInputModeChanged);
        SGWorld.AttachEvent("OnFrame", DeleteIfDone);
        gPolyMethod = method;
        SGWorld.Window.SetInputMode(1, abspath() + "/cursor_m.cur");
        SGWorld.Window.ShowMessageBarText(SGLang.i18n("Text46"));
        $(event.srcElement).addClass("MenuButtonHighlight");

    }
    else {
        DrawPolyRButtonUp(0, 0, 0, 0);
    }
}
function OnFileClosing() {
    
    closed = true;
   
}

function DrawPolyInputModeChanged() {

    if (!fromClipboard) {
        closeTool(toolName);
    }
    

}
function OnMouseWheel() {
    return true;
}
var globalCount = -1;
function DeleteIfDone() {
    
    if (globalCount > -1 && globalCount < viewshedArray.length) {
        SGWorld.AttachEvent("OnMouseWheel", OnMouseWheel);
        
        AnalyzePoints();

        if (globalCount == viewshedArray.length && viewshedArray.length > 0) {

            gPolyline.Visibility.Show = true;
            if (gPointsIndex > 0) {
              
                DrawPoints();
            }
            if (PointLayer != null) {
                PointLayer.Save();
                IndicatorsLayer.Save();
            }
            DeleteViewsheds();
            SGWorld.Window.RemovePopupByCaption("3D Viewshed on Route - Query");
            SGWorld.Window.SetInputMode(0);
        }
    }
}
//-----------
// SelectGroupObjects
function SelectGroupObjects() {
    var node = SGWorld.ProjectTree.GetNextItem("", 10);
    if (node == 0 || !(SGWorld.ProjectTree.IsGroup(node) || SGWorld.ProjectTree.IsLayer(node))) {
        alert(SGLang.i18n("Text44"));
        return;
    }
    $(event.srcElement).addClass("MenuButtonHighlight");
    SGWorld.Window.ShowMessageBarText(SGLang.i18n("Text49"));

    searchGeometries2(node, DrawPoly);

    Reset(0, 0);
}
//-----------
// SelectClipboardObjects 
function SelectClipboardObjects() {

    fromClipboard = true;
    if (SGWorld.Application.Clipboard.Count > 1 && gActionType == 3) return alert(SGLang.i18n("Text75"));
    if (SGWorld.Application.Clipboard.Count == 0) return alert(SGLang.i18n("Text76"));
    
    SGWorld.Window.ShowMessageBarText(SGLang.i18n("Text49"), 120000);
    searchGeometriesClipboard(gEndDrawPoly); 

    Reset(0, 0);
}

//-------------
// DrawPoly   
function DrawPoly(geometry, type, altitudeType) {
    if (gActionType == 1) {   // protection: if user change value, not leaving the text box and straight to draw the object 

        CheckNumberEx(SpeedID, 60, 1, 999999);
        CheckNumberEx(ViewerHeightID, 2, 0.1, 9999);
        CheckNumberEx(DistanceID, 300, 1, 9999);

    }
    else {   // protection: if user change value, not leaving the text box and straight to draw the object 
        
        CheckNumberEx(ViewerHeightID, 2, 0.1, 9999);
        CheckNumberEx(DistanceID, 300, 1, 9999);
    }
    if (type != 1 && type != 2)
        return true;
    SGWorld.Window.ShowMessageBarText(SGLang.i18n("Text49"));
    SGWorld.ProjectTree.EnableRedraw(0);

    gModelAttachAlltitude = $("#ViewerHeightID").attr("value");//in case drawing directly right after changing the parameter
    var ret = true;
    if (type == 1)
       var ret = DrawDynamicObject(geometry); 
   
 
    return ret;
}

var groupName;
//----
// DrawDynamicObject
function DrawDynamicObject(polylineGeometry) {
    
    var waypointDirection;
    gObjCount += 1;
   
    if (gObjCount >20 && gObjCountForceContinue == false) {
        CreateTheObjects = confirm(SGLang.i18n("Text51") );
        if (CreateTheObjects)
            gObjCountForceContinue = true;
        else
            return false;
    }

    try{
        // Create dynamic object

        if (GroupID == null)
        GroupID = SGWorld.ProjectTree.CreateGroup(toolName, rootId);
        //GroupID = SGWorld.ProjectTree.CreateGroup(SGLang.i18n("ToolName") + , rootId);
        groupName = SGWorld.ProjectTree.GetItemName(GroupID);  // dummy function to trigger the try-catch mechanism if someone deleted the group

    }
    catch (err) {
        GroupID = SGWorld.ProjectTree.CreateGroup(SGLang.i18n("ToolName"), rootId);
    }

    try{
        dynamicObj = SGWorld.Creator.CreateDynamicObject(null, 0, gModelType, abspath() + gModelName, gModelScale, 0, GroupID, SGLang.i18n("Text21"));
        dynamicObj.CircularRoute = $("#LoopID").attr("value");
        dynamicObj.TurnSpeed = 400;


        // add waypoints
        
        if (gActionType == 1)
            speed = $("#SpeedID").attr("value") * $("#SpeedUnitID").attr("value");
        
            var firstPosition = SGWorld.Creator.CreatePosition(polylineGeometry.Points.Item(0).X, polylineGeometry.Points.Item(0).Y, 0);
            var secondPosition = SGWorld.Creator.CreatePosition(polylineGeometry.Points.Item(1).X, polylineGeometry.Points.Item(1).Y, 0);
            firstPosition = firstPosition.AimTo(secondPosition);


        for (var k = 0; k < polylineGeometry.Points.count; k++) {

            if (k == 0) {
                waypointDirection = firstPosition.Yaw;
            }
            else
                waypointDirection = 0;
            //var a = SGWorld.Creator.CreateRouteWaypoint(polylineGeometry.Points.Item(k).X, polylineGeometry.Points.Item(k).Y, 25, speed, waypointDirection, 0, 0, 0, 0, "");
            var a = SGWorld.Creator.CreateRouteWaypoint(polylineGeometry.Points.Item(k).X, polylineGeometry.Points.Item(k).Y, 0, speed, waypointDirection, 0, 0, 0, 0, "");
            dynamicObj.Waypoints.AddWaypoint(a);
            
        }
        if ($("#LoopID").attr("value") == "1" && gActionType != 2)  // loop 
        {
            
            for (var k = polylineGeometry.Points.count -2 ; k >0 ; k--) {
                var a = SGWorld.Creator.CreateRouteWaypoint(polylineGeometry.Points.Item(k).X, polylineGeometry.Points.Item(k).Y, 0, speed, 0, 0, 0, 0, 0, "");
                dynamicObj.Waypoints.AddWaypoint(a);
            }
        }

        // Create 3D Viewshed
        
        viewshedObj = SGWorld.Analysis.Create3DViewshed(firstPosition, HorizontalFOVID, VerticalFOVID, $("#DistanceID").attr("value"), GroupID, SGLang.i18n("Text22"));
        viewshedObj.RayColor = SGWorld.Creator.CreateColor(250, 250, 250, 0);
        
    }
    catch (err) {
        alert(SGLang.i18n("Text50") + err);
        return false;
    }

    objArray.push({
        "dynamicObj": dynamicObj,
        "viewshedObj": viewshedObj
    });

    setColor();
    viewshedObj.Attachment.AttachTo(dynamicObj.ID, 0, 0, gModelAttachAlltitude, 0, 0, 0);
    
    
    
    
    switch (gActionType) {
        case "1":
            {
                break;
            }
        case "2":
            {
                dynamicObj.MoveByTime = true;
                dynamicObj.CircularRoute = false;

                startTime = Date.parseDate($("#start_date_c").val(), "%b %e, %Y %H:%M").getTime();
                endTime = Date.parseDate($("#end_date_c").val(), "%b %e, %Y %H:%M").getTime();

                EndTimeTemp = $("#end_date_c").val();
                StartTimeTemp = $("#start_date_c").val();
                dynamicObj.TimeSpan.Start = startTime;
                dynamicObj.TimeSpan.End = endTime;
                SGWorld.ProjectTree.SelectItem(GroupID);
                break;
            }
        case "3":
            {
                break;
            }
    }
    //SGWorld.Window.HideMessageBarText();
    return true;
}



function setColor() {
    for (var i = 0; i < objArray.length; i++) {
        if ($("#ColorSchemeID").attr("value") == "0")  // normal  Color Scheme
        {
            objArray[i].viewshedObj.VisibleAreaColor = SGWorld.Creator.CreateColor(0, 255, 0, 80);
            objArray[i].viewshedObj.HiddenAreaColor = SGWorld.Creator.CreateColor(255, 0, 0, 80);
        }
        if ($("#ColorSchemeID").attr("value") == "1")  //  Color Scheme - visible only
        {
            objArray[i].viewshedObj.VisibleAreaColor = SGWorld.Creator.CreateColor(0, 255, 0, 80);
            objArray[i].viewshedObj.HiddenAreaColor = SGWorld.Creator.CreateColor(255, 0, 0, 0);
        }
        if ($("#ColorSchemeID").attr("value") == "2")  //  Color Scheme - invisible only
        {
            objArray[i].viewshedObj.VisibleAreaColor = SGWorld.Creator.CreateColor(0, 255, 0, 0);
            objArray[i].viewshedObj.HiddenAreaColor = SGWorld.Creator.CreateColor(255, 0, 0, 80);
        }
        if ($("#ColorSchemeID").attr("value") == "3")  //  Color Scheme - random
        {
            var red = Math.random() * 255;
            var green = Math.random() * 255;
            var blue = Math.random() * 255;
            objArray[i].viewshedObj.VisibleAreaColor = SGWorld.Creator.CreateColor(red, green, blue, 80);
            var red = Math.random() * 255;
            var green = Math.random() * 255;
            var blue = Math.random() * 255;
            objArray[i].viewshedObj.HiddenAreaColor = SGWorld.Creator.CreateColor(red, green, blue, 80);
        }
    }

}
function ViewerHeightChangeDynamically() {
    
    gModelAttachAlltitude = $("#ViewerHeightID").attr("value");
    if (gActionType == 3) CheckNumberEx(ViewerHeightID, 2, 0.1, 9999);
    for (var i = 0; i < objArray.length; i++) {
        CheckNumberEx(ViewerHeightID, 2, 0.1, 9999);
        if (objArray[i].dynamicObj != null) {
            objArray[i].viewshedObj.Attachment.AttachTo(objArray[i].dynamicObj.ID, 0, 0, gModelAttachAlltitude, 0, 0, 0);
            
        }
    }
}
function EndTimeChangeDynamically() {

    if (Date.parseDate($("#end_date_c").val(), "%b %e, %Y %H:%M").getTime() < startTime) {
        document.getElementById("end_date_c").value = EndTimeTemp;
        return alert(SGLang.i18n("Text58"));
    }
    endTime = Date.parseDate($("#end_date_c").val(), "%b %e, %Y %H:%M").getTime();
    EndTimeTemp = $("#end_date_c").val();
    if (objArray.length != 0) {
        for (var i = 0; i < objArray.length; i++) {
            objArray[i].dynamicObj.TimeSpan.End = endTime;
        }
        SGWorld.ProjectTree.SelectItem(GroupID);
    }
    
}
function StartTimeChangeDynamically() {
   
    if (Date.parseDate($("#start_date_c").val(), "%b %e, %Y %H:%M").getTime() > endTime) {
        document.getElementById("start_date_c").value = StartTimeTemp;
        return alert(SGLang.i18n("Text57"));
    }
    startTime = Date.parseDate($("#start_date_c").val(), "%b %e, %Y %H:%M").getTime();
    StartTimeTemp = $("#start_date_c").val();
    if (objArray.length != 0) {
        for (var i = 0; i < objArray.length; i++) {
            objArray[i].dynamicObj.TimeSpan.Start = startTime;
        }
        SGWorld.ProjectTree.SelectItem(GroupID);
    }
    
}

function ColorSchemeChangeDynamically() {

    if (dynamicObj != null) setColor();
}
function DistanceChangeDynamically() {
    
    if (gActionType == 3) CheckNumberEx(DistanceID, 300, 1, 9999);
    for (var i = 0; i < objArray.length; i++) {
        CheckNumberEx(DistanceID, 300, 1, 9999);
        if (objArray[i].dynamicObj != null) objArray[i].viewshedObj.Distance = $("#DistanceID").attr("value");
    }
}
function LoopChangeDynamically() {
    for (var i = 0; i < objArray.length; i++) {
        if (objArray[i].dynamicObj != null) {
            objArray[i].dynamicObj.CircularRoute = !objArray[i].dynamicObj.CircularRoute;
            objArray[i].dynamicObj.RestartRoute(objArray[i].dynamicObj.Waypoints.Current);
        }
    }
}
function SpeedChangeDynamically() {
    for (var i = 0; i < objArray.length; i++) {
        CheckNumberEx(SpeedID, 60, 1, 999999);
        if (objArray[i].dynamicObj != null) {
            speed = $("#SpeedID").attr("value") * $("#SpeedUnitID").attr("value");
            for (var k = 0; k < dynamicObj.Waypoints.count; k++) {
                objArray[i].dynamicObj.Waypoints(k).Speed = speed;
            }
        }
    }
}
function ModeltypeChangedDynamically() {
    for (var i = 0; i < objArray.length; i++) {
        if ($("#ModelTypeID").attr("value") == "1") {
            $("#DynamicImage").attr("src", "img/car1.gif");
            objArray[i].dynamicObj.DynamicType = 0;
            objArray[i].dynamicObj.FileName = abspath() + "/models/car1.xpl2";
            objArray[i].dynamicObj.ScaleFactor = 1;
            objArray[i].dynamicObj.DynamicType = 0;
            objArray[i].viewshedObj.Attachment.AttachTo(objArray[i].dynamicObj.ID, 0, 0, gModelAttachAlltitude, 0, 0, 0); 
            
        }
        if ($("#ModelTypeID").attr("value") == "2") {
            $("#DynamicImage").attr("src", "img/car2.gif");
            objArray[i].dynamicObj.DynamicType = 0;
            objArray[i].dynamicObj.FileName = abspath() + "/models/car2.xpl2";
            objArray[i].dynamicObj.ScaleFactor = 1;

            objArray[i].viewshedObj.Attachment.AttachTo(objArray[i].dynamicObj.ID, 0, 0, gModelAttachAlltitude, 0, 0, 0);
        }
        if ($("#ModelTypeID").attr("value") == "3") {
            $("#DynamicImage").attr("src", "img/tank.gif");
            objArray[i].dynamicObj.DynamicType = 0;
            objArray[i].dynamicObj.FileName = abspath() + "/models/tank.xpl2";
            objArray[i].dynamicObj.ScaleFactor = 1;

            objArray[i].viewshedObj.Attachment.AttachTo(objArray[i].dynamicObj.ID, 0, 0, gModelAttachAlltitude, 0, 0, 0);
        }
        if ($("#ModelTypeID").attr("value") == "4") {
            $("#DynamicImage").attr("src", "img/icon.png"); //gif");
            objArray[i].dynamicObj.DynamicType = 2;
            objArray[i].dynamicObj.FileName = abspath() + "/models/icon.png";//gif";
            objArray[i].dynamicObj.ScaleFactor = 0.3;

            objArray[i].viewshedObj.Attachment.AttachTo(objArray[i].dynamicObj.ID, 0, 0, gModelAttachAlltitude, 0, 0, 0);
        }
        if ($("#ModelTypeID").attr("value") == "5") {
            $("#DynamicImage").attr("src", "img/empty.gif");
            objArray[i].dynamicObj.DynamicType = 3; // vitual
            objArray[i].dynamicObj.FileName = "";
            objArray[i].dynamicObj.ScaleFactor = 1;

            objArray[i].viewshedObj.Attachment.AttachTo(objArray[i].dynamicObj.ID, 0, 0, gModelAttachAlltitude, 0, 0, 0);
        }
    }

}
//---------------
// ModelTypeChanged
function ModelTypeChanged() {
    
    if (dynamicObj != null) {
        ModeltypeChangedDynamically()
        return;
    }
    
    if ($("#ModelTypeID").attr("value") == "1") {
        $("#DynamicImage").attr("src", "img/car1.gif");
            gModelName = "/models/car1.xpl2";
            gModelScale = 1;
            gModelType = 0; // 3d model
         
        }
       
        if ($("#ModelTypeID").attr("value") == "2") {
            $("#DynamicImage").attr("src", "img/car2.gif");
            gModelName = "/models/car2.xpl2";
            gModelScale = 1;
            gModelType = 0; // 3d model
        
        }
        if ($("#ModelTypeID").attr("value") == "3") {
            $("#DynamicImage").attr("src", "img/tank.gif");
            gModelName = "/models/tank.xpl2";
        gModelScale = 1;
        gModelType = 0; // 3d model
      
    }
        if ($("#ModelTypeID").attr("value") == "4") {
        $("#DynamicImage").attr("src", "img/icon.png");//gif");
        gModelName = "/models/icon.png"; //gif";
        gModelScale = 0.3;
        gModelType = 2; // icon
      
    }
    if ($("#ModelTypeID").attr("value") == "5") {
        $("#DynamicImage").attr("src", "img/empty.gif");
        gModelName = "";
        gModelScale = 1;
        gModelType = 3; // vitual
  
    }

    
    if (dynamicObj != null) {
        if (($("#ModelTypeID").attr("value") == "5")) {
            dynamicObj.DynamicType = 3;
            return;
        }
            
            
       
        dynamicObj.FileName = abspath() + gModelName;
    }

    }
//--------------
// CheckNumberEx
    function CheckNumberEx(field, defVal, MinNum, MaxNum) {
        
    try {
        field.value = validateNumber(field.value);
        if (field.value == "NaN")
            field.value = defVal;

        if (field.value < MinNum)
            field.value = defVal;
        if (field.value > MaxNum)
            field.value = defVal;
    }
    catch (e) { field.value = defVal }
}


function ChangeFOVType() {

    FOVIsSpherical = !FOVIsSpherical;
    if (!FOVIsSpherical) {
        HorizontalFOVID = 120;
    }
    else {
        HorizontalFOVID = 360;
    }
    for (var i = 0; i < objArray.length; i++) {
        if (objArray[i].dynamicObj != null) objArray[i].viewshedObj.FieldOfViewX = HorizontalFOVID;
    }
}

Calendar.setup({
    inputField: "start_date_c",     // id of the input field
    ifFormat: "%b %e, %Y %H:%M",      // format of the input field
    button: "start_trigger_c",  // trigger for the calendar (button ID)
    align: "Tl",           // alignment (defaults to "Bl")
    showsTime: true,            // will display a time selector
    singleClick: true
});
Calendar.setup({
    inputField: "end_date_c",     // id of the input field
    ifFormat: "%b %e, %Y %H:%M",      // format of the input field
    button: "end_trigger_c",  // trigger for the calendar (button ID)
    align: "Tl",           // alignment (defaults to "Bl")
    showsTime: true,            // will display a time selector
    singleClick: true
});

function prettyDate(date) {
    
    var months = prettyMonth(date)+" ";
    var day = date.getDate()+", ";
    var year = date.getFullYear() + " ";
    var Hours = date.getHours() + "";
    if (Hours.length == 1)
        Hours = "0" + Hours;
    var minutes = date.getMinutes() + "";
    if (minutes.length == 1)
        minutes = "0" + minutes;
    var time = Hours + ":" + minutes;
    return "" + months + day + year + time;
}
function prettyMonth(date) {
    
    var month = new Array(12);
    month[0] = "Jan";
    month[1] = "Feb";
    month[2] = "Mar";
    month[3] = "Apr";
    month[4] = "May";
    month[5] = "Jun";
    month[6] = "Jul";
    month[7] = "Aug";
    month[8] = "Sep";
    month[9] = "Oct";
    month[10] = "Nov";
    month[11] = "Dec";

    return month[date.getUTCMonth()];
}


var finished = false;
var bDontAskme;
var currentObject = 1;
var numObjects;
var viewshedArray = [];
var ViewerAltitude;
//-------------
// DrawPolyQuery
function DrawPolyQuery(geometry, type, altitudeType) {
    
    ViewerAltitude = $("#ViewerHeightID").attr("value")
    SGWorld.ProjectTree.EnableRedraw(0);
    checkParams();

    retVal = DrawOnPolyline(geometry, type, altitudeType);
    numberOf3DViewsheds = 0;
    SelectViewshedObjects();
   

    return retVal;
}
function checkParams() {
    try {
        
        //CheckNumberEx(field, defVal, MinNum, MaxNum)
         
        CheckNumberEx(IntervalID, 40, 1, 9999);
        CheckNumberEx(ViewerHeightID, 2, 0.1, 9999);
        CheckNumberEx(DistanceID, 300, 1, 9999);
        CheckNumberEx(minAltitude, 1.8, 0.01, 999999);
        CheckNumberEx(maxAltitude, 1.8, 0.01, 999999);
        CheckNumberEx(distance, 25, 0.01, 999999);


    }
    catch (e) { 
    
    }
}
//-------------
// DeleteViewsheds
function DeleteViewsheds() {
   

    for (var i = 0; i < viewshedArray.length; i++) {
        SGWorld.ProjectTree.DeleteItem(viewshedArray[i].ID);
    }
    
}
//-------------
// DrawOnPolyline
function DrawOnPolyline(polylineGeometry, type, altitudeType) {
    var lastCoord;
    var currCoord;
    var tmpCoord;
    var SegmentLength;
    var lastSegmentLenght;
    var distance = validateNumber($("#IntervalID").attr("value"));
    var LeftOver = 0;
    var totlaDistance = 0;

    for (var k = 1; k < polylineGeometry.Points.count; k++)   // calculate total distance
    {
        lastCoord = SGWorld.Creator.CreatePosition(polylineGeometry.Points.Item(k - 1).X, polylineGeometry.Points.Item(k - 1).Y, polylineGeometry.Points.Item(k - 1).Z, altitudeType);
        currCoord = SGWorld.Creator.CreatePosition(polylineGeometry.Points.Item(k).X, polylineGeometry.Points.Item(k).Y, polylineGeometry.Points.Item(k).Z, altitudeType);
        totlaDistance += lastCoord.DistanceTo(currCoord);
    }
    CreateTheObjects = true;
    if (!bDontAskme && (totlaDistance / distance) > 2000)
        CreateTheObjects = confirm(SGLang.i18n("Text32") + NumBreaks + SGLang.i18n("Text33"));
    if (CreateTheObjects) {

            GroupID = SGWorld.ProjectTree.CreateGroup("", rootId);               
            groupName = SGWorld.ProjectTree.GetItemName(GroupID);  // dummy function to trigger the try-catch mechanism if someone deleted the group
            groupName = groupName.substring(9);
            SGWorld.ProjectTree.DeleteItem(GroupID);
            GroupID = SGWorld.ProjectTree.CreateGroup(toolName + " " + groupName, rootId);
            groupName = SGWorld.ProjectTree.GetItemName(GroupID);
            

            bDontAskme = true;
            var firstSegment = true;
        
        for (var i = 1; i < polylineGeometry.Points.count; i++) {
            lastCoord = SGWorld.Creator.CreatePosition(polylineGeometry.Points.Item(i - 1).X, polylineGeometry.Points.Item(i - 1).Y, polylineGeometry.Points.Item(i - 1).Z, altitudeType);
            currCoord = SGWorld.Creator.CreatePosition(polylineGeometry.Points.Item(i).X, polylineGeometry.Points.Item(i).Y, polylineGeometry.Points.Item(i).Z, altitudeType);

            lastCoord.yaw = lastCoord.AimTo(currCoord).yaw;
            lastCoord = lastCoord.MoveToward(currCoord, -LeftOver);

            if (firstSegment) {
                firstTime = true;
                tmpCoord = lastCoord.Copy();

                if (DrawViewshed(tmpCoord, polylineGeometry) == false)
                    return false;
            }
            SegmentLength = lastCoord.DistanceTo(currCoord);
            lastSegmentLenght = SegmentLength;

            while (SegmentLength >= distance && lastSegmentLenght >= SegmentLength) {
                lastSegmentLenght = SegmentLength;
                lastCoord = lastCoord.MoveToward(currCoord, distance);
                tmpCoord = lastCoord.Copy();
                if (DrawViewshed(tmpCoord, polylineGeometry) == false)
                    return false;
                SegmentLength = lastCoord.DistanceTo(currCoord);
            }
           
            LeftOver = SegmentLength;
            
            firstSegment = false;
        }
    }

    gPolyline = SGWorld.Creator.CreatePolyline(polylineGeometry, SGWorld.Creator.CreateColor(), altitudeType, GroupID, "Route");
    gPolyline.Visibility.Show = false;
    gPolyline.LineStyle.Width = -2;
    gPolyline.Visibility.MaxVisibilityDistance = 30000;
    gPolyline.LineStyle.Color = SGWorld.Creator.CreateColor(255, 255, 0);
    return true;
}

function DrawViewshed(position, geometry) {
    currentObject++;
    SGWorld.Window.ShowMessageBarText(SGLang.i18n("Text31") + " " + currentObject, 120000);

    var creator = objectTypeCreators["3DViewshed"];
    if (creator) {
        creator(position);
    }
    return (true);
}
var objectTypeCreators = {
    "3DViewshed": function (position) {

        //position.Altitude = $("#ViewerAltitude").attr("value");
        position.Altitude = ViewerAltitude;

        _3DViewshed = SGWorld.Analysis.Create3DViewshed(position, HorizontalFOVID, VerticalFOVID, $("#DistanceID").attr("value"), GroupID, SGLang.i18n("Text22"));
        _3DViewshed.Visibility.Show = false;
        _3DViewshed.Position.AltitudeType = 3;
        wpi = SGWorld.Terrain.GetGroundHeightInfo(position.X, position.Y, 2, true);
        _3DViewshed.Position.Altitude = wpi.Position.Altitude + position.Altitude;
       
        //_3DViewshed.Position.Altitude = ViewerAltitude;
        numObjects++;
        viewshedArray.push(_3DViewshed);
        SGWorld.ProjectTree.SetVisibility(_3DViewshed.ID, false);

        if (gFirstTime) {
            IndicatorsLayer = SGWorld.Creator.CreateNewFeatureLayer(SGLang.i18n("Text79"), LayerGeometryType.LGT_POINT, "FileName=Indicators Layer" + ".shp;TEPlugName=OGR;", GroupID);
            IndicatorsLayer.Streaming = true;
            IndicatorsLayer.FeatureGroups.SetProperty("Altitude Method", "11");
            IndicatorsLayer.Save();
            IndicatorsLayer.Refresh();
            IndicatorsLayer.FeatureGroups.Point.DisplayAs = ObjectTypeCode.OT_IMAGE_LABEL;
            IndicatorsLayer.FeatureGroups.SetProperty("Image File", abspath() + "\\img\\circle.png");
            //IndicatorsLayer.FeatureGroups.SetProperty("Scale", parseFloat($("#IntervalID").attr("value")) / 750); // old size setting
            IndicatorsLayer.FeatureGroups.SetProperty("Scale", 15); //made to fit size to all scenes
            IndicatorsLayer.FeatureGroups.SetProperty("Smallest Visible Size", "1");

            var TEMes = SGWorld.Creator.CreateMessage(5, 'TempLoc= This65.Geometry.X&","&This65.Geometry.Y\nIf (SGWorld65.ProjectTree.FindItem("' + groupName + '\\Viewsheds") = "") Then\nSGWorld65.ProjectTree.CreateGroup "Viewsheds", SGWorld65.ProjectTree.FindItem("' + groupName + '")\nEnd If\nGroupID = SGWorld65.ProjectTree.FindItem("' + groupName + '\\Viewsheds")\nSGWorld65.ProjectTree.LockGroup GroupID , true\nTargetID = SGWorld65.ProjectTree.GetNextItem (GroupID, 11)\nName = ""\nExist = 0\nThis65.Tint.FromABGRColor 4294967295\nDo While (Not TargetID = "")\nName = SGWorld65.ProjectTree.GetItemName(TargetID)\nIf (Name = TempLoc) then\nExist = 1\nName = ""\nExit Do\nelse\nTargetID = SGWorld65.ProjectTree.GetNextItem (TargetID, 13)\nend if\nloop\nif Exist = 1 then\nSGWorld65.ProjectTree.DeleteItem(TargetID)\nelse\nSet position = SGWorld65.Creator.CreatePosition (This65.Geometry.X,This65.Geometry.Y,This65.Geometry.Z+' + ViewerAltitude + ',3,0,0,0,0)\nSet Obj = SGWorld65.Analysis.Create3DViewshed (position, ' + HorizontalFOVID + ', ' + VerticalFOVID + ', ' + $("#DistanceID").attr("value") + ', SGWorld65.ProjectTree.FindItem("' + groupName + '\\Viewsheds") ,"")\nObj.Quality=2\nObj.RayColor = SGWorld65.Creator.CreateColor(250, 250, 250, 0)\nObj.TreeItem.Name = position.X&","&position.Y\nObj.SaveInFlyFile = False\nObj.Position.Yaw = ' + _3DViewshed.Position.Yaw + '\nThis65.Tint.FromABGRColor 4278255615\nend if\nIf (SGWorld65.ProjectTree.GetNextItem (GroupID, 11)) = "" Then\nSGWorld65.ProjectTree.DeleteItem(groupID)\nEnd If', 3);

            IndicatorsLayer.FeatureGroups.Point.SetProperty("Message", TEMes.ID);
            gFirstTime = false;
        }
        IndicatorsLayer.FeatureGroups.Point.CreateFeature([position.X, position.Y, wpi.Position.Altitude]);

    }
}

</script>
</body>
</html>



<!--Sig:000000409c2m84NyR#sx2Ux4RIq5vvbavIB9rilJLstzrY2X.fE1V2G4PcBSmfg.wV7I0NYlLbhdKwHDDOB3C#ctbSnTG.JJ-->


<!--Sig:00000040zOzuGGyReCahwjspzfQzKtn4Rp3pbwKQwpPo9RKFDBNRRzeO9MkDbvZl1bmUAB9okn3cqvRpBV8oLyyCDogWJKJJ-->


<!--Sig:00000040fNvQ88fSSnY2LVLoFUOKzmd.JWWRaHldmlIegk3b0868AW5XKTpnwtV#Cvo7h7Milv3tns#u16.z.sqMhmWjMHJJ-->
