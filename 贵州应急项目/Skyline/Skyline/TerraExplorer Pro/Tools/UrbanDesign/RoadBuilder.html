<HTML>
<HEAD>
<TITLE>ToolTitle</TITLE>
<LINK REL=StyleSheet HREF="../Style.css" TYPE="text/css">
<style type="text/css">
Select {width:130px;font-family:  Arial, Helvetica, sans-serif; font-size: 11px; font-style: normal; font-weight: normal; color: #000000; text-decoration: none; margin-left:-3px; }

</style>
</HEAD>

<body leftmargin="0" topmargin="0"  marginheight="0" style="border:0;overflow:auto; height:100%;" id="Body" OnLoad="Init()" OnUnLoad="Exit()" > <!-- onclick="bHide=true;HideOptionsNow()" > -->

<!-- Roads -->
<table id="RoadsSpan" style="display:none;" class="PropertiesTable" cellPadding=1 CELLSPACING=0 width=100% height=100%>

    <tr>
    <td class="PropertiesTDTop i18n"  align=center colspan =2>
        Text96
    </td>
    </tr>

    <tr class="s8">
    <td class="PropertiesTD i18n" align=top >Text97</td>
    <td class="PropertiesTD" align=left>&nbsp;
        <SELECT ID="RoadTexture" SIZE="1" onchange="SelectRoadTexure()" style="z-index:1; ">
                    <OPTION VALUE="RoadTextures/empty.gif"	class="i18n">Text100
                    <OPTION VALUE="RoadTextures/road-1-1.gif"	class="i18n">Text101
                    <OPTION VALUE="RoadTextures/road-1-2.gif"	class="i18n">Text102
                    <OPTION VALUE="RoadTextures/road-1-3.gif"	class="i18n">Text103
                    <OPTION VALUE="RoadTextures/road-2-1.gif"	class="i18n">Text104
                    <OPTION VALUE="RoadTextures/road-2-2.gif" selected class="i18n">Text105
                    <OPTION VALUE="RoadTextures/road-2-3.gif"	class="i18n">Text106
                    <OPTION VALUE="RoadTextures/road-2-4.gif"	class="i18n">Text107
                    <OPTION VALUE="RoadTextures/road-2-5.gif"	class="i18n">Text108
                    <OPTION VALUE="RoadTextures/road-2-6.gif"	class="i18n">Text109
                    <OPTION VALUE="RoadTextures/road-3-1.gif"	class="i18n">Text110
                    <OPTION VALUE="RoadTextures/road-3-2.gif"	class="i18n">Text111
                    <OPTION VALUE="RoadTextures/road-3-3.gif"	class="i18n">Text112
                    <OPTION VALUE="RoadTextures/tiles-1.gif"	class="i18n">Text113
                    <OPTION VALUE="RoadTextures/tiles-2.gif"	class="i18n">Text114
                    <OPTION VALUE="RoadTextures/tiles-3.gif"	class="i18n">Text115
        </SELECT>
        <img src="RoadTextures/road-2-2.gif" ID="RoadTextureImage" width=32 height=32 border=0 align="absmiddle">
    </td>
    </tr>

    <tr  class='TableOtherLine'>
    <td class="PropertiesTD i18n"  align=top >Text98</td>
    <td class="PropertiesTD" align=left>&nbsp;<INPUT id="RoadBuilderSize" type="text" onchange="RoadWidthChanged()" onkeydown="if (window.event.keyCode ==13) window.event.keyCode = 9;" value="10" SIZE="7" style=""> <span class="i18n">Text99</span></td>
    </tr>

        <!--   Trees     -->
    <tr class="s8">
    <td class="PropertiesTD i18n" align=top >Text116</td>
    <td class="PropertiesTD" align=left>&nbsp;
        <SELECT ID="TreeType" SIZE="1" onchange="SelectTreeTexure()" style="z-index:1;width:100px;">
                    <OPTION VALUE="0"	class="i18n">Text100
                    <OPTION VALUE="10"	class="i18n" selected >Text117
                    <OPTION VALUE="11"	class="i18n">Text118
                    <OPTION VALUE="12"	class="i18n">Text119
                    <OPTION VALUE="13"	class="i18n">Text120
                    <OPTION VALUE="14"	class="i18n">Text121
                    <OPTION VALUE="15"  class="i18n">Text122
                    <OPTION VALUE="16" 	class="i18n">Text123
        </SELECT>
    <img src="./trees/tree-15s.gif" ID="TreeTextureImage"  border=0 align="absmiddle">
    </td>
    </tr>

    <tr  class='TableOtherLine'>
    <td class="PropertiesTD i18n" align=top >Text124</td>
    <td class="PropertiesTD" align=left>&nbsp;
        <SELECT ID="TreePosition" SIZE="1" onchange="reBuildRoad()" style="z-index:1;">
                    <OPTION VALUE="0" class="i18n">Text125
                    <OPTION VALUE="1" class="i18n">Text126
                    <OPTION VALUE="2" class="i18n">Text127
                    <OPTION VALUE="3" class="i18n">Text128
        </SELECT>
    </td>
    </tr>

    <tr class="s8">
    <td class="PropertiesTD i18n" align=top >Text129</td>
    <td class="PropertiesTD" align=left>&nbsp;<INPUT id="TreesSpacing" type="text" value="20" onchange="reBuildRoad();"  onkeydown="if (window.event.keyCode ==13) window.event.keyCode = 9;" SIZE="7" style="width:100px;"> <span class="i18n">Text130</span> </td>
    </tr>

    <tr  class='TableOtherLine'>
    <td class="PropertiesTD i18n" align=top >Text131</td>
    <td class="PropertiesTD" align=left>&nbsp;<INPUT id="TreesDistance" type="text" value="5" onchange="reBuildRoad();"  onkeydown="if (window.event.keyCode ==13) window.event.keyCode = 9;" SIZE="7" style="width:100px;"> <span class="i18n">Text130</span> </td>
    </tr>
                    <!-- Light Poles -->
    <tr class="s8">
    <td class="PropertiesTD i18n" align=top >Text132</td>
    <td class="PropertiesTD" align=left>&nbsp;
        <SELECT ID="LightType" SIZE="1" onchange="SelectLightTexure()" style="z-index:1;width:100px;">
                    <OPTION VALUE="0"	class="i18n">Text100
                    <OPTION VALUE="20"	class="i18n" selected >Text117
                    <OPTION VALUE="21"	class="i18n">Text118
                    <OPTION VALUE="22"	class="i18n">Text119
                    <OPTION VALUE="23"	class="i18n">Text120
        </SELECT>
    <img src="./lights/lightpole-20s.gif" ID="LightTextureImage" border=0 align="absmiddle">
    </td>
    </tr>

    <tr  class='TableOtherLine'>
    <td class="PropertiesTD i18n" align=top >Text133</td>
    <td class="PropertiesTD" align=left>&nbsp;
        <SELECT ID="LightPosition" SIZE="1" onchange="reBuildRoad()" style="z-index:1;">
                    <OPTION VALUE="0" class="i18n">Text125
                    <OPTION VALUE="1" class="i18n">Text126
                    <OPTION VALUE="2" class="i18n">Text127
        </SELECT>
    </td>
    </tr>

    <tr class="s8">
    <td class="PropertiesTD i18n" align=top >Text129</td>
    <td class="PropertiesTD" align=left>&nbsp;<INPUT id="LightSpacing" type="text" value="40" SIZE="7" onchange="reBuildRoad()"  onkeydown="if (window.event.keyCode ==13) window.event.keyCode = 9;" style="width:100px;"> <span class="i18n">Text130</span> </td>
    </tr>

    <tr  class='TableOtherLine'>
    <td class="PropertiesTD i18n" align=top >Text131</td>
    <td class="PropertiesTD" align=left>&nbsp;<INPUT id="LightDistance" type="text" value="10" SIZE="7" onchange="reBuildRoad()"  onkeydown="if (window.event.keyCode ==13) window.event.keyCode = 9;" style="width:100px;"> <span class="i18n">Text130</span> </td>
    </tr>

    <tr style="height:100%">
    <td class="PropertiesTD" colspan=2 style="height:100%" align="right" valign="bottom">
        <button id="ClosePS" type="button" class="DarkButton i18n" style='width:50'  onclick="CloseApp();">Text71</button>
    </td>
    </tr>
</table>


<!--Junctions -->
<table  id="JunctionsSpan" class="PropertiesTable" style="display: none; height:100%;"  cellspacing=0 cellpadding=1 bgcolor="#ffffff" width=100% class="s8">

    <tr>
    <td class="PropertiesTDTop i18n"  align=center colspan =2>
        Text135
    </td>
    </tr>

    <tr class="s8">
    <td class="PropertiesTD i18n" align=top >Text136</td>
    <td class="PropertiesTD" align=left>&nbsp;
        <SELECT ID="Junction" SIZE="1" onchange="SelectJunctionTexture()" style="z-index:1;">
                    <OPTION VALUE="junction-1-1.gif" class="i18n">Text140
                    <OPTION VALUE="junction-1-2.gif" class="i18n">Text141
                    <OPTION VALUE="junction-1-3.gif" class="i18n">Text142
                    <OPTION VALUE="junction-2-1.gif" class="i18n">Text143
                    <OPTION VALUE="junction-2-2.gif" class="i18n">Text144
                    <OPTION VALUE="junction-2-3.gif" class="i18n">Text145
                    <OPTION VALUE="junction-3-1.gif" class="i18n">Text146
                    <OPTION VALUE="junction-3-2.gif" class="i18n">Text147
                    <OPTION VALUE="junction-3-3.gif" class="i18n">Text148
                    <OPTION VALUE="junction-4-1.gif" class="i18n">Text162
                    <OPTION VALUE="junction-4-2.gif" class="i18n">Text163
                    <OPTION VALUE="junction-4-3.gif" class="i18n">Text164
        </SELECT>
        <img src="junctions\junction-1-1.gif" ID="JunctionTextureImage" width=32 height=32 border=0 align="absmiddle">
    </td>
    </tr>

    <tr style="height:100%">
    <td class="PropertiesTD" colspan=2 style="height:100%" align="right" valign="bottom">
        <BUTTON id="BUTTON1" type="button" class="DarkButton i18n" style='width:50'  onclick="CloseApp();">Text71</BUTTON>
    </td>
    </tr>
</table>

<!--Traffic -->
<table id="TrafficSpan" class="PropertiesTable" style="display: none; height:100%;"   cellspacing=0 cellpadding=1 bgcolor="#ffffff" width=100% class="s8">

    <tr>
    <td class="PropertiesTDTop i18n"  align=center colspan =2>
        Text137
    </td>
    </tr>

    <tr class="s8">
    <td class="PropertiesTD i18n" align=top >Text138</td>
    <td class="PropertiesTD" align=left>&nbsp;
        <SELECT ID="TrafficType" SIZE="1" onchange="SelectTrafficTexure()" style="z-index:1;vertical-align:middle">
                    <OPTION VALUE="1" class="i18n">Text140
                    <OPTION VALUE="2" class="i18n">Text141
                    <OPTION VALUE="3" class="i18n">Text142
                    <OPTION VALUE="4" class="i18n">Text143
                    <OPTION VALUE="5" class="i18n">Text144
                    <OPTION VALUE="6" class="i18n">Text145
                    <OPTION VALUE="7" class="i18n">Text146
                    <OPTION VALUE="8" class="i18n">Text147
                    <OPTION VALUE="9" class="i18n">Text148
        </SELECT>
    <span style="width:20px;height:35px;vertical-align:middle"><img src="trafficlights\light-1s.gif" ID="TrafficTextureImage" border=0></span>
    </td>
    </tr>
    <tr style="height:100%">
    <td class="PropertiesTD" colspan=2 style="height:100%" align="right" valign="bottom">
                <BUTTON id="BUTTON2" type="button" class="DarkButton i18n" style='width:50'  onclick="CloseApp();">Text71</BUTTON>
    </td>
    </tr>
</table>
<object ID ="SGWorld65" classid="CLSID:3a4f9197-65a8-11d5-85c1-0001023952c1" style="visibility:hidden;height:0"></object>

<script src="skyline:sgapi.js"></script>
<script language="javascript" src="../ToolsCommon.js"></script>

<SCRIPT Language="JavaScript">

var globe = null;
var InEdit;
var InEditEx;

var ContentWindow = null;

var DrawingGroup = null;
var roadGroup = null;
var RoadPolyline = null;
var Junction = null;
var TrafficLight = null;

var RoadVerts = new Array;
var RoadNumPoints;
var RoadTextureFileName;

var JunctionX ;
var JunctionY ;


var lastId;
var lastImageLeft;
var lastImageRight;

var LeftOver;
var FoundPolyline;

var NewObject = true;
var ResetDone = false;
var InitDone = false;

var RestoringProperties = false;


var God;
var position;
var wpi;
//--------------
// Init
//--------------
function Init() {

    
    globe = new SGWorld();
    God = SGWorld65;
    
    try { globe.teCore.IScriptEngine.UnregisterName ("ToolsEditorWindow");   }catch(e) {a=0;} 
    try { globe.teCore.IScriptEngine.RegisterGlobalName ("ToolsEditorWindow", window); }catch(e) {globe.showPopup (new SGNotification ("Error while trying to register ToolsEditorWindow.",5000));} 


    globe.root.setName("Road Builder");

    globe.attachEvent("onLButtonDown", OnLButtonDown);
    globe.attachEvent("onRButtonDown", OnRButtonDown);
    globe.attachEvent("onFrame", OnFrame);
    globe.attachEvent("onInputModeChanged", OnInputModeChanged);

    RoadPolyline = null;
    Junction = null;
    TrafficLight = null;

    window.document.focus();

    InEdit = 0;
    InEditEx = 0;
    LeftOver = 0;
    RoadNumPoints = 0;
    JunctionX  = 0;
    JunctionY = 0;

    lastId = document.all["RoadsSpan"];
    lastImageLeft = document.all["RoadLeftImg"];
    lastImageRight = document.all["RoadRightImg"];

    RoadTextureFileName = SGAPI.toAbspath("RoadTextures/road-2-2.gif");

        
    Oper = GetParamValue ("params","0");
    //try {Oper = ContentWindow.ToolsParam;} catch(e) {alert ("Error reading global name: ContentCreatorWindow");}

    if (Oper != "0") {
        sep = Oper.split(",");
        type = parseInt(sep[0]);
        operation = parseInt(sep[1]);
        DrawingGroup = new SGNode(parseInt(sep[2]));

        if (type == 2)  // Edit existing object
        {
            try {
                var IObject = globe.teCore.IInformationTree.GetObjectEx(operation);
                InEdit = 0;
                NewObject = false;
                switch (IObject.ObjectType) {
                    case 2:          // Road
                        operation = 20;
                        IPolygon = new SGNode(parseInt(IObject.InfoTreeItemID));
                        roadGroup = IPolygon.parentNode();
                        IObject = GetRoadLine(); // iobject will be used to read properties data
                        InEdit = 4;
                        break;
                    case 3:          // Junction
                        operation = 21;
                        Junction = new SGNode(parseInt(IObject.InfoTreeItemID));
                        InEditEx = 1;
                        globe.teCore.IInformationTree.EditItemEx(IObject.InfoTreeItemID, 1, 0);
                        break;
                    case 24:          // traffic light
                        operation = 22;
                        TrafficLight = new SGNode(parseInt(IObject.InfoTreeItemID));
                        InEditEx = 1;
                        globe.teCore.IInformationTree.EditItemEx(IObject.InfoTreeItemID, 1, 0);
                        break;
                }
                SetPanel(operation, false);
                RestorePropertiesFrom(IObject);
            }
            catch (e) { a = 1; }
        }
        else
            SetPanel(operation, true);
    }
    else
        
        Reset(0, 0);
    
}
//--------------
// Reset
//--------------
function Reset (FirstTime, FromMouseInputMode)
{
    if (ResetDone == false)
    {
        ResetDone = true;
        // Create the Road Builder Polygon
        if (RoadPolyline != null )
        {
            if (RoadNumPoints > 2 )
                BuildRoad (true);
            RoadPolyline.innerObj.FgAlpha = 0;
            RoadPolyline.innerObj.Vertices = RoadVerts;
            roadGroup.appendChild (RoadPolyline);   // move the road polyline to be the first child
            //globe.root.removeChild (RoadPolyline);
            RoadPolyline = null;
        }
        else
            if (roadGroup != null && InEdit != 4 )
                DrawingGroup.removeChild (roadGroup);

        InEdit = 0;


        // reset Junction
        if (Junction != null && InEditEx == 1 )
            globe.teCore.IInformationTree.EndEdit ();
        Junction = null;

        // reset Traffic
        if (TrafficLight != null && InEditEx == 1)
            globe.teCore.IInformationTree.EndEdit ()
        TrafficLight = null;

        if (FirstTime != 1 && FromMouseInputMode == 0 )
          globe.window.setInputMode (sgInputModeFreeFlight);

        try 
        {

            if (ContentWindow != null )  // Refresh the group
            {
                 ContentWindow.FinishAddObject  (NewObject);      
            }
           // IContainer.HTMLPopup (1, 0,0,0,0,"Properties","", 2, 1 );
        }
        catch(e) { a=0;   }
    }
}
//--------------
//--------------
function GetParamValue(findParam, defaultValue)
{
    var arr = document.location.href.split("?");
    if (arr.length <= 1) return defaultValue;
    arr = arr[1].split("&");    
    for (var i=0; i < arr.length; i++)
    {
        if (arr[i].indexOf(findParam) == 0 && arr[i].indexOf("=") == findParam.length)
        {
            arr = arr[i].split("=");
            return arr[1];
        }
    }
    return defaultValue;
}


//------------
// SetPanel
//------------
function SetPanel (operation, startdraw)
{
    switch (operation)
    {
        case 20:          // road
            document.all["RoadsSpan"].style.display = "inline";
            if (startdraw) {
                
                roadGroup = globe.creator.createGroup(SGLang.i18n("Text149"));
                DrawingGroup.appendChild(roadGroup);
                StartDrawRoadBuilder();
            }
            break;
    case 21:          // Junctions
        document.all["JunctionsSpan"].style.display = "inline";
        if (startdraw)
            StartJunction();
        break;
    case 22:          // Traffic lights
        document.all["TrafficSpan"].style.display = "inline";
        if (startdraw)
            StartTrafficLight();
        break;
    }
}


//----------------
// Exit
//----------------
function Exit ()
{
    Reset (0,0);
    try { globe.teCore.IScriptEngine.UnregisterName ("ToolsEditorWindow");   }catch(e) {a=1;} 
}    
//-----------------
// CloseApp
//-----------------
function CloseApp ()
{
    Reset(0,0);
    globe.removePopup(SGLang.i18n("Text19"));
}
//--------------
// StartDrawRoadBuilder
//--------------
function StartDrawRoadBuilder ()
{
    if (InEdit != 0 && InEdit != 1 )
        Reset (0,0);

    if (InEdit == 0)
    {
        InEdit = 1;
        globe.window.setInputMode (sgInputModeComClient,"images/cursor_v.cur",true);
        //document.all["DrawRoadBuilder"].value = "Finish";
        //globe.showPopup (new SGNotification ("Left click to add waypoints to the line. Right click or Finish button to finish operation.",10000));
    }
    else
    {
        Reset (0,0);
    }
}
//--------------
// StartJunction
//--------------
function StartJunction ()
{
    if (InEdit != 0 && InEdit != 2 )
      Reset (0,0);

    if (InEdit == 0)
    {
        InEdit = 2;
        globe.window.setInputMode (sgInputModeComClient,"images/cursor_v.cur",true);
        //globe.showPopup (new SGNotification ("First left click to set Junction center. Second left Click to set direction and size. Right click or Finish button to finish operation.",10000));
    }
    else
        Reset (0,0);
    
}
//--------------
// StartTrafficLight
//--------------
function StartTrafficLight ()
{
    if (InEdit != 0 && InEdit != 3 )
         Reset (0,0);

    if (InEdit == 0 )
    {
        InEdit = 3;
        globe.window.setInputMode (sgInputModeComClient,"images/cursor_v.cur",true);
        //globe.showPopup (new SGNotification ("Left click to add Traffic Light. Right click or Finish button to finish operation.",10000));
    }
    else
        Reset (0,0);
}

//--------------
// StartSelectPolyline
//--------------
function StartSelectPolyline ()
{
    FoundPolyline = false;
    SearchPolylinesForRoad (0,false);
    Reset (0,0  );
    if 	(FoundPolyline == false)
        alert(SGLang.i18n("Text150"));
}
//--------------
// SearchPolylinesForRoad
//--------------
function SearchPolylinesForRoad(ItemID, ParentSelected)
{
   //Get the first child item of this group.
    NextCode = 10;
    ChildCode = 10;
    if (ParentSelected == true)
    {
        NextCode = 11;
        ChildCode = 13;
    }
    SiblingItemID = globe.teCore.IInformationTree.GetNextItem(ItemID, NextCode);

   if (SiblingItemID == 0 )
       return;

   //Start with the first child item and traverse all of the sibling items in that group.
   while (SiblingItemID != 0)
   {
       if (globe.teCore.IInformationTree.IsGroup(SiblingItemID) )
          SearchPolylinesForRoad (SiblingItemID, true);
       else
       {
          try 
          {
              var IObject = globe.teCore.IInformationTree.GetObject(SiblingItemID);
              if (IObject != null)
              {
                     if (IObject.ObjectType == 1)   // if this is a polyline
                     {
                        FoundPolyline = true;
                            // Build road on polyline IObject
                            RoadNumPoints = IObject.NumofVertices ;
                            RoadVerts = IObject.Vertices.toArray();
                            RoadNumPoints = RoadNumPoints + 1 ; // wants to draw also the last point
                            BuildRoad (true);
                     }
              }
          }
          catch(e) {var a=1; }

       }
       SiblingItemID  = globe.teCore.IInformationTree.GetNextItem(SiblingItemID, ChildCode)  ;
   }
}

//--------------
// reBuildRoad
//--------------
function reBuildRoad ()
{
    if (InEdit != 4)
        return;
    if (RestoringProperties)
        return;
    // Remove all road components (exept to the road line)
    var nodeList = roadGroup.childNodes();
    for (var i=0; i < nodeList.length; i++)
    {
        if (nodeList.item(i).getName() == "RoadLine")
            line = nodeList.item(i);
        else
            roadGroup.removeChild(nodeList.item(i)); 
                    
    }   
    RoadNumPoints = line.innerObj.NumofVertices ;
    RoadVerts = line.innerObj.Vertices.toArray();
    BuildRoad(true);

    roadGroup.appendChild(line);   // move the road polyline to be the first child
}
function GetRoadLine()
{
    var nodeList = roadGroup.childNodes();
    for (var i = 0; i < nodeList.length; i++)
    {
        if (nodeList.item(i).getName() == "RoadLine")
            return nodeList.item(i).innerObj;
    }
    return null;
}
//--------------
// BuildRoad
//--------------
function BuildRoad (Final)
{
    
    var ShiftedVertRight = new Array;
    var ShiftedVertLeft = new Array;

    if (Final == true)
    {
        CreateShiftedWaypoint (RoadVerts, ShiftedVertRight, RoadNumPoints-1, 1, (validateNumber(document.all["RoadBuilderSize"].value))/2);
        CreateShiftedWaypoint (RoadVerts, ShiftedVertLeft, RoadNumPoints-1, 2, (validateNumber(document.all["RoadBuilderSize"].value))/2);

        if (document.all["RoadTexture"].value.indexOf("empty") <=0)
        {
        //	globe.showPopup (new SGNotification ("Creating road texture..."));

            for (i = 0 ; i < RoadNumPoints - 2; i++)
            {

                var rectArr = new Array (ShiftedVertRight[i*3], ShiftedVertRight[i*3+1], ShiftedVertRight[i*3+2],
                                         ShiftedVertRight[(i+1)*3], ShiftedVertRight[(i+1)*3+1], ShiftedVertRight[(i+1)*3+2],
                                         ShiftedVertLeft[(i+1)*3], ShiftedVertLeft[(i+1)*3+1], ShiftedVertLeft[(i+1)*3+2],
                                         ShiftedVertLeft[i*3], ShiftedVertLeft[i*3+1], ShiftedVertLeft[i*3+2]);

                Polygon = globe.creator.createPolygon(rectArr, "#808080", "#808080", SGLang.i18n("Text152"), sgHeightOnTerrain);
                roadGroup.appendChild (Polygon);
                IPolygon = Polygon.innerObj;

                IPolygon.FgAlpha = 0;
                IPolygon.ClientDataEx("RoadBuilder") = "1";
                IPolygon.TextureFileName = RoadTextureFileName;
                IPolygon.TextureTilingMethod = 1;
                IPolygon.TextureScaleX = validateNumber(document.all["RoadBuilderSize"].value);
                IPolygon.TextureScaleY = validateNumber(document.all["RoadBuilderSize"].value);
                IPolygon.TextureRotateAngle = 90;
            } 
        }

        // Create trees
        if (document.all["TreeType"].value != "0" )
        {
        //	globe.showPopup (new SGNotification ("Creating Trees..."));
            
            if (document.all["TreePosition"].value == 0 || document.all["TreePosition"].value == 1 )    // Right Side
            {
                LeftOver = 0;
                for (var i = 0 ; i < RoadNumPoints -2; i++)
                {
                    DuplicteObjects(document.all["TreeType"].value, ShiftedVertRight[i * 3], ShiftedVertRight[i * 3 + 2], ShiftedVertRight[(i + 1) * 3], ShiftedVertRight[(i + 1) * 3 + 2], validateNumber(document.all["TreesSpacing"].value), validateNumber(document.all["TreesDistance"].value));
                }
            }

            if (document.all["TreePosition"].value == 0 || document.all["TreePosition"].value == 2)    // Left Side
            {
                LeftOver = 0;
                for (var i = 0 ; i < RoadNumPoints -2 ; i++)
                {
                    DuplicteObjects (document.all["TreeType"].value, ShiftedVertLeft[i*3],ShiftedVertLeft[i*3+2], ShiftedVertLeft[(i+1)*3],ShiftedVertLeft[(i+1)*3+2], validateNumber(document.all["TreesSpacing"].value), -validateNumber(document.all["TreesDistance"].value));
                }
            }

            if (document.all["TreePosition"].value == 3 )   // Center
            {
                LeftOver = 0;
                for (var i = 0 ;i < RoadNumPoints -2 ; i++)
                {
                    DuplicteObjects (document.all["TreeType"].value, ShiftedVertLeft[i*3],ShiftedVertLeft[i*3+2], ShiftedVertLeft[(i+1)*3],ShiftedVertLeft[(i+1)*3+2], validateNumber(document.all["TreesSpacing"].value), validateNumber(document.all["RoadBuilderSize"].value)/2);
                }
            }
        }

        // Create Light Poles
        if (document.all["LightType"].value != "0")
        {
        //	globe.showPopup (new SGNotification ("Creating Light Poles..."));
            if (document.all["LightPosition"].value == 0 || document.all["LightPosition"].value == 1 )
            {
                LeftOver = 0;
                for (var i = 0 ; i < RoadNumPoints -2 ; i++)
                {
                    DuplicteObjects (document.all["LightType"].value, ShiftedVertRight[i*3],ShiftedVertRight[i*3+2], ShiftedVertRight[(i+1)*3],ShiftedVertRight[(i+1)*3+2], validateNumber(document.all["LightSpacing"].value), validateNumber(document.all["LightDistance"].value));
                }
            }

            if (document.all["LightPosition"].value == 0 || document.all["LightPosition"].value == 2 )
            {
                LeftOver = 0;
                for (var i = 0 ; i< RoadNumPoints -2 ; i++)
                {
                    DuplicteObjects (document.all["LightType"].value, ShiftedVertLeft[i*3],ShiftedVertLeft[i*3+2], ShiftedVertLeft[(i+1)*3],ShiftedVertLeft[(i+1)*3+2], validateNumber(document.all["LightSpacing"].value), -validateNumber(document.all["LightDistance"].value));
                }
            }
        }

        //globe.showPopup (new SGNotification (" ",1));
    }
    else
    {
        CreateShiftedWaypoint (RoadVerts, ShiftedVertRight, RoadNumPoints, 1, (validateNumber(document.all["RoadBuilderSize"].value))/2);
        CreateShiftedWaypoint (RoadVerts, ShiftedVertLeft, RoadNumPoints, 2, (validateNumber(document.all["RoadBuilderSize"].value))/2);

        for ( var i = RoadNumPoints -1 ; i >= 0 ; i--)
        {
            ShiftedVertRight = ShiftedVertRight.concat (ShiftedVertLeft[i*3], ShiftedVertLeft[i*3+1], ShiftedVertLeft[i*3+2]);
        }
        
        RoadPolyline.innerObj.Vertices = ShiftedVertRight;
    }
    if (Final)
    {
        // save road data to client data 
        var roadLine = GetRoadLine();
        SavePropertiesIn(roadLine);
    }
}

function SavePropertiesIn(object) {
    
    if (RestoringProperties)
        return;

    var data = {};
    if (object) {
        
        $(":input:visible:not(button)").each(function (i, input) {
            var $input = $(input);
            data[$input.attr("id")] = $input.val();

        });
        object.ClientDataEx("RoadBuilder") = JSON.stringify(data);
    }
}

function RestorePropertiesFrom(object)
{
    if (RestoringProperties)
        return;
    RestoringProperties = true;
    var data = {};
    if (object)
    {
        var data = object.ClientDataEx("RoadBuilder");
        if (data)
        {
            data = JSON.parse(data);
            // restore on all inputs, not only visible ones, since if body is not visible yet, all inputs considered hidden and nothing is restored
            $(":input:not(button)").each(function(i, input)			
            {
                var $input = $(input);
                $input.val(data[$input.attr("id")]);
                // fire change only on selects, so they will update the image
                if($input.is("select"))
                    $input.change();
            });
        }
    }
    RestoringProperties = false;
}

//--------------
// CreateShiftedWaypoint
// Direction: 1=right, 2=left, 3=forward, 4=backward
//--------------
function CreateShiftedWaypoint(Vert, ShiftedVert, NumPoints, Direction, Length)
{
    //********Redim ShiftedVert (NumPoints*3)

    for (var  i=0 ; i < NumPoints; i++)
    {
        Alpha = 0;
        if (i == 0 )  // First point
        {
            var pos1 = new SGCoord3D(Vert [i*3], Vert [i*3+2], Vert [i*3+1]);
            var res = pos1.aimTo (new SGCoord3D(Vert [(i+1)*3], Vert[(i+1)*3+2], Vert[(i+1)*3+1]));
            AvrYaw = res.yaw;
            Pitch = res.pitch;
        }
        else
        {
          if (i == NumPoints-1 )   // Last Point
          {
            var pos1 = new SGCoord3D(Vert[(i-1)*3], Vert[(i-1)*3+2], Vert[(i-1)*3+1]);
            var res = pos1.aimTo (new SGCoord3D(Vert [i*3], Vert [i*3+2], Vert [i*3+1]));
            AvrYaw = res.yaw;
            AvrPitch = res.pitch;
          }
          else     // Middle point
          {
            var pos1 = new SGCoord3D(Vert[(i-1)*3], Vert[(i-1)*3+2], Vert[(i-1)*3+1]);
            var res = pos1.aimTo (new SGCoord3D(Vert [i*3], Vert [i*3+2], Vert [i*3+1]));
            Yaw1 = res.yaw;
            Pitch1 = res.pitch;


            var pos1 = new SGCoord3D(Vert [i*3], Vert [i*3+2], Vert [i*3+2]);
            var res = pos1.aimTo (new SGCoord3D(Vert [(i+1)*3], Vert[(i+1)*3+2], Vert[(i+1)*3+1]));
            Yaw2 = res.yaw;
            Pitch2 = res.pitch;

            AvrYaw=Math.abs(Yaw1-Yaw2);
    
            Alpha = (AvrYaw)/2;
            if (AvrYaw > 180 )
                Alpha = 180-Alpha;
            
            if (AvrYaw>180)
                AvrYaw=(Yaw1+Yaw2)/2-180;
            else
                AvrYaw=(Yaw1+Yaw2)/2;
           }
        }

        ShiftedVert [i*3]= Vert [i*3];
        ShiftedVert [i*3+1]= Vert [i*3+1];
        ShiftedVert [i*3+2]= Vert [i*3+2];

        Length1 = Length/Math.cos(Alpha * Math.PI/180);
        if (Length1 > Length*6 )
         Length1 = Length*6;

        var coord1 = new SGCoord3D(ShiftedVert [i*3],ShiftedVert [i*3+2],ShiftedVert [i*3+1]);

        if (Direction == 1 )  
            coord1 = coord1.move (Length1,AvrYaw+90);
            //ICoordSys.MoveCoordEx (ShiftedVert [i*3],ShiftedVert [i*3+2],ShiftedVert [i*3+1],AvrYaw,0,0,0,Length1,0);
        if (Direction == 2 )  
            coord1 = coord1.move (Length1,AvrYaw-90);
            //ICoordSys.MoveCoordEx (ShiftedVert [i*3],ShiftedVert [i*3+2],ShiftedVert [i*3+1],AvrYaw,0,0,0,-1*Length1,0);
        if (Direction == 3 )  
            coord1 = coord1.move (Length1,AvrYaw);
            //ICoordSys.MoveCoordEx (ShiftedVert [i*3],ShiftedVert [i*3+2],ShiftedVert [i*3+1],AvrYaw,0,0,Length1,0,0);
        if (Direction == 4 )  
            coord1 = coord1.move (Length1,AvrYaw+180);
            //ICoordSys.MoveCoordEx (ShiftedVert [i*3],ShiftedVert [i*3+2],ShiftedVert [i*3+1],AvrYaw,0,0,-1*Length1,0,0);

        ShiftedVert [i*3] = coord1.x;		
        ShiftedVert [i*3+2] = coord1.y;		
    }
}

//--------------
// DuplicteObjects
//--------------

function DuplicteObjects (ObjType, X1, Y1, X2, Y2, Spacing, Distance) {

    
    
    var coord1 = new SGCoord2D(X1, Y1);
    var coord2 = new SGCoord2D(X2, Y2);
    
    var direction = coord1.anglesTo(coord2).yaw;
        
    SegmentLength = coord1.distanceTo(coord2);

    if (LeftOver > SegmentLength)
    {
        LeftOver -= SegmentLength;
        return;
    }

    SegmentLength -= LeftOver;


    NumBreaks = Math.round(SegmentLength/Spacing-0.5);
    
    coord1 = coord1.move(Distance, direction+90).move(LeftOver, direction); // move "Distance" 90 deg to the left and then "LeftOver" forward (to the starting point).

    LeftOver = Spacing - (SegmentLength-NumBreaks*Spacing);

    globe.teCore.IInformationTree.EnableRedraw(0);
    
    for (var  i = 0 ; i <= NumBreaks; i++)
    {
        if ( ObjType == 16 )
            drawType =   Math.round(6*Math.random() + 9.5);
        else				
            drawType =   ObjType;

        DrawObject (drawType, coord1.x, coord1.y, 0, direction);

        coord1 = coord1.move(Spacing, direction);
    }
    
    globe.teCore.IInformationTree.EnableRedraw(1);


}
//--------------
// DrawObject
//--------------
function DrawObject(ObjType, X, Y, Altitude, Direction) {
    
    
    wpi = God.Terrain.GetGroundHeightInfo(X, Y, 2, false);
    if ( ObjType > 9 && ObjType < 20 )   // Trees
    {
        tree = globe.creator.createLabel(new SGCoord3D(X, Y, wpi.Position.Altitude, sgHeightAbsolute), "", "");
        roadGroup.appendChild (tree);
        Itree = tree.innerObj;
        Itree = tree.innerObj;
        Itree.ClientDataEx("RoadBuilder") = "1";
        Itree.ImageFileName = SGAPI.toAbspath("trees/tree-" + ObjType + ".gif");
        Itree.LimitGrowth = 0;
        Itree.ScaleFactor = 0.07;
        Itree.BgAlpha = 0;
        
    }

    if ( ObjType > 19 && ObjType < 30 )  // Light Poles
    {
        light = globe.creator.createLabel(new SGCoord3D(X, Y, wpi.Position.Altitude, sgHeightAbsolute), "", "");
        roadGroup.appendChild(light);
        Ilight = light.innerObj;
        Ilight.ImageFileName = SGAPI.toAbspath("lights/lightpole-" + ObjType + ".gif");
        Ilight.ClientDataEx("RoadBuilder") = "1";
        Ilight.LimitGrowth = 0;
        Ilight.ScaleFactor = 0.03;
        Ilight.BgAlpha = 0;
        roadGroup.appendChild (light);
    }
}
//--------------
// RoadWidthChanged
//--------------
function RoadWidthChanged ()
{
    //CheckNumber (document.all["RoadBuilderSize"], 10);
    if ( InEdit == 1 )  //--- Road Builder
        if ( RoadNumPoints > 0 )
            BuildRoad (false);
    reBuildRoad();
}
//--------------
// SelectRoadTexure
//--------------
function SelectRoadTexure()
{
    ObjectSymbol = $("#RoadTexture").val(); ;
   document.all["RoadTextureImage"].src = ObjectSymbol;
   RoadTextureFileName = SGAPI.toAbspath(ObjectSymbol);
   reBuildRoad();
}
//--------------
// SelectTreeTexure
//--------------f
function SelectTreeTexure() {
    
    ObjectSymbol = $("#TreeType").val(); ;
   document.all["TreeTextureImage"].src = "./trees/tree-"+ObjectSymbol+"s.gif";
   reBuildRoad();
}
//--------------
// SelectLightTexure
//--------------
function SelectLightTexure()
{
    ObjectSymbol = $("#LightType").val(); ;
   document.all["LightTextureImage"].src = "./Lights/lightpole-"+ObjectSymbol+"s.gif";
   reBuildRoad();
}
//--------------
// SelectTrafficTexure
//--------------
function SelectTrafficTexure() {
   
    ObjectSymbol = $("#TrafficType").val();

    document.all["TrafficTextureImage"].src = SGAPI.toAbspath("trafficlights/light-" + ObjectSymbol + "s.gif");
    //alert(document.all["TrafficTextureImage"].src);
   if (TrafficLight != null) {
       //alert("TrafficLight != null ==> calling SavePropertiesIn(TrafficLight)");
       //TrafficLight.ImageFileName = SGAPI.toAbspath("trafficlights/light-" + document.all["TrafficType"].value + ".gif");
       TrafficLight.innerObj.ImageFileName = SGAPI.toAbspath("trafficlights/light-" + document.all["TrafficType"].value + ".gif");
       SavePropertiesIn(TrafficLight.innerObj);
   }
}
//--------------
// SelectJunctionTexture
//--------------
function SelectJunctionTexture() {
    ObjectSymbol = $("#Junction").val();
   document.all["JunctionTextureImage"].src = SGAPI.toAbspath("junctions/"+ObjectSymbol);
   if (Junction != null)
   {
       Junction.innerObj.TextureFileName = SGAPI.toAbspath("Junctions/" + document.all["Junction"].value);
       SavePropertiesIn(Junction.innerObj);
   }
}
//--------------
//  OnRButtonDown
//--------------
function  OnRButtonDown(Flags, X, Y) {
   
  if ( RoadPolyline != null )
  {
     Reset (0,0);
     InEdit = 4;
     return true;
  }
}


//--------------
//  OnLButtonDown
//--------------
function OnLButtonDown(Flags, X, Y) {

    if ( InEdit == 0 || InEditEx == 1 )  
        return;
    
    var mouseCoord = new SGCoord2D ();
    globe.window.getMouseInfo (mouseCoord);
    var cursor = globe.window.pixelToWorld (mouseCoord.x,mouseCoord.y);
    if ( cursor == null)
        return;

    cursor.coord.heightType = sgHeightRelative ;
    cursor.coord.height = 0;


    try
    {

  
        if ( InEdit == 1 ) //--- Roads
        {					
            if ( RoadPolyline == null)  
            {
                RoadPolyline = globe.creator.createPolygon(null, sgGreenyellow, new SGColor(0, 0, 0, 0), "RoadLine", sgHeightOnTerrain);
                roadGroup.appendChild(RoadPolyline);
                RoadPolyline.innerObj.ClientDataEx("RoadBuilder") = "1";
                RoadNumPoints = 2;

             
                RoadVerts [0] = cursor.coord.x;
                RoadVerts [1] = 1.0;
                RoadVerts [2] = cursor.coord.y;
                RoadVerts [3] = cursor.coord.x;
                RoadVerts [4] = 2.0;
                RoadVerts [5] = cursor.coord.y;
            }
            else
            {
                RoadNumPoints = RoadNumPoints + 1;
                RoadVerts [(RoadNumPoints-1)*3] = cursor.coord.x;
                RoadVerts [(RoadNumPoints-1)*3+1] = 2.0;
                RoadVerts [(RoadNumPoints-1)*3+2] = cursor.coord.y;

                BuildRoad (false);
            }
        }

        if ( InEdit == 2 )   //--- Junction
        { 
            if ( Junction == null) {
               
                Junction = globe.creator.createRectangle (cursor.coord, 20, 20, new SGColor(0,0,0,0), new SGColor(0,0,0,1), SGLang.i18n("Text153") );
                DrawingGroup.appendChild(Junction);
                IJunction = Junction.innerObj;
                SavePropertiesIn(IJunction);
                IJunction.Distance = 50;
                
                JunctionX = cursor.coord.x;
                JunctionY = cursor.coord.y;
                IJunction.TextureFileName = SGAPI.toAbspath("Junctions/"+document.all["Junction"].value);
                IJunction.TextureTilingMethod = 0;
                IJunction.TextureScaleX = 1;
                IJunction.TextureScaleY = 1;
                IJunction.HeightStyle = 2;
                InEditEx = 1;
                globe.teCore.IInformationTree.EditItemEx (IJunction.InfoTreeItemID,1,0);
            }
        }

        if (InEdit == 3)   //--- Trafic Light
        {
           
            var temp = SGWorld65.Window.PixelToWorld(X, Y, -1);
            wpi = God.Terrain.GetGroundHeightInfo(temp.Position.X, temp.Position.Y, 2, false);
            TrafficFileName = abspath()+"/trafficlights/light-" + document.all["TrafficType"].value + ".gif";

            TrafficFileName = "trafficlights/light-" + document.all["TrafficType"].value + ".gif";
            TrafficLight = globe.creator.createImageLabel(new SGCoord3D(wpi.Position.X, wpi.Position.Y, wpi.Position.Altitude, sgHeightAbsolute), TrafficFileName, SGLang.i18n("Text154"));
            DrawingGroup.appendChild(TrafficLight);
            ITrafficLight = TrafficLight.innerObj;
            SavePropertiesIn(ITrafficLight);
            ITrafficLight.Distance = 50;
            ITrafficLight.scalefactor = 0.03;
            ITrafficLight.LimitGrowth = 0;
            InEditEx = 1;
            globe.teCore.IInformationTree.EditItemEx(ITrafficLight.InfoTreeItemID, 1, 0);
       
        }

    }
    catch (e) { var a = 1;}

}

//--------------
//  OnFrame
//--------------
function  OnFrame()
{

    if ( InEdit == 0 )  
        return;

    var mouseCoord = new SGCoord2D ();
    globe.window.getMouseInfo (mouseCoord);
    var cursor = globe.window.pixelToWorld (mouseCoord.x,mouseCoord.y);
    if ( cursor == null)
        return;

//	if ( CursorObjType != 32 )  
//	{
        if (  RoadPolyline != null)  
        {

            if ( RoadNumPoints > 0 )  
            {
                RoadVerts [(RoadNumPoints-1)*3] = cursor.coord.x;
                RoadVerts [(RoadNumPoints-1)*3+1] = 1.0;
                RoadVerts [(RoadNumPoints-1)*3+2] = cursor.coord.y;
                BuildRoad (false);
            }
        }

//	}  // ObjType
    
}




//--------------
//  OnInputModeChanged
//--------------
function  OnInputModeChanged(NewMode)
{
    if ( InEdit != 0 && InEditEx == 0 )  
        Reset (0,1);

}

//------------
// POP1
//------------
function pop1 (id)
{
    if ( id.style.display == "" )  
    {
        id.style.display = "none";
    }
    else
    {
        id.style.display = "";
    }
}
//--------------
// pop3
//--------------
function pop3 (SelectID, spanID)
{
    if ( SelectID.checked )  
    {
        spanID.style.display = "";
    }
    else
    {
        spanID.style.display = "none";
    }
}


//------------
// Pick
//------------
function pick(ButtonID, TextID, SpanID)
{
//  ColorPicker.style.visibility="hidden";
  pop1 (SpanID);
  ButtonID.style.backgroundColor = window.event.srcElement.value;
  TextID.innerText = window.event.srcElement.value;

}

//--------------------------------------
// abspath
//--------------------------------------
function abspath()
{
    var abspath = unescape(window.location.pathname);

    if(abspath.substring(0,1) == "/")
        abspath = abspath.substring(1,abspath.length)

    for (var i=abspath.length-1; i>=0; i--)
    {
      if (abspath.substring(i,i+1) == "/" || abspath.substring(i,i+1) == "/")
      {
         abspath = abspath.substring(0,i);
         break;
      }
    }

    return(abspath);

}
</script>


</BODY>

</HTML>




<!--Sig:000000403sInA3FL4zEhihGe9w38KjwbNG12ljdoSyfsHLKeK#Ewekl8vobpfhJy#87gHjc1ug7ifYjoThHgU2L0gHy2JDJJ-->
