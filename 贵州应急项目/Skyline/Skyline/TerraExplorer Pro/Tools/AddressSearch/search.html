<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=9">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="StyleSheet" href="../Style.css" type="text/css">
    <script language="javascript" src="../ToolsCommon65.js"></script>
    <style>
        .res {
            margin-right: 15px;
            margin-left: 15px;
            ;
            padding: 3px;
            cursor: pointer;
            display: block;
            font-family: Calibri, Arial;
            color: #eeeeee;
            border-bottom: 1px solid #999999;
            line-height: 13px;
        }

            .res:hover {
                background-color: #1D6376;
            }
    </style>
</head>
<body class="s9w" style="background-color:#404040; margin:2px;padding:0px;overflow-y:hidden">
    <!-- oncontextmenu="return false;">-->


    <input type="text" id="search" style="font-size:14px;color:White;background-color:#404040;  border:solid 1px #999999;padding:1px;height:23px;width:300px;vertical-align:top;" /><img src="SearchButton.gif" onclick="flyToFirstResult()" style="cursor:pointer" />
    <img src="dropdown.gif" onclick="dropdownClick()" style="position:absolute;cursor:pointer;left:280px;" />
    <div id="resultDiv" style=""></div>
    <script>
        var SGWorld = new ActiveXObject("TerraExplorerX.SGWorld65");
        var copyright = ""; //  "<div style='font-size:10px;color:white;position:absolute;bottom:2px'>Data © <a style='color:orange;' target='_blank' href='http://www.openstreetmap.org/copyright'>OpenStreetMap<a/> contributors, ODbL 1.0.</div>";
        var sgServer = SGWorld.GetOptionParam("SGServicesURL");
        //if (osmServer == "http://www.skylineglobe.com/Skylineglobe/layers/osm.json")
        //osmServer = "http://www.skylineglobe.com";

        //var sg = osmServer + "/Skylineglobe/AddressSearch/AddressSearch.ashx?callback=fillAutoComplete<index>&q=";
        var sg = "";
        var jqxhr = $.ajax({
            url: sgServer,
            success: function (data) {
                if (data.AddressSearch) {
                    sg = data.AddressSearch[0].Value + "callback=fillAutoComplete<index>&q=";
                }
            },
            error: function () {
                alert(SGLang.i18n("connectionError"));
                ClosePopup();
            }
        });
        // last request data
        var lastRequest = new searchRequest();
        // results popup
        var gResultsPopup = false;

        var index = 0;
        var popupMe = SGWorld.Window.GetPopupByCaption(SGLang.i18n("ToolName"));

        $(window).unload(hideResultsPopup);

        $(document).ready(function () {
            $(".noselect").each(function () {
                this.onselectstart = function () { return false; };
                this.unselectable = "on";
            });
            $(document).bind("keypress", function (e) {
                if (e.keyCode == 13) {
                    flyToFirstResult();
                }
            });
            // for some reason, can not call focus right in the ready handler.
            setTimeout(function () { $("#search").focus(); }, 100);

            // keyup not working when embedded in TE
            // only input is working, but does not catch backspace :(
            // so lets use interval
            //$("#search").on("keyup propertychange input change paste", doSearch);
            setInterval(doSearch, 300);
        });
        function flyToFirstResult() {
            // if request for current search query was not send, send it
            doSearch();
            // if request was already completed (or results popu is shown - recent searches) fly to first result,
            // otherwise mark request as autoFlyTo
            if (lastRequest.completed || (gResultsPopup && $("#search").val() == ""))
                flyToFirstEntry(lastRequest);
            else
                lastRequest.autoFlyTo = true;
        }
        function hideResultsPopup() {
            //popupMe.Height = 50;
            $("#resultDiv").html("");
            gResultsPopup = false;
            //		if(resultsPopup)
            //			SGWorld.Window.RemovePopup(resultsPopup);
            //		resultsPopup = null;
        }
        var errorWasAlreadyShown = false;
        function doSearch() {
            var query = $("#search").val();
            if (sg == "" || lastRequest.query == query)
                return;

            var request = new searchRequest();
            request.query = query;
            window["fillAutoComplete" + request.index] = function (data) {
                window["calledFillAutoComplete" + request.index] = true;
                fillAutoComplete(data, request);
            }
            lastRequest = request;

            $.getScript(sg.replace("<index>", request.index) + request.query, function () {
                if (!errorWasAlreadyShown) {
                    setTimeout(function () {
                        if (!errorWasAlreadyShown && !window["calledFillAutoComplete" + request.index]) {
                            errorWasAlreadyShown = true;
                            alert(SGLang.i18n("connectionError"));
                        }
                    }, 100);
                }
            });
        };
        function fillAutoComplete(data, request) {
            if (request.index < lastRequest.index) {
                window["fillAutoComplete" + request.index] = undefined;
                return;
            }
            hideResultsPopup();
            request.completed = true;
            request.data = data || [];
            if (request.autoFlyTo) {
                flyToFirstEntry(lastRequest);
                return;
            }
            if (request.data.length == 0)
                return;
            createResultsPopup(request);
        }
        function createResultsPopup(request) {
            var names = [];
            var numberOfLines = 0;
            $(request.data.slice(0, 8)).each(function (index) {
                var displayName = this.Name + " [" + this.Description + "]";
                if (request.query) {
                    var pattern = new RegExp(request.query, "ig");
                    var found;
                    while (found = pattern.exec(displayName)) {
                        displayName = displayName.substr(0, found.index) + "<b>" + found[0] + "</b>" + displayName.substring(found.index + found[0].length);
                        pattern.lastIndex += 7;
                    }
                }
                names.push("<a href='#' onclick='flyTo(" + this.Lat + "," + this.Lon + ", this.innerText, " + index + ");return false;' class='res' style='color:White; font-size:13px; font-weight:normal;'>" + displayName + "</a>");
                numberOfLines += Math.ceil(displayName.length / 58);
            });
            if (names.length == 0)
                showResultsPopup(SGLang.i18n("noResultsFound"), 1);
            else
                showResultsPopup(names.join("") + copyright, numberOfLines + 1);

        }

        function showResultsPopup(text, numberOfLines) {
            hideResultsPopup();
            popupMe.Height = Math.min(numberOfLines * 15 + 60, 800);
            var htmlStr = "";
            htmlStr += text;
            gResultsPopup = true;

            $("#resultDiv").html(htmlStr);
        }

        //	function showResultsPopup(text, numberOfLines)
        //	{
        //		hideResultsPopup();
        //		var popup = popupMe || {Left:20, Top:20, Width:300, Height:30};
        //		resultsPopup = SGWorld.Creator.CreatePopupMessage("", "", popup.Left, popup.Top + popup.Height, popup.Width, Math.min(numberOfLines * 15 + 20, 330));
        //		resultsPopup.InnerHTML = "";
        //		resultsPopup.InnerHTML += "<div class='results'  ><style>body{overflow-y:hidden !important;} .results {width:100%;height:100%;vertical-align:top;margin-right:15px;font-size:12px; font-family:Calibri, Arial, Helvetica, sans-serif; background-color:#404040;}.res{margin:0px;margin-top:2px;cursor:pointer;text-decoration:none;display:block;color:white} .res:hover{background-color:#1D6376;}</style>" + text + "</div>";
        //		resultsPopup.InnerHTML += "<script>var SGWorld=new ActiveXObject('TerraExplorerX.SGWorld65');";
        //		resultsPopup.InnerHTML += "var abspath = function() { return \"" + abspath() + "\";};";
        //		resultsPopup.InnerHTML +=flyTo;
        //		resultsPopup.InnerHTML +=findLastLabel;
        //		resultsPopup.InnerHTML +="</scr"+"ipt> </body></html>";
        //		SGWorld.Window.ShowPopup(resultsPopup);
        //	}


        function searchRequest() {
            index++;
            return { query: null, data: [], index: index, completed: false };
        }
        function flyToFirstEntry(request) {
            if (request.data.length == 0) {
                createResultsPopup(lastRequest);
            }
            else {
                var entry = request.data[0];
                saveSearch(entry);
                flyTo(entry.Lat, entry.Lon, entry.Name + " [" + entry.Description + "]");
                hideResultsPopup();
            }
        }

        function dropdownClick() {
            if (gResultsPopup) {
                hideResultsPopup();
            }
            else {
                if ($("#search").val() == "") {
                    var searches = $.cookie('Search_recentSearches') || "[]";
                    lastRequest = new searchRequest();
                    lastRequest.query = "";
                    lastRequest.data = JSON.parse(searches);
                }
                createResultsPopup(lastRequest);
            }
        }

        function OnSaveSearch(MessageID, SourceObjectID) {
            var parts = MessageID.split("_");
            if (SourceObjectID == "MessageBarText" && parts[0] == "SearchSaveSearch") {
                if (lastRequest.completed) {
                    saveSearch(lastRequest.data[parseInt(parts[1])]);
                    hideResultsPopup();
                }
                return true;
            }
        }
        SGWorld.AttachEvent("OnSGWorldMessage", OnSaveSearch);

        function saveSearch(entry) {
            var searches = $.cookie('Search_recentSearches') || "[]";
            searches = JSON.parse(searches);
            var filteredSearches = [];
            // remove item if already exists
            $(searches).each(function () {
                if (this.Lat != entry.Lat || this.Lon != entry.Lon)
                    filteredSearches.push(this);
            });
            // add new item at the start
            filteredSearches.unshift(entry);
            // limit to 8 first results
            filteredSearches = filteredSearches.slice(0, 8);
            filteredSearches = JSON.stringify(filteredSearches);
            $.cookie('Search_recentSearches', filteredSearches, { expires: 1000 });
        }

        function flyTo(lat, lon, text, index) {
            // can not set cookie from generated page (reuslts)
            // so send MessageBarText to search page that will actually save result);
            if (index != undefined)
                SGWorld.Window.ShowMessageBarText("SearchSaveSearch_" + index);
            var lastLabel = findLastLabel();
            if (lastLabel)
                SGWorld.Creator.DeleteObject(lastLabel);
            // the results are in wgs84
            SGWorld.CoordServices.SourceCoordinateSystem.InitFromEPSG(4326);
            var pos = SGWorld.Creator.CreatePosition(lon, lat, 0, /*AltitudeTypeCode.ATC_TERRAIN_RELATIVE*/ 0, 0, -45, 0, 1000);
            // split text into name and description
            var textParts = text.split("[");
            var name = textParts[0];
            var description = textParts[1].substr(0, textParts[1].length - 1).split(",").join(",\r\n");
            var label = SGWorld.Creator.CreateLabel(pos, name, abspath() + "/pin.png", SGWorld.Creator.CreateLabelStyle(), SGWorld.ProjectTree.HiddenGroupID, "Search!@#$%^&*()_Label");
            label.Style.Scale = 10;
            label.Style.ShowTextBehavior = 1 /*hover */;
            label.Style.TextAlignment = "Right";
            label.Style.TextOnImage = false;
            label.Style.Bold = true;
            label.Style.BackgroundColor.FromHTMLColor("#000000");
            label.Style.BackgroundColor.SetAlpha(0);
            label.SaveInFlyFile = false;
            var message = SGWorld.Creator.CreateMessage(5 /* popup */, " " + name + "\r\n" + description, 0 /*text*/);
            label.Message.MessageID = message.ID;
            SGWorld.Navigate.FlyTo(pos);
            SGWorld.CoordServices.SourceCoordinateSystem.WellKnownText = SGWorld.Terrain.CoordinateSystem.WellKnownText;
        }
        function findLastLabel() {
            return SGWorld.ProjectTree.FindItem(SGWorld.ProjectTree.HiddenGroupName + "\\" + "Search!@#$%^&*()_Label");
        }

        //--------------
        // ClosePopup
        function ClosePopup() {
            try {
                SGWorld.Window.RemovePopupByCaption(SGLang.i18n("ToolName"));
            }
            catch (err) { }
        }
    </script>
</body>
</html>


<!--Sig:00000040NOg4FuzEsRLHwrL8TKgMi8liefMOfZTDvUV3xLCdD89OTQi64.S.K3gjy3iY2JXLJin8WRsBo71yru.lWmKhXQJJ-->
