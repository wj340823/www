<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>ToolTitle</title>


    <script language="javascript" src="../ToolsCommon.js" type="text/javascript"></script>

    <link rel="StyleSheet" href="../Style.css" type="text/css" />
    <style type="text/css">
.s8w {font-family:  Arial, Helvetica, sans-serif; font-size: 11px; font-style: normal; font-weight: normal; color: #ffffff; text-decoration: none;}
.s9w {font-family:  Arial, Helvetica, sans-serif; font-size: 13px; font-style: normal; font-weight: normal; color: #ffffff; text-decoration: none;}
.s10w {font-family:  Arial, Helvetica, sans-serif; font-size: 15px; font-style: normal; font-weight: normal; color: #ffffff; text-decoration: none;}
.Seperator {background-image:url("images/seperator2.png");background-repeat:repeat-y;width:2px;background-position:center;}

.imgBack{background-image:url("images/back.png"); background-repeat:no-repeat;cursor:pointer; width:32px;background-position:center;}
.imgBackOn{background-image:url("images/back_h.png"); background-repeat:no-repeat;cursor:pointer;width:32px;background-position:center;}
.imgForward{background-image:url("images/forward.png"); background-repeat:no-repeat;cursor:pointer; width:32px;background-position:center;}
.imgForwardOn{background-image:url("images/forward_h.png"); background-repeat:no-repeat;cursor:pointer;width:32px;background-position:center;}
.imgRight{background-image:url("images/Right.png"); background-repeat:no-repeat;cursor:pointer; width:32px;background-position:center;}
.imgRightOn{background-image:url("images/Right_h.png"); background-repeat:no-repeat;cursor:pointer;width:32px;background-position:center;}
.imgLeft{background-image:url("images/Left.png"); background-repeat:no-repeat;cursor:pointer; width:32px;  background-position:center;}
.imgLeftOn{background-image:url("images/Left_h.png"); background-repeat:no-repeat;cursor:pointer;width:32px;background-position:center;}
.imgTurnRight{background-image:url("images/TurnRight.png"); background-repeat:no-repeat;cursor:pointer; width:32px;background-position:center;}
.imgTurnRightOn{background-image:url("images/TurnRight_h.png"); background-repeat:no-repeat;cursor:pointer;width:32px;background-position:center;}
.imgTurnLeft{background-image:url("images/TurnLeft.png"); background-repeat:no-repeat;cursor:pointer; width:32px;background-position:center;}
.imgTurnLeftOn{background-image:url("images/TurnLeft_h.png"); background-repeat:no-repeat;cursor:pointer;width:32px;background-position:center;}
.imgUp{background-image:url("images/up.png"); background-repeat:no-repeat;cursor:pointer; width:32px;background-position:center;}
.imgUpOn{background-image:url("images/up_h.png"); background-repeat:no-repeat;cursor:pointer;width:32px;background-position:center;}
.imgDown{background-image:url("images/Down.png"); background-repeat:no-repeat;cursor:pointer; width:32px;background-position:center;}
.imgDownOn{background-image:url("images/Down_h.png"); background-repeat:no-repeat;cursor:pointer;width:32px;background-position:center;}

.CollisionOff{ background-repeat:no-repeat;cursor:pointer; width:50px;background-position:top; color:White;}
.CollisionOn{background-image:url("images/Collision_h.png"); background-repeat:no-repeat;cursor:pointer;width:50px;background-position:top;color:White;}
.XRayOff{ background-repeat:no-repeat;cursor:pointer; width:50px;background-position:top;color:White;}
.XRayOn{background-image:url("images/XRay_h.png"); background-repeat:no-repeat;cursor:pointer;width:50px;background-position:top;color:White;}
.FOVOff{ background-repeat:no-repeat;cursor:pointer; width:50px;background-position:top;color:White;}
.FOVOn{background-image:url("images/FOV_h.png"); background-repeat:no-repeat;cursor:pointer;width:50px;background-position:top;color:White;}
.FOVOn2{background-image:url("images/FOV_h2.png"); background-repeat:no-repeat;cursor:pointer;width:50px;background-position:top;color:White;}

</style>
</head>
<body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" style="background-color:#3F3F3F; border: 0; overflow: hidden;" id="Body" onload="Init()" onunload="exit(true);" oncontextmenu="return false;">
    <!--oncontextmenu="return false;"  onclick="bHide=true;HideOptionsNow()" > -->
<div id="selectDivId">
    <table border="0" cellspacing="0" cellpadding="0"  class="s8w" width="100%">
        <tr>
            <td  >
                <span class="i18n s10w">Text1</span>
                <span class="i18n s10w" style="cursor:pointer;" onclick="startNavigate();">Text2</span>
                <span class="i18n s10w">Text3</span>
            </td>
            <!--<td align="right" valign="top">
                <img  class="imageButton" src="images/close.png" alt="ExitAlt" onclick="exit(false);" />
            </td>       -->     

        </tr>
    </table>
    
</div>
<div id="navigationDivId" style="display:none;">
    <table border="0" cellspacing="4" cellpadding="0"  class="s8w" width="100%" height="100%">
        <tr valign="middle" align="center">

            <td height="26px"  class="imgTurnLeft i18n" onmouseover="this.className='imgTurnLeftOn';" onmouseout="this.className='imgTurnLeft';turnOff();"  onmousedown="turnOn(-1,false);" onmouseup="turnOff();" ondblclick="turnOn(-1,true);"></td>
            <td  class="imgForward i18n" onmouseover="this.className='imgForwardOn';" onmouseout="this.className='imgForward';SlideOff(true);"    onmousedown="SlideOn(0);" onmouseup="SlideOff(false);"  ></td>
            <td class="imgTurnRight i18n" onmouseover="this.className='imgTurnRightOn';" onmouseout="this.className='imgTurnRight';turnOff();"  onmousedown="turnOn(1,false);" onmouseup="turnOff();" ondblclick="turnOn(1,true);"></td>
            <td rowspan="2" class="Seperator"></td>
            <td class="imgUp i18n" onmouseover="this.className='imgUpOn';" onmouseout="this.className='imgUp';"  onclick="moveTo(0,90,6,6,2);"></td>
            <td rowspan="2" class="Seperator"></td>
            <td  rowspan="2"  id="CollisionID"  class="CollisionOff i18n" onclick="Collision(0);" align="center" ><img src="Images/collision.png" alt="" style="margin-bottom:10px;" /><br /><span class="i18n" >CollisionTxt</span></td>
            <td rowspan="2" class="Seperator"></td>
            <td  rowspan="2"  id="XRayID"  class="XRayOff i18n" onclick="XRay();" align="center" ><img src="Images/Xray.png" alt="" style="margin-bottom:10px;" /><br /><span class="i18n">XRayTxt</span></td>
            <td rowspan="2" class="Seperator"></td>
            <td  rowspan="2"  id="FovID"  class="FOVOff i18n" onclick="FOV(-1);" align="center"><img src="Images/FOV.png" alt=""  style="margin-bottom:10px;"/><br /><span class="i18n">FOVTxt</span></td>
            <td  rowspan="2" align="right" valign="bottom" ><img  id="LocationID" class="imageButton i18n"    src="images/location.png" alt="LocationAlt" onclick="ShowLocations();" /></td>
        </tr>  
   <!--     <tr>
        <td height="4px" ></td>
        <td></td>
        <td></td>
        <td height="4px"><img src="Images/lift_line.png" alt=""></td>
        </tr>-->
        <tr>
            <td height="24px"  class="imgLeft i18n" onmouseover="this.className='imgLeftOn';" onmouseout="this.className='imgLeft';SlideOff(true);"  onmouseup="SlideOff(false);" onmousedown="SlideOn(270);"  ></td>
            <td  class="imgBack i18n" onmouseover="this.className='imgBackOn';" onmouseout="this.className='imgBack';SlideOff(true);"  onmouseup="SlideOff(false);" onmousedown="SlideOn(180);"  > </td>
            <td  class="imgRight i18n" onmouseover="this.className='imgRightOn';" onmouseout="this.className='imgRight';SlideOff(true);"  onmouseup="SlideOff(false);" onmousedown="SlideOn(90);"  ></td>
            <td  align="center" class="imgDown i18n" onmouseover="this.className='imgDownOn';" onmouseout="this.className='imgDown';"  onclick="moveTo(0,-90,6,6,2);"></td>
        </tr>  
    </table>
</div>

    <object id="SGWorld" classid="CLSID:3a4f9199-65a8-11d5-85c1-0001023952c1" style="visibility:hidden;height:0 "></object>

<script language="JavaScript">
function DetectTEMode()
{
var vMode = document.documentMode;
var rMode = 'IE5 Quirks Mode';
if(vMode == 8){
  rMode = 'IE8 Standards Mode';
} else if(vMode == 7){
  rMode = 'IE7 Strict Mode';
} else if(vMode == 9){
  rMode = 'IE9 Strict Mode';
}
//alert('Rendering in: ' + rMode);
}
DetectTEMode();

var isStart = false;
var gSelectMode = false;
var gNavigateMode = false;
var gCollisionChecked = false;
var gMoveToSides = false;
var gNewPos = null;
var gMovementTimeout;
var gCollisionTimeout;
var cameraHeight = 2;
var gXRayMode = 0;
var gFovMode = 0;
var gHomePosition;
var gOrigCollision;
var gNavigationControls;
var bInit = false;
var gPopup;
var gLocationsPopup = null;
var gLocationFolder = "";
var gTurnTimer = null;
var gTurnDirection = 0;
var clickCounter = 0;  // for debug
var gSlideTimer = null;
var gSlideMoved = false;
var gSlideDirection = 0;
var gTurnDblClick = false;
//--------------
// Init
function Init() {

    if (bInit)
        return;
    bInit = true;
    SGWorld.AttachEvent("OnInputModeChanged", OnInputModeChanged);
    SGWorld.AttachEvent("OnSGWorldMessage", OnSGWorldMessage);

    gPopup = SGWorld.Window.GetPopupByCaption(SGLang.i18n("ToolName"));
    gHomePosition = SGWorld.Navigate.GetPosition();
    gOrigCollision = CheckCollision();
    var inDoor = checkInDoor();
    gNavigationControls = SGWorld.Window.GetControls();
    try {
        var newControls = gNavigationControls & ~1;
        SGWorld.Window.ShowControls(newControls);

        if (inDoor)
            startNavigate();
        else
            selectBuilding();
    }
    catch (e) { }
}

//------------------
// Reset
//------------------
function Reset(FirstTime, FromMouseInputMode) {

    try {
        SGWorld.DetachEvent("onLButtonDown", onLButtonDown);
        SGWorld.DetachEvent("onRButtonUp", onRButtonUp);
        gSelectMode = false;

        if (FirstTime != 1 && FromMouseInputMode == 0)
            SGWorld.Window.SetInputMode(0);
    }
    catch (e) { }
}
//--------------
// checkInDoor
function checkInDoor() {
    var CameraPosition = SGWorld.Navigate.GetPosition();
    var newPoint = CameraPosition.Move(30, 0, 90); // check 30 meters above the camera
    var SurfaceDistance = SGWorld.Navigate.DetectCollisionToTarget(newPoint);
    if (SurfaceDistance > 0)
        return true;
    return false;
}

//--------------
// selectBuilding
function selectBuilding() {
    SGWorld.AttachEvent("onLButtonDown", onLButtonDown);
    SGWorld.AttachEvent("onRButtonUp", onRButtonUp);
    gSelectMode = true;
    SGWorld.Window.SetInputMode(1, abspath() + "/cursor_m.cur");
}
//--------------
// startNavigate
function startNavigate() {
    $("#selectDivId").hide();
    $("#navigationDivId").show();
    SGWorld.Window.SetInputMode(0);
    SGWorld.Command.Execute(1051, 0);
    Collision(1);
    FOV(1);
    gMovementTimeout = setTimeout("move()", 10);

    gNavigateMode = true;
//    debugger
}
//--------------
// exit
function exit(fromUnload) {

    try {
        SGWorld.Window.ShowControls(gNavigationControls);
        SGWorld.Window.SetInputMode(0);
        SGWorld.Command.Execute(1049, 0);
        SGWorld.Command.Execute(1066, 53.0);
        if (!gOrigCollision && gCollisionChecked)
            Collision(0);
        if (gXRayMode != 0)
            SGWorld.SetParam(8338, 0);
        FOV(0);

        SGWorld.Window.RemovePopupByCaption(SGLang.i18n("Locations"));
        SGWorld.Window.RemovePopupByCaption(SGLang.i18n("ToolName"));
        SGWorld.Navigate.JumpTo(gHomePosition);
    }
    catch (e) { }
}
//--------------
// onLButtonDown
function onLButtonDown() {
    if (!gSelectMode)
        return;
    gHomePosition = SGWorld.Navigate.GetPosition();
    var cameraPosition = gHomePosition.Copy();
    var mouseInfo = SGWorld.Window.GetMouseInfo();
    var CursorInfo = SGWorld.Window.PixelToWorld(mouseInfo.X, mouseInfo.Y, 1 + 8192);
    if (CursorInfo.Type == 1 || CursorInfo.Type == 8192 ) {
        var distance = cameraPosition.DistanceTo(CursorInfo.Position);
        gNewPos = cameraPosition.MoveToward(CursorInfo.Position, distance + 1);
        gMovementSteps = 0;
        gMoveToSides = false;
        Reset(false, false);
        startNavigate();
        if (gCollisionChecked)
            SGWorld.Command.Execute(1140, 0);
    }

}
//--------------
// moveTo
function moveTo(yaw, pitch, moveDistance, crossDistance, spaceDistance) {
    if (gCollisionChecked && gNewPos==null)
        SGWorld.Command.Execute(1140, 0);

    var CameraPosition = SGWorld.Navigate.GetPosition(3);
    var newPoint = CameraPosition.Move(moveDistance, CameraPosition.Yaw + yaw, pitch);
    var SurfaceDistance = SGWorld.Navigate.DetectCollisionToTarget(newPoint);
    if (SurfaceDistance > 0) {
        if (SurfaceDistance < crossDistance)
            gNewPos = CameraPosition.MoveToward(newPoint, SurfaceDistance + spaceDistance);
        else
            gNewPos = CameraPosition.MoveToward(newPoint, SurfaceDistance - spaceDistance);
    }
    else
        gNewPos = CameraPosition.MoveToward(newPoint, moveDistance);
    gNewPos = gNewPos;
    gMovementSteps = 0;
    if (pitch == 0)
        gMoveToSides = true;
    else
        gMoveToSides = false;

}
//------------
//move
function move() {
    if (!gNavigateMode)
        return;

    clearTimeout(gMovementTimeout);

    if (gNewPos != null) {
        gMovementSteps++;
        var CameraPosition = SGWorld.Navigate.GetPosition(3);
        var nextPos = CameraPosition.Lerp(gNewPos, 0.2);
        nextPos.Yaw = CameraPosition.Yaw;
        nextPos.Pitch = CameraPosition.Pitch;
        SGWorld.Navigate.SetPosition(nextPos);
        if (gMoveToSides)
            AttachToFloor(true);
        if (nextPos.DistanceTo(gNewPos) < 0.5 || gMovementSteps > 35) {
            gNewPos = null;
            gMovementSteps = 0;
            if (gCollisionChecked)
                SGWorld.Command.Execute(1140, 1);
        }
    }
    else
        AttachToFloor(false);

    gMovementTimeout = setTimeout("move()", 20);

}
//--------------
// AttachToFloor
function AttachToFloor(fromMove) {
    var moveFactor = (fromMove)?0.8:0.4;

    var CameraPosition = SGWorld.Navigate.GetPosition(3);
    var DownPoint = CameraPosition.Move(20, 0, -90);
    var floorDistance = SGWorld.Navigate.DetectCollisionToTarget(DownPoint);

    if (floorDistance > 0) {
        CameraPosition.Altitude = CameraPosition.Altitude - (floorDistance - 2) * moveFactor;
        SGWorld.Navigate.SetPosition(CameraPosition);
        if (fromMove)
            gNewPos.Altitude = CameraPosition.Altitude;
        }
}


//--------------
// SlideOn
function SlideOn(direction) {
    gSlideMoved = false;
    gSlideDirection = direction;

    var CameraPosition = SGWorld.Navigate.GetPosition(3);
    var newPoint = CameraPosition.Move(1.5, CameraPosition.Yaw + gSlideDirection, 0);
    var SurfaceDistance = SGWorld.Navigate.DetectCollisionToTarget(newPoint);
    if (SurfaceDistance > 0) {
        newPoint.Yaw = CameraPosition.Yaw;
        newPoint.Pitch = CameraPosition.Pitch;
        SGWorld.Navigate.JumpTo(newPoint);
    }

    gSlideTimer = setTimeout("Slide()", 300);

}
//--------------
// SlideOff
function SlideOff(force) {
    clearTimeout(gSlideTimer);
    if (!gSlideMoved && !force)
        moveTo(gSlideDirection, 0, 2.5, 1.5, 1);

}

//--------------
// Slide
function Slide() {
    clearTimeout(gSlideTimer);
    gSlideMoved = true;
    var CameraPosition = SGWorld.Navigate.GetPosition(3);
    var CameraPosition1 = CameraPosition.Move(0.4, CameraPosition.Yaw + gSlideDirection, 0);
    CameraPosition1.Yaw = CameraPosition.Yaw;
    CameraPosition1.Pitch = CameraPosition.Pitch;
    SGWorld.Navigate.SetPosition(CameraPosition1);
    gSlideTimer = setTimeout("Slide()", 40);
}
//--------------
// turnOn
function turnOn(direction, dblClick) {
    gTurnTimer = setTimeout("turn()", 1);
    gTurnDirection = direction;
    gTurnDblClick = dblClick;
//            clickCounter++;
//            $("#debug").html("" + clickCounter);

}
//--------------
// turnOff
function turnOff() {
    clearTimeout(gTurnTimer);
    gTurnDblClick = false;
}
//--------------
// turn
function turn() {
    clearTimeout(gTurnTimer);

    var CameraPosition = SGWorld.Navigate.GetPosition(3);
    CameraPosition.Yaw += gTurnDirection*4;
    SGWorld.Navigate.SetPosition(CameraPosition);

    if (!gTurnDblClick)
        gTurnTimer = setTimeout("turn()", 40);
}
//--------------
// Collision
function Collision(force) {

    CheckCollision();
    if (force==1 && gCollisionChecked)
        return;

    if (gCollisionChecked ) {
        SGWorld.Command.Execute(1140, 0);
        $("#CollisionID").removeClass("CollisionOn");
        gCollisionChecked = false;
    }
    else {
        SGWorld.Command.Execute(1140, 1);
        $("#CollisionID").addClass("CollisionOn");
        gCollisionChecked = true;
    }
}
//--------------
// CheckCollision
function CheckCollision() {
    clearTimeout(gCollisionTimeout);

    if (gNewPos == null) // do not change collision during flight
    {
        if (SGWorld.Command.IsChecked(1140, 0)) {
            $("#CollisionID").addClass("CollisionOn");
            gCollisionChecked = true;
        }
        else {
            $("#CollisionID").removeClass("CollisionOn");
            gCollisionChecked = false;
        }
    }
    gCollisionTimeout = setTimeout("CheckCollision()", 100);
    return gCollisionChecked;
}
//--------------
// FOV
function FOV(force) {

    $("#FovID").removeClass("FOVOn");
    $("#FovID").removeClass("FOVOn2");
    if (force != -1)
        gFovMode = force;
    else
        gFovMode = (gFovMode +1)%3;

    if (gFovMode == 0) {
        SGWorld.Command.Execute(1066, 53.0);
    }
    else if (gFovMode == 1) {
        $("#FovID").addClass("FOVOn");
        SGWorld.Command.Execute(1066, 90.0);
        }
    else if (gFovMode == 2) {
        $("#FovID").addClass("FOVOn2");
        SGWorld.Command.Execute(1066, 120.0);
    }
}
//--------------
// XRay
function XRay() {
    $("#XRayID").removeClass("XRayOn");

    if (gXRayMode == 0) {
        // Turn XRay off
        gXRayMode = 1;
        $("#XRayID").addClass("XRayOn");
        SGWorld.SetParam(8338, 1);
    }
    else {
        gXRayMode = 0;
        SGWorld.SetParam(8338, 0);
    }
}
//--------------
// ShowLocations
function ShowLocations() {

//    try {
//        gLocationsPopup = SGWorld.Window.GetPopupByCaption(SGLang.i18n("Locations"));
//    }
//    catch (e) { gLocationsPopup = null; }

//    try {

//       if (gLocationsPopup == null) {
            var URL = "/Locations.html";
            if (gLocationFolder != "")
                URL += "?building=" + gLocationFolder;

            gLocationsPopup = SGWorld.Creator.CreatePopupMessage(SGLang.i18n("Locations"), abspath() + URL, gPopup.Left, gPopup.Top+100, 200, 400, -1);
            //gLocationsPopup.Flags = 4;
            //gLocationsPopup.Align = "Left";
            gLocationFolder = "";
            SGWorld.Window.ShowPopup(gLocationsPopup);
//       }
//       else {
//           SGWorld.Window.RemovePopupByCaption(SGLang.i18n("Locations"));
//       }
//    }
//    catch (e) { }

}

//--------------
// onRButtonUp
function onRButtonUp() {
    if (!gSelectMode)
        return;
    exit(false);
}

//------------
//OnInputModeChanged
function OnInputModeChanged (newMode) {
    Reset(0, 1);
}
//------------
//OnSGWorldMessage
function OnSGWorldMessage(MessageID, SourceID) {
    if (SourceID == "MessageBarText" && MessageID.indexOf("$$Indoor$$") == 0) {
        if (MessageID.substring(10) != "") 
            gLocationFolder = MessageID.substring(10);
        else
            gLocationFolder = "";
        return true;
    }
    else
        return false;
}

</script>

</body>
</html>


<!--Sig:00000040LRiQJLkrtpS.gCFV.SZmWKCp2zNguP0g9e0IHyZow2nkKXq9AXqSZV.1Lq85euavGETHfrPnThpDdPDlKkVwX1JJ-->
