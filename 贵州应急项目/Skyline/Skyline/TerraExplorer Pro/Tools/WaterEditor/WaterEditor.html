<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>ToolTitle</title>
    <meta http-equiv="X-UA-Compatible" content="IE=9" />
	<link href="css/cupertino/jquery-ui-1.10.4.custom.css" rel="stylesheet"/>
	<script src="js/jquery-1.10.2.js" type="text/javascript" ></script>
	<script src="js/jquery-ui-1.10.4.custom.js" type="text/javascript" ></script>
    <link href="jquery-ui-Override.css" rel="stylesheet">    
    <script language="javascript" src="ToolsCommon-NoJQ.js" type="text/javascript" ></script>
    <script type="text/javascript" src="jscolor/jscolor.js"></script>
    <link rel="StyleSheet" href="Style.css" type="text/css">
<!--    <style> //TODO: check why this is causing steps affect between buttons (also happens in other tools but less noticable
        .MenuButton
        {
            height: 78px;
            width: 65px;
            margin: 5px;
            white-space: normal;
        }
        .MenuButtonHighlight
        {
            color: Red;
            font-weight: bold;
        }

        .style1
        {
            height: 37px;
        }

    </style>-->
 </head>
<body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" style="border: 0;    overflow: auto; background-color: #ffffff" id="Body" onload="Init()" onunload="Reset(0,0)" >
<!--oncontextmenu="return false;"  onclick="bHide=true;HideOptionsNow()" > -->
       <!--<table border="0" width="100%" cellspacing="0" cellpadding="2">
        <tr>
            <td id="TopAreaTD" height="50px" width="100%" valign="middle" style="background-color: #CAD8E2">
                <table border="0" width="100%" cellspacing="0" cellpadding="0">
                    <tr>
                        <td width="12px"></td>
                        <td width="55px"><img src="WaterEditor.ico" align="absmiddle" /></td>
                        <td id="TitleTD" align="center" class="s12b  i18n">ToolName</td>
                        <td valign="top" align="right" id="CloseHelpTd"></td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr height="1px">
            <td style="background-repeat: repeat-x;" background="Images/separator.gif">
            </td>
        </tr>
        <tr>
            <td>
                <br />
            </td>
        </tr>
    </table>-->
    <!--Was in place of ** in the above id="CloseHelpTd">**</td> : <img src="../CommonImg/help.gif" border="0" class="i18n" alt="help" title="help" onclick="DisplayHelpPopup6 (SGLang.i18nFile('help.html'),SGLang.i18n('help'))" style="cursor: pointer;">-->
    <table border="0" cellspacing="1" cellpadding="3" class="s8" width="100%">
    
            <!-- Opacity -->
           <tr class='TableOtherLine'> 
            <td class="s8b i18n">
                <span id="Span7" class="i18n">Text7</span>
            </td>
               <td align="left" class="style1">
                   <table cellpadding="0" cellspacing="0" border="0">
                       <tr>
                           <td align="left" style="height: 30px;">
                               <div id="OpacitySlider" style="width: 200px;">
                               </div>
                               &nbsp;&nbsp;
                           </td>
                           <td align="right" style="height: 30px; width: 30px;">
                               <span id="OpacitySpan" style="display: inline">70</span>
                           </td>
                           <td align="right" style="height: 30px;width: 30px">
                           <input id="OpacityChk" type="checkbox" style="width:20px;" onclick="UpdateWaterPolygon();" checked>
                           </td>
                       </tr>
                   </table>
               </td>
           </tr>  
           
            <!-- Bump Scale -->
           <tr class="s8b "> 
            <td class="s8b i18n">
                <span id="Span1" class="i18n">Text8</span>
            </td>
               <td align="left" class="style1">
                   <table cellpadding="0" cellspacing="0" border="0">
                       <tr>
                           <td align="left" style="height: 30px;">
                               <div id="BumpScaleSlider" style="width: 200px;">
                               </div>
                               &nbsp;&nbsp;
                           </td>
                           <td align="right" style="height: 30px; width: 30px;">
                               <span id="BumpScaleSpan" style="display: inline">40</span>
                           </td>
                           <td align="right" style="height: 30px;width: 30px">
                           <!--<input id="BumpScaleChk" type="checkbox" style="width:20px;" onclick="UpdateWaterPolygon();" checked>-->
                           </td>
                       </tr>
                   </table>
               </td>
           </tr>    

        <!-- TexRept  -->
        <tr class='TableOtherLine' >
            <td class="s8b i18n">
                <span id="Span2" class="i18n">Text9</span>
            </td>
            <td align="left">
                <table cellpadding="0" cellspacing="0" border="0">
                    <tr>
                        <td>
                            <span class="i18n">Text24</span>
                        </td>
                        <td align="center">
                            <span id="TexReptXSpan" style="display:inline">32</span>
                        </td>
                        <td>
                            <span class="i18n">Text25</span>
                        </td>
                        <td align="center">
                            <span id="TexReptYSpan" style="display:inline">16</span>
                        </td>
                    <tr>
                        <td colspan=2 style="height:25px; width:120px;">
                            <div id="TexReptXSlider" style="display: compact; width:70px; "></div>
                        </td>
                        <td colspan=2 style="height:25px; width:120px;">
                            <div id="TexReptYSlider" style="display: compact; width:70px;"></div>
                        </td>
                        <td align="right" style="height: 30px;width: 30px">
                            <input id="TexReptChk" type="checkbox" style="width:20px;" onclick="UpdateWaterPolygon();" checked>
                        </td>
                    </tr>
        </tr>
                </table>
            </td>
        </tr>

        <!-- BumpSpeed  -->
        <tr class="s8b "> 
            <td class="s8b i18n">
                <span id="Span3" class="i18n">Text12</span>
            </td>
            <td align="left">
                <table cellpadding="0"  cellspacing="0" border="0">
                <tr>
                    <td>
                        <span class="i18n">Text10</span>
                    </td>
                    <td align="center">                                
                            <!--<span id="BumpSpeedXSpan" style="display:inline">0.25</span>-->
                            <span id="BumpSpeedSpan" style="display:inline">1</span>
                    </td>
                    <td>
                    <span class="i18n">Text11</span> 
                    </td>
                    <td align="center">
                            <!--<span id="BumpSpeedYSpan" style="display:inline">0</span>-->
                            <span id="BumpSpeedAngleSpan" style="display:inline">0</span>
                    </td>
                <tr>
                    <td colspan=2 style="height:25px; width:120px;">
                           <!--<div id="BumpSpeedXSlider" style="display: compact; width:70px; "></div>-->
                           <div id="BumpSpeedSlider" style="display: compact; width:70px; "></div>
                    </td>
                    <td colspan=2 style="height:25px; width:120px;">
                        <!--<div id="BumpSpeedYSlider" style="display: compact; width:70px;"></div>-->
                        <div id="BumpSpeedAngleSlider" style="display: compact; width:70px;"></div>
                    </td>
                    <td align="right" style="height: 30px;width: 30px">
                        <input id="BumpSpeedChk" type="checkbox" style="width:20px;" onclick="UpdateWaterPolygon();" checked>
                    </td>
                </tr>
                </tr>
                </table>
            </td>
        </tr>

 
        <!-- FresnelBias & FresnelExp -->
    <tr class='TableOtherLine'>
        <td class="s8b i18n">
            <span id="Span4" class="i18n">Text13</span>
        </td>
        <td align="left">
            <table cellpadding="0" cellspacing="0" border="0">
                <tr>
                    <td>
                        <span class="i18n">Text14</span>
                    </td>
                    <td align="center">
                        <span id="FresnelBiasSpan" style="display:inline">0.1</span>
                    </td>
                    <td>
                        <span class="i18n">Text15</span>
                    </td>
                    <td align="center">
                        <span id="FresnelExpSpan" style="display:inline">4</span>
                    </td>
                    <span class="i18n"></span>
                    <td align="left" style="height: 30px;width: 40px"></td>
                <tr>
                    <td colspan=2 style="height:25px; width:120px;">
                        <div id="FresnelBiasSlider" style="display: compact; width:70px; "></div>
                    </td>
                    <td colspan=2 style="height:25px; width:120px;">
                        <div id="FresnelExpSlider" style="display: compact; width:70px;"></div>
                    </td>
                    <td align="left" style="height: 30px;width: 40px">
                        <!--<input id="Checkbox1" type="checkbox" style="width:20px;" onclick="UpdateWaterPolygon();" checked>-->
                    </td>
                </tr>
    </tr>
                </table>
            </td>
        </tr>

        <!-- HDRMultiplier -->
           <tr class="s8b "> 
            <td class="s8b i18n">
                <span id="Span5" class="i18n">Text16</span>
            </td>
               <td align="left" class="style1">
                   <table cellpadding="0" cellspacing="0" border="0">
                       <tr>
                           <td align="left" style="height: 30px;">
                               <div id="HDRMultiplierSlider" style="width: 200px;">
                               </div>
                               &nbsp;&nbsp;
                           </td>
                           <td align="right" style="height: 30px; width: 30px;">
                               <span id="HDRMultiplierSpan" style="display: inline">0.1</span>
                           </td>
                           <td align="right" style="height: 30px;width: 30px">
                           <!--<input id="HDRMultiplierChk" type="checkbox" style="width:20px;" onclick="UpdateWaterPolygon();" checked>-->
                           </td>
                       </tr>
                   </table>
               </td>
           </tr>    

        <!-- DeepColor -->
    <tr class='TableOtherLine'>
        <td class="s8b i18n">
            <span id="Span6" class="i18n">Text17</span>
        </td>
        <td align="left" class="style1">
            <table cellpadding="0" cellspacing="0" border="0">
                <tr>
                    <td align="left" style="height: 30px;">
                        <input id="DeepColorPicker" class="color {onImmediateChange:'UpdateWaterPolygon();',pickerFaceColor:'transparent',pickerFace:3,pickerBorder:0,pickerInsetColor:'black'}" value="ff0000">
                    </td>
                    <td align="right" colspan="3" style="height: 30px; width: 30px;"></td>
                    <td align="right" style="height: 30px; width: 30px;"></td>
                    <td align="right" style="height: 30px; width: 30px;"></td>
                    <td align="right" style="height: 30px;width: 30px">
                        <input id="DeepColorChk" type="checkbox" style="width:20px;" onclick="UpdateWaterPolygon();" checked>
                    </td>
                </tr>

            </table>
        </td>
    </tr>
           
            <!-- ShallowColor -->
           <tr class="s8b "> 
            <td class="s8b i18n">
                <span id="Span8" class="i18n">Text18</span>
            </td>
               <td align="left" class="style1">
                   <table cellpadding="0" cellspacing="0" border="0">
                        <tr>
                           <td align="left" style="height: 30px;">
                                <input id="ShallowColorPicker" class="color {onImmediateChange:'UpdateWaterPolygon();',pickerFaceColor:'transparent',pickerFace:3,pickerBorder:0,pickerInsetColor:'black'}" value="00ff00">
                           </td>
                            <td align="right" colspan="3" style="height: 30px; width: 30px;">
                           </td>
                            <td align="right" style="height: 30px; width: 30px;">
                           </td>
                            <td align="right" style="height: 30px; width: 30px;">
                           </td>
                           <td align="right" style="height: 30px;width: 30px">
                           <input id="ShallowColorChk" type="checkbox" style="width:20px;" onclick="UpdateWaterPolygon();" checked>
                           </td>
                       </tr>

                   </table>
               </td>
           </tr>      
            <!-- ReflTint -->
    <tr class='TableOtherLine'>
        <td class="s8b i18n">
            <span id="Span9" class="i18n">Text19</span>
        </td>
        <td align="left" class="style1">
            <table cellpadding="0" cellspacing="0" border="0">
                <tr>
                    <td align="left" style="height: 30px;">
                        <input id="ReflTintPicker" class="color {onImmediateChange:'UpdateWaterPolygon();',pickerFaceColor:'transparent',pickerFace:3,pickerBorder:0,pickerInsetColor:'black'}" value="0000ff">
                    </td>
                    <td align="right" colspan="3" style="height: 30px; width: 30px;"></td>
                    <td align="right" style="height: 30px; width: 30px;"></td>
                    <td align="right" style="height: 30px; width: 30px;"></td>
                    <td align="right" style="height: 30px;width: 30px">
                        <input id="ReflTintChk" type="checkbox" style="width:20px;" onclick="UpdateWaterPolygon();" checked>
                    </td>
                </tr>

            </table>
        </td>
    </tr>      

            <!-- Kr -->
           <tr class="s8b "> 
            <td class="s8b i18n">
                <span id="Span10" class="i18n">Text20</span>
            </td>
               <td align="left" class="style1">
                   <table cellpadding="0" cellspacing="0" border="0">
                       <tr>
                           <td align="left" style="height: 30px;">
                               <div id="KrSlider" style="width: 200px;">
                               </div>
                               &nbsp;&nbsp;
                           </td>
                           <td align="right" style="height: 30px; width: 30px;">
                               <span id="KrSpan" style="display: inline">1</span>
                           </td>
                           <td align="right" style="height: 30px;width: 30px">
                           <!--<input id="KrChk" type="checkbox" style="width:20px;" onclick="UpdateWaterPolygon();" checked>-->
                           </td>
                       </tr>
                   </table>
               </td>
           </tr>    

            <!-- KWater -->
    <tr class='TableOtherLine'>
        <td class="s8b i18n">
            <span id="Span11" class="i18n">Text21</span>
        </td>
        <td align="left" class="style1">
            <table cellpadding="0" cellspacing="0" border="0">
                <tr>
                    <td align="left" style="height: 30px;">
                        <div id="KWaterSlider" style="width: 200px;">
                        </div>
                        &nbsp;&nbsp;
                    </td>
                    <td align="right" style="height: 30px; width: 30px;">
                        <span id="KWaterSpan" style="display: inline">1</span>
                    </td>
                    <td align="right" style="height: 30px;width: 30px">
                        <!--<input id="KWaterChk" type="checkbox" style="width:20px;" onclick="UpdateWaterPolygon();" checked>-->
                    </td>
                </tr>
            </table>
        </td>
    </tr>    
 
           <!-- UseLight -->
           <tr class="s8b "> 
            <td class="s8b i18n">
                <span id="Span12" class="i18n">Text26</span>
            </td>
               <td align="left" class="style1">
               <input id="UseLightChk" type="checkbox" style="width:20px;" onclick="UpdateWaterPolygon();" onchange ="UpdateWaterPolygon();" checked>
               </td>
           </tr>  

    <tr id="buttonsRow">
        <td colspan="2" valign="top" class="s8b i18n" align="center">

            <button id="groupButton" class="MenuButton" onclick="AddFinishObject()"><img src="images/AddObject.gif" /><br /> <span id="startstopSpan" class="i18n">Text1</span></button>
            <button id="editButton" class="MenuButton" onclick="EditExisting(null)"><img src="images/AddObject.gif" /><br /> <span id="existingStartstopSpan" class="i18n">Text3</span></button>
        </td>
    </tr>

    </table>
	 <object id="SGWorld" classid="CLSID:3a4f9197-65a8-11d5-85c1-0001023952c1">    </object>


<script language="JavaScript">
function DetectTEMode() {
        var vMode = document.documentMode;
        var rMode = 'IE5 Quirks Mode';
        if (vMode == 8) {
            rMode = 'IE8 Standards Mode';
        } else if (vMode == 7) {
            rMode = 'IE7 Strict Mode';
        } else if (vMode == 9) {
            rMode = 'IE9 Strict Mode';
        }
        //alert('Rendering in: ' + rMode);
    }
    DetectTEMode();

var inEdit = false;
var inLoad = false;
var gWaterPolygon = null;


//--------------
// EditExisting
function EditExisting(ObjectID) {
    if (inEdit)
        Reset(false, false);
    else LoadExistingObject(ObjectID);
}


//--------------
// LoadExistingObject
function LoadExistingObject(ObjectID) {
    var selectedItemID;

    if (ObjectID == null)
        selectedItemID = SGWorld.ProjectTree.GetNextItem("", 10);
    else
        selectedItemID = ObjectID;

	if (selectedItemID == "") {
		alert(SGLang.i18n("Text4"));
		return;
	}
	gWaterPolygon = SGWorld.ProjectTree.GetObject(selectedItemID);
	try{
		var effectString = gWaterPolygon.FillStyle.Texture.FileName;
	}
	catch (err) {
		alert(SGLang.i18n("Text5"));
		Reset(false, false);
		return;
	}
	   
	if (!effectString || effectString.indexOf("$$WATER$$") != 0) {
		alert(SGLang.i18n("Text5"));
		Reset(false, false);
		return;
	}
	inEdit = true;
	$("#existingStartstopSpan").text(SGLang.i18n("Text2"));

	inLoad = true;
	effectString = effectString.slice(9);    
	$('input[type=checkbox]').each(function () {
		$(this).prop('checked', false);
	});

	var bumpSpeedX = null;
	var arr = effectString.split('|');
	$.each(arr, function (key, pair) {
	    var parts = pair.split(':');
	    switch (parts[0]) {
	        case "Opacity":
	            $("#OpacitySlider").slider("value", parseFloat(parts[1]) * 100);
	            $("#OpacityChk").prop('checked', true)
	            break;
	        case "BumpScale":
	            $("#BumpScaleSlider").slider("value", parseFloat(parts[1]) * 100);
	            //$("#BumpScaleChk").prop('checked', true)
	            break;
	        case "TexReptX":
	            $("#TexReptXSlider").slider("value", Math.log(parseFloat(parts[1])) / Math.log(2));
	            $("#TexReptChk").prop('checked', true)
	            break;
	        case "TexReptY":
	            $("#TexReptYSlider").slider("value", Math.log(parseFloat(parts[1])) / Math.log(2));
	            $("#TexReptChk").prop('checked', true)
	            break;
	        //            case "BumpSpeedX":                        
	        //                $("#BumpSpeedXSlider").slider("value", parseFloat(parts[1]) * 4);                        
	        //                $("#BumpSpeedChk").prop('checked', true)                        
	        //                break;                        
	        case "BumpSpeedX":
	            bumpSpeedX = parseFloat(parts[1]);
	            break;
	        //            case "BumpSpeedY":                     
	        //                $("#BumpSpeedYSlider").slider("value", parseFloat(parts[1]) * 4);                     
	        //                $("#BumpSpeedChk").prop('checked', true)                     
	        //                break;                     
	        case "BumpSpeedY":
	            if (bumpSpeedX == null) {
	                alert(SGLang.i18n("Text22"));
	                break;
	            }
	            //debugger;
	            var bumpSpeedY = parseFloat(parts[1]);
	            var speed;
	            var angle;
	            if (bumpSpeedX == 0) {
	                if (bumpSpeedY == 0) {
	                    speed = 0;
	                    angle = 0;
	                }
	                else {
	                    speed = Math.abs(bumpSpeedY);
	                    angle = (bumpSpeedY >= 0) ? 0 : 180;
	                }
	            }
	            else {
	                if (bumpSpeedY == 0) {
	                    speed = Math.abs(bumpSpeedX);
	                    angle = (bumpSpeedX >= 0) ? 90 : 270;
	                }
	                else {
	                    speed = Math.sqrt(Math.pow(bumpSpeedX, 2) + Math.pow(bumpSpeedY, 2));
	                    angle = Math.atan2(bumpSpeedX, bumpSpeedY) / (Math.PI / 180);
	                    if (angle < 0) angle = 180 + (180 + angle);
	                }
	            }

	            $("#BumpSpeedAngleSlider").slider("value", angle);
	            $("#BumpSpeedSlider").slider("value", speed);
	            $("#BumpSpeedChk").prop('checked', true)
	            break;
	        case "FresnelBias":
	            $("#FresnelBiasSlider").slider("value", parseFloat(parts[1]) * 10);
	            break;
	        case "FresnelExp":
	            $("#FresnelExpSlider").slider("value", parseFloat(parts[1]) * 10);
	            break;
	        case "HDRMultiplier":
	            $("#HDRMultiplierSlider").slider("value", parseFloat(parts[1]) * 10);
	            //$("#HDRMultiplierChk").prop('checked', true)
	            break;
	        case "DeepColor":
	            document.getElementById('DeepColorPicker').color.fromString(ReverseColor(parts[1]));
	            $("#DeepColorChk").prop('checked', true);
	            break;
	        case "ShallowColor":
	            document.getElementById('ShallowColorPicker').color.fromString(ReverseColor(parts[1]));
	            $("#ShallowColorChk").prop('checked', true);
	            break;
	        case "ReflTint":
	            document.getElementById('ReflTintPicker').color.fromString(ReverseColor(parts[1]));
	            $("#ReflTintChk").prop('checked', true);
	            break;
	        case "Kr":
	            $("#KrSlider").slider("value", parseFloat(parts[1]) * 10);
	            //$("#HDRMultiplierChk").prop('checked', true)
	            break;
	        case "KWater":
	            $("#KWaterSlider").slider("value", parseFloat(parts[1]) * 10);
	            //$("#HDRMultiplierChk").prop('checked', true)
	            break;
	        case "UseLight":
	            $("#UseLightChk").prop('checked', (parts[1] == "1") ? true : false).change();
	            break;



	    }
	});
    inLoad = false;
}

//--------------
// Init
function Init() {
    rootId = GetParamValue("rootId", SGWorld.ProjectTree.RootID);
    groupID = -1;

    Reset(true, false);

    // Opacity
    $("#OpacitySlider").slider({
        value: 70,
        min: 0,
        max: 100,
        slide: function (event, ui) {
            $("#OpacitySpan").html(ui.value);
            UpdateWaterPolygon();
        },
        change: function (event, ui) {
            $("#OpacitySpan").html(ui.value);
            UpdateWaterPolygon();
        }
    });
    // BumpScale
    $("#BumpScaleSlider").slider({
        value: 40,
        min: 0,
        max: 100,
        slide: function (event, ui) {
            $("#BumpScaleSpan").html(ui.value);
            UpdateWaterPolygon();
        },
        change: function (event, ui) {
            $("#BumpScaleSpan").html(ui.value);
            UpdateWaterPolygon();
        }
    });
    // TexReptX
    $("#TexReptXSlider").slider({
        value: 5,
        min: 0,
        max: 10,
        slide: function (event, ui) {
            $("#TexReptXSpan").html(Math.pow(2,ui.value));
            UpdateWaterPolygon();
        },
        change: function (event, ui) {
            $("#TexReptXSpan").html(Math.pow(2, ui.value));
            UpdateWaterPolygon();
        }
    });
    // TexReptY
    $("#TexReptYSlider").slider({
        value: 4,
        min: 0,
        max: 10,
        slide: function (event, ui) {
            $("#TexReptYSpan").html(Math.pow(2, ui.value));
            UpdateWaterPolygon();
        },
        change: function (event, ui) {
            $("#TexReptYSpan").html(Math.pow(2, ui.value));
            UpdateWaterPolygon();
        }
    });
    // BumpSpeedX
//    $("#BumpSpeedXSlider").slider({
//        value: 1,
//        min: -8,
//        max: 8,
//        slide: function (event, ui) {
//            $("#BumpSpeedXSpan").html(ui.value/4);
//            UpdateWaterPolygon();
//        },
//        change: function (event, ui) {
//            $("#BumpSpeedXSpan").html(ui.value/4);
//            UpdateWaterPolygon();
//        }
//    });
    // BumpSpeed
    $("#BumpSpeedSlider").slider({
        value: 1,
        min: 0,
        max: 20,
        slide: function (event, ui) {
            $("#BumpSpeedSpan").html(ui.value);
            UpdateWaterPolygon();
        },
        change: function (event, ui) {
            $("#BumpSpeedSpan").html(ui.value);
            UpdateWaterPolygon();
        }
    });    
    
    // BumpSpeedY
//    $("#BumpSpeedYSlider").slider({
//        value: 0,
//        min: -8,
//        max: 8,
//        slide: function (event, ui) {
//            $("#BumpSpeedYSpan").html(ui.value/4);
//            UpdateWaterPolygon();
//        },
//        change: function (event, ui) {
//            $("#BumpSpeedYSpan").html(ui.value/4);
//            UpdateWaterPolygon();
//        }
    //    });
    // BumpSpeedAngle
    $("#BumpSpeedAngleSlider").slider({
        value: 0,
        min: 0,
        max: 360,
        slide: function (event, ui) {
            var newValue = ui.value;
            if (ui.value % 90 < 5) newValue = (Math.floor(ui.value / 90)) * 90; // ui.value = (Math.floor(ui.value / 90)) * 90;
            if (ui.value % 90 > 85) newValue = (Math.floor(ui.value / 90) + 1) * 90; // ui.value = (Math.floor(ui.value / 90) + 1) * 90;
            $("#BumpSpeedAngleSpan").html(newValue);
            $(this).slider("value", newValue);
            UpdateWaterPolygon();
        },
        change: function (event, ui) {
            var newValue = ui.value;
            if (!inLoad) {                
                if (ui.value % 90 < 5) newValue = (Math.floor(ui.value / 90)) * 90; // ui.value = (Math.floor(ui.value / 90)) * 90;
                if (ui.value % 90 > 85) newValue = (Math.floor(ui.value / 90) + 1) * 90; // ui.value = (Math.floor(ui.value / 90) + 1) * 90;
                $(this).slider("value", newValue);
            }
            $("#BumpSpeedAngleSpan").html(newValue);
            UpdateWaterPolygon();
        }
    });

    // FresnelBias
    $("#FresnelBiasSlider").slider({
        value: 1,
        min: 0,
        max: 40,
        slide: function (event, ui) {
            $("#FresnelBiasSpan").html(ui.value/10);
            UpdateWaterPolygon();
        },
        change: function (event, ui) {
            $("#FresnelBiasSpan").html(ui.value/10);
            UpdateWaterPolygon();
        }
    });
    // FresnelExp
    $("#FresnelExpSlider").slider({
        value: 40,
        min: 0,
        max: 40,
        slide: function (event, ui) {
            $("#FresnelExpSpan").html(ui.value/10);
            UpdateWaterPolygon();
        },
        change: function (event, ui) {
            $("#FresnelExpSpan").html(ui.value/10);
            UpdateWaterPolygon();
        }
    });
    // HDRMultiplier
    $("#HDRMultiplierSlider").slider({
        value: 1,
        min: 0,
        max: 1000,
        slide: function (event, ui) {
            $("#HDRMultiplierSpan").html(ui.value/10);
            UpdateWaterPolygon();
        },
        change: function (event, ui) {
            $("#HDRMultiplierSpan").html(ui.value/10);
            UpdateWaterPolygon();
        }
    });
    // Kr
    $("#KrSlider").slider({
        value: 10,
        min: 0,
        max: 40,
        slide: function (event, ui) {
            $("#KrSpan").html(ui.value/10);
            UpdateWaterPolygon();
        },
        change: function (event, ui) {
            $("#KrSpan").html(ui.value/10);
            UpdateWaterPolygon();
        }
    });
    // KWater
    $("#KWaterSlider").slider({
        value: 10,
        min: 0,
        max: 40,
        slide: function (event, ui) {
            $("#KWaterSpan").html(ui.value/10);
            UpdateWaterPolygon();
        },
        change: function (event, ui) {
            $("#KWaterSpan").html(ui.value/10);
            UpdateWaterPolygon();
        }
    });

    objectID = GetParamValue("ObjectID", "");
    if (objectID != "") {
        document.getElementById("buttonsRow").style.display = "none";
        EditExisting(objectID);
    }

}

//------------------
// Reset
//------------------
function Reset(FirstTime, FromMouseInputMode) {
    try {
        inEdit = false;
        gWaterPolygon = null;

        $("#startstopSpan").text(SGLang.i18n("Text1"));
        $("#existingStartstopSpan").text(SGLang.i18n("Text3"));

        if (FirstTime != 1 && FromMouseInputMode == 0) {
            //        alert("input");
            //SGWorld.Window.SetInputMode(0);
        }
    }
    catch (err) { isStart = false; }
}

//--------------------
// AddFinishObject
function AddFinishObject() {
    if (inEdit)
        Reset(false, false);
    else AddNewObject();
}

//--------------------
// AddNewObject
function AddNewObject() {
    inEdit = true;
    $("#startstopSpan").text(SGLang.i18n("Text2"));

    //Create polygon
    var centerPos = SGWorld.Window.CenterPixelToWorld(-1).Position;
    var polyGeometry = SGWorld.Creator.GeometryCreator.CreatePointGeometry("Point ZM(" + centerPos.X + " " + centerPos.Y + " " + centerPos.Altitude + ")").SpatialOperator.buffer(SGWorld.Navigate.GetPosition().Altitude / 2);

    var blackColor = SGWorld.Creator.CreateColor(0,0,0,255);
    gWaterPolygon = SGWorld.Creator.CreatePolygon(polyGeometry, blackColor, blackColor, 1, "", "Polygon");
    gWaterPolygon.Position.Altitude += 100;

    UpdateWaterPolygon();

}

//-------------
//UpdateWaterPolygon
function UpdateWaterPolygon() {

    if (!inEdit)
        return;
    
    var effectString;


    effectString = "$$WATER$$";
    if ($("#OpacityChk").prop('checked')) effectString += "Opacity:" + $("#OpacitySlider").slider("value") / 100 + "|";
    effectString += "BumpScale:" + $("#BumpScaleSlider").slider("value") / 100 + "|";

    if ($("#TexReptChk").prop('checked')) effectString += "TexReptX:" + Math.pow(2, $("#TexReptXSlider").slider("value")) + "|" + "TexReptY:" + Math.pow(2, $("#TexReptYSlider").slider("value")) + "|";
    //if ($("#BumpSpeedChk").prop('checked')) effectString += "BumpSpeedX:" + $("#BumpSpeedXSlider").slider("value") / 4 + "|" + "BumpSpeedY:" + $("#BumpSpeedYSlider").slider("value") / 4 + "|";
    //if ($("#BumpSpeedChk").prop('checked')) effectString += "BumpSpeedX:" + Math.cos($("#BumpSpeedAngleSlider").slider("value") * (Math.PI / 180)) * $("#BumpSpeedSlider").slider("value") + "|" + "BumpSpeedY:" + Math.sin($("#BumpSpeedAngleSlider").slider("value") * (Math.PI / 180)) * $("#BumpSpeedSlider").slider("value") + "|";
    if ($("#BumpSpeedChk").prop('checked')) {
        var bumpSpeedX = Math.sin($("#BumpSpeedAngleSlider").slider("value") * (Math.PI / 180)).toFixed(15) * $("#BumpSpeedSlider").slider("value");
        var bumpSpeedY = Math.cos($("#BumpSpeedAngleSlider").slider("value") * (Math.PI / 180)).toFixed(15) * $("#BumpSpeedSlider").slider("value");
        effectString += "BumpSpeedX:" + bumpSpeedX + "|" + "BumpSpeedY:" + bumpSpeedY + "|";
    }
    effectString += "FresnelBias:" + $("#FresnelBiasSlider").slider("value")/10 + "|" + "FresnelExp:" + $("#FresnelExpSlider").slider("value")/10 + "|";
    effectString += "HDRMultiplier:" + $("#HDRMultiplierSlider").slider("value") / 10 + "|";
    if ($("#DeepColorChk").prop('checked')) effectString += "DeepColor:" + ReverseColor(document.getElementById('DeepColorPicker').color.toString()) + "|"
    if ($("#ShallowColorChk").prop('checked')) effectString += "ShallowColor:" + ReverseColor(document.getElementById('ShallowColorPicker').color.toString()) + "|"
    if ($("#ReflTintChk").prop('checked')) effectString += "ReflTint:" + ReverseColor(document.getElementById('ReflTintPicker').color.toString()) + "|"
    effectString += "Kr:" + $("#KrSlider").slider("value") / 10 + "|";
    effectString += "KWater:" + $("#KWaterSlider").slider("value") / 10 + "|";
    effectString += "UseLight:" + ($("#UseLightChk").prop('checked')?"1":"0") + "|";
    
    

    gWaterPolygon.FillStyle.Texture.FileName = effectString;

}

//-------------
//ReverseColor
function ReverseColor(color) {
    var c = hexToRgb(color);
    return rgbToHex(c.b, c.g, c.r);

}

function hexToRgb(hex) {
    // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
    var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
    hex = hex.replace(shorthandRegex, function(m, r, g, b) {
        return r + r + g + g + b + b;
    });

    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}

function rgbToHex(r, g, b) {
    return ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
}

</script>


</body>
</html>


<!--Sig:00000040FBjQGy239BC3ZniP9HiDsXnqklnoXLr9jRH.mPDaMcDG4fS1fi7hm.bYUQfR1Qoi2xZftrDuIVV5C2FqraB3GuJJ-->
