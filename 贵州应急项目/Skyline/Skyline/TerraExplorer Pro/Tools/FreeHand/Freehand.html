<HTML>
<HEAD></HEAD>

<body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" style="border:0;overflow:auto;" id="Body" onload = "Init()"><!-- OnLoad="Init()"> <!-- onclick="bHide=true;HideOptionsNow()"><!--onunload="Exit()"--> 

<object ID="TE" CLASSID="CLSID:3a4f9191-65a8-11d5-85c1-0001023952c1" onerror="TEError" style="visibility:hidden;height:0 "></object>
<object id="sgworld" classid="CLSID:3a4f9197-65a8-11d5-85c1-0001023952c1" style="visibility:hidden;height:0"></object>
</body>

<!--<script language="javascript" src="../ToolsCommon.js"></script>-->
<SCRIPT Language="JavaScript">


</SCRIPT>
<SCRIPT Language="JavaScript">
var ITerraExplorer = null;
var IPlane = null;
var IInformationTree = null;
var IObjectManager = null;
var IRender = null;
var ITerrain = null;
var ICoordSys = null;
var ISnapShot = null;
var IContainer = null;
var IScriptEngine = null;

var NewObject = true;
var ContentWindow = null;
var DrawMode = 0;
var IObject;

var FGColorButton;
var InEdit=0;
var InEditEx=0;
var bImageFiledInFocus=false;
var ResetDone = false;
var cursorLoc;

//--------------------------------------
// Init
//--------------------------------------
function Init()
{
    
    ITerraExplorer = TE.interface("ITerraExplorer5");
    IPlane = TE.interface("IPlane3");
    IInformationTree = TE.interface("IInformationTree5");
    IObjectManager = TE.interface("IObjectManager5");
    IRender = TE.interface("IRender5");
    ITerrain = TE.interface("ITerrain3");
    ICoordSys = TE.interface("ICoordSys3");
    IContainer = TE.interface("IContainer2");
    IScriptEngine = TE.interface("IScriptEngine5");

    IObject = null;
    DrawMode = 0;
    InEdit=0;
    bImageFiledInFocus=false;
   
    LastX = null;
    LastY = null;

    Oper = "6,0";  
    sep = Oper.indexOf(",");
    operation = Oper.substr (0,sep);
    StartDrawing(2); 
    //ContentCreator(operation);

    
}

//-------------
// StartDrawing
//-------------
function StartDrawing(mode)
{

IRender.SetMouseInputMode (1);
a = ITerraExplorer.GetParam (1000);
ITerraExplorer.SetParam (1000,a|0x20);
IRender.SetMouseCursor (abspath()+"/cursor_m.cur");
DrawMode = mode;

}
//-----------------------
//  OnInputModeChanged
//-----------------------
function TE::OnInputModeChanged(NewMode)
{
    if(NewMode == 0) CloseTool("Freehand");
    //else sgworld.Window.ShowMessageBarText(NewMode, 1, 300);

   
}
function CloseTool(toolName) {
    sgworld.Window.RemovePopupByCaption(toolName);     
}
//-------------------
// OnLButtonDown
//-------------------
function TE::OnLButtonDown (Flags, X, Y, bHandled)
{

    if (DrawMode == 0 || InEdit == 1)
        return;
    GetPlaneStatus();
    GetCenterView();
    if ( GetCursorLocation (X , Y,true) == 0)
        return;
    InEditEx = 1;

   PenElevation = sgworld.Window.PixelToWorld(X, Y, -1);
   

    if (DrawMode == 2)  // free drawing
    {
        if (IObject == null)
        {
         
            IObject = IObjectManager.CreatePolyline (0, 65535, 3, 0,"");

            IObject.AddVertex (PenElevation.Position.X, PenElevation.Position.Altitude+0.1, PenElevation.Position.Y);
            IObject.ExistInBasicTree = true;
            IObject.Distance = CurrCenterDistance;
            IObject.ClientDataEx("ContentCreator") = "1";
            LastX = CurrCursorX;
            LastY = CurrCursorY;
            
        }
    }

    InEditEx = 0;
}
//-------------------
// OnLButtonUp
//-------------------
function TE::OnLButtonUp (Flags, X, Y, bHandled)
{
   
    if (DrawMode == 2 && InEdit != 1)
    {
        if (IObject.NumOfVertices < 2){ 
            IObject.KeepAliveOnRelease = 0;
            sgworld.ProjectTree.deleteItem(IObject.ID);
            IObject = null;
            IRender.SetMouseInputMode (0);
            }
 
        InEditEx = 1;
        
        try{
        InEdit = 1;
        InEditEx = 0;
        }
        catch( e){
        alert(e.Message);
        }

        if(IObject != null) sgworld.ProjectTree.EditItem(IObject.ID, 0);
    }
    CloseTool("FreeHand");
}
//-----------------------
// OnRButtonUp
//-----------------------
function TE::OnRButtonUp (Flags, X, Y, bHandled)
{
    sgworld.Window.SetInputMode(0);
    CloseTool("FreeHand");

}
var counter = 0;
//-------------------
// OnFrame
//-------------------
function TE::OnFrame ()
{
    if (DrawMode == 0)        
        return;
        
    if (DrawMode == 2 && IObject != null && InEdit==0)  //drawing
    {
        if (GetCursorLocation (-1 , -1, true) == 0)
            return;
        if (CurrCursorX != LastX && CurrCursorY != LastY )
        {
            counter ++;
            if (counter%2 == 0)
            {
                mouse = sgworld.Window.GetMouseInfo();
                PenElevation = sgworld.Window.PixelToWorld(mouse.X, mouse.Y, 1+4+16+64+128+8192);
                if(PenElevation.ObjectID == IObject.ID) return;
                if(PenElevation.Type == 4 ){
                    if(PenElevation.ObjectID == "") return;
                    var obj = sgworld.Creator.GetObject(PenElevation.ObjectID);
                    if(obj.ObjectType == 33) {
                        FeatureLayer = sgworld.ProjectTree.GetLayer(obj.ParentGroupID);
                        if(FeatureLayer.GeometryType == 0) return;
                        if(FeatureLayer.GeometryType == 1 && FeatureLayer.FeatureGroups.Polyline.GetProperty("GroundObject") == 0) return;
                        if(FeatureLayer.GeometryType == 2 && FeatureLayer.FeatureGroups.Polygon.GetProperty("GroundObject") == 0) return;
                    }

                }
                
                IObject.AddVertex (PenElevation.Position.X,PenElevation.Position.Altitude+0.1 ,PenElevation.Position.Y);
                
                
            }
            LastX = CurrCursorX;
            LastY = CurrCursorY;
            
        }
    }

}


//----------------------
// abspath
//----------------------
function abspath()
{
    var abspath = unescape(window.location.pathname);

    if(abspath.substring(0,1) == "/")
        abspath = abspath.substring(1,abspath.length)

    for (var i=abspath.length-1; i>=0; i--)
    {
      if (abspath.substring(i,i+1) == "/" || abspath.substring(i,i+1) == "\\")
      {
         abspath = abspath.substring(0,i);
         break;
      }
    }

    return(abspath);

}

</script>

<SCRIPT LANGUAGE="VBScript">

dim CurrPlaneX, CurrPlaneY,CurrPlaneH, CurrPlaneYaw,CurrPlanePitch, CurrPlaneRoll,CurrCameraDeltaYaw, CurrCameraDeltaPitch, PlaneGroundH
dim CurrCenterX, CurrCenterY, CurrCenterH, CurrCenterGroundH, CurrCenterDistance
dim CurrCursorX,CurrCursorH,CurrCursorY,CurrCursorDistance,CursorObjType,CursorObjectID
dim ScreenLeft, ScreenTop, ScreenWidth, ScreenHeight

dim bHide
dim iOptGroupID

'--------------------------------------
' GetPlaneStatus
'--------------------------------------
Sub GetPlaneStatus ()
    IPlane.GetPosition CurrPlaneX, CurrPlaneY,CurrPlaneH, CurrPlaneYaw,CurrPlanePitch, CurrPlaneRoll,CurrCameraDeltaYaw, CurrCameraDeltaPitch
    PlaneGroundH = ITerrain.GetGroundHeight (CurrPlaneX, CurrPlaneY, 0)

End Sub
'--------------------------------------
' GetRenderRect
'--------------------------------------
function GetRenderRect ()
    IRender.GetRenderRect ScreenLeft, ScreenTop, ScreenWidth, ScreenHeight
End Function
'--------------------------------------
' GetCenterView
'--------------------------------------
function GetCenterView ()
    IRender.GetRenderRect ScreenLeft, ScreenTop, ScreenWidth, ScreenHeight
    ObjType = 31
    ObjectID = 0

    IRender.ScreenToWorld ScreenWidth/2 , ScreenHeight/2 , ObjType , WX,WH,WY, ObjectID
    If ObjType <> 32 Then	'If we dont hit the sky
        CurrCenterX = WX
        CurrCenterY = WY
        CurrCenterH = WH
        CurrCenterGroundH = ITerrain.GetGroundHeight (CurrCenterX, CurrCenterY, 0)

        CurrCenterDistance = ICoordSys.GetDistanceEx (CurrCenterX, CurrCenterY,CurrCenterGroundH, CurrPlaneX, CurrPlaneY,CurrPlaneH+PlaneGroundH)
    
        GetCenterView =  1
    else
        GetCenterView = 0
    end if
End Function

'--------------------------------------
' GetCursorLocation
'--------------------------------------
function GetCursorLocation (X,Y,TerrainOnly)
    
    CursorObjType = 63
    CursorObjectID = 0
    GetCursorLocation = 1

    If X =-1 and y=-1 Then
        IRender.GetMouseInfo Flags, X, Y
        IRender.GetRenderRect ScreenLeft, ScreenTop, ScreenWidth, ScreenHeight

        If X < 0 Or X >= ScreenWidth or Y < 0 or Y >= ScreenHeight Then	
            GetCursorLocation = 0
            exit function
        End If

    End If


    If TerrainOnly = true then
        IRender.ScreenToTerrain X,Y, CurrCursorX,CurrCursorY,CurrCursorH
    Else
        IRender.ScreenToWorld X , Y , CursorObjType , CurrCursorX,CurrCursorH,CurrCursorY, CursorObjectID
    End If
    If CursorObjType = 32 OR (CurrCursorX=0 AND CurrCursorY=0)Then  GetCursorLocation = 0

    CurrCursorDistance = ICoordSys.GetDistanceEx (CurrCursorX, CurrCursorY,CurrCursorH, CurrPlaneX, CurrPlaneY,CurrPlaneH+PlaneGroundH)

End function

</script>

</HTML>


<!--Sig:00000040HpzAjpCJLPc3g0#gDnaC7xADV8n.EXtl.sPbFtWp8jwz0cY4o1NtNiqoPihGBh2.CSR19hnzvoN3JUwUcq5dGiJJ-->


<!--Sig:000000407mxrO6x3Fm4tlsGXsGCHank2vPYaXoC.tHebwiNcF3Io91YI9E4ehe2dPDCGhANDgICN69CntLrL#1pwVuZRJDJJ-->


<!--Sig:00000040YHys#786R28YAUmiF2aQFOyIMTIdIJYgovZKr#EF1T2SNNJNQ1hg1yKR6oAfLarFWlXSSUxItVVRWcatJA6jMDJJ-->


<!--Sig:00000040#oeH.SWuoggsyalXr9HL8MC5y9Rthw.UlevKxKbBbT41jPcJjU24YbCe9xfvKR3Ma.JbyLcmhwnkbIgJNddJGQJJ-->


<!--Sig:00000040YNpBUSvlFKDmPaQlLe.UcZw3zgEPKl8Dg5Hjy9DSu5EtfCANlZ60p9oK46evNhNTLUO17ifkk.Cn7UO#XnnqJUJJ-->
