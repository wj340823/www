
<!DOCTYPE HTML>
<html>
<head>
  <title>Timeline | Interactive example</title>
    <meta http-equiv="X-UA-Compatible" content="IE=9" />

  <link href="../vis.css" rel="stylesheet" type="text/css" />
<!--  <link href="../Style.css" rel="stylesheet" type="text/css" />-->
    <link rel="stylesheet" type="text/css" media="all" href="./jscalendar/skins/aqua/theme.css"
        title="Aqua" />

<style type="text/css">
    .vis.timeline.root {border: 2px solid black;font-family:  arial;font-size: 10px;background: #ffffff; color: #000000}
    .vis.timeline .item {border:1px solid #303D66; font-size: 10pt;color: #000000; box-shadow: 3px 3px 20px rgba(0,0,0, 0.5);}
    .vis.timeline .item,.vis.timeline .item.line {border-width: 1px;}
    .vis.timeline .item.dot {border:10px solid red;}
    .vis.timeline .item.selected {border-color: #303D66;background-color: #F2FF61; color: #000000;}
    .vis.timeline .timeaxis .text {color: black;padding-top: 10px;padding-left: 10px;}
    .vis.timeline .timeaxis .text.major {font-weight: bold;}
    .vis.timeline .timeaxis .grid.minor {border-width: 1px;border-color: #555555;}
    .vis.timeline .timeaxis .grid.major {border-width: 1px;border-color: #555555;}
    .vis.timeline .customtime{background-color:#8FDCFA;width:3px;cursor:pointer;z-index:1; border:1px solid black;}
    .vis.timeline .customtime1{background-color:#E8D961;width:3px;cursor:w-resize;z-index:1;height:100%; border:1px solid black; }
    .vis.timeline .item .delete {  background: url('img/timeline/delete.png') no-repeat top center;}

.MenuButton{height: 78px;width: 65px;margin: 3px;white-space: normal; background-color:#535353;border:0px; border-right:1px solid #76757A;font-family:  Arial; font-size: 9pt;  color:white; line-height:120%}
.MenuButton img {margin-bottom: 5px; }
.MenuButton:hover{background-color:#76757A; }

    .s7 {font-size: 9px;}
    .s8 {font-family:  Arial; font-size: 11px; font-style: normal; font-weight: normal; color: #000000; text-decoration: none;}
    .s10b {font-family:  Arial; font-size: 16px; font-style: normal; font-weight: bold; color: #000000; text-decoration: none;}
    .buttonGray {background-color:#7F8082; border:0px solid black; color:White; height:25px; cursor:pointer}
    Select {width:150px;font-family:  Arial, Helvetica, sans-serif; font-size: 11px; font-style: normal; font-weight: normal; color: #000000; text-decoration: none;}    
    INPUT[type=text] {width:140px;font-family:  Arial, Helvetica, sans-serif; font-size: 11px; font-style: normal; font-weight: normal; color: #000000; text-decoration: none;}
    .TableOtherLine{background-color:rgb(229,233,247);height:5px; }    
    html { height:100%;}
  </style>  
  
</head>
<body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" style="border: 0;overflow:hidden; height:100%;"  id="Body" onload="Init()" oncontextmenu="return false;" >
<div id="GraphDiv" style="width:100%; height:100%; "  >
    <div id="graphBar" style=" height:40px;  ">
        <table style="display:inline-table;" cellpadding="0" cellspacing="0" border="0px">
        <tr>
        <td rowspan="2">
        <img src="img/ZoomIn.png" style="cursor:pointer;" onclick="zoom(-0.2);" align="absmiddle" />
        <img src="img/ZoomOut.png" style="cursor:pointer;" onclick="zoom(0.2);" align="absmiddle" />
<!--        <img src="img/Zoomall.png" style="cursor:pointer;" onclick="zoomall();" align="absmiddle" />-->
        <span style="margin-left:50px;"></span>
        <button class="buttonGray" onclick="showDiv(1);"><span class="i18n">Text18</span></button>
        <button class="buttonGray" onclick="SelectGroupObjects(2);"><span class="i18n">Text21</span></button>
        <span style="margin-left:50px;"></span>
        </td>
        <td rowspan="2" style="width:42px;"><img id="playID" src="img/Play.png" style="cursor:pointer;" onclick="PlayStop();" align="absmiddle" /></td>
        <td rowspan="2"><input type="text" id="speed" value="5" style="width:25px;height:20px;font-weight:bold;" readonly /></td>
        <td  style="width:20px;"><img src="img/up.png" onclick="setSpeed(1);" style="margin:0;padding:0; cursor:pointer;" ></td>
        <td rowspan="2" valign="middle"> <span class="i18n">Text30</span> </td>
        </tr>
        <tr>
        <td><img src="img/down.png" onclick="setSpeed(-1);" style="margin:0;padding:0; cursor:pointer;" ></td>
        </tr>
        </table>
        
    </div>
    <div id="visualization"></div>
    <span style="position:fixed;left:0px;bottom:0px" class="s8">vis.js (C) 2014 Almende B.V. <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_blank">License</a>.</span>
</div>

<div id="popupDiv" style="padding:10px; " >
<span class="i18n s10b" style="margin:20px;">Text29</span> 
<table>
        <tr class="s8">
            <td colspan="2">
                <table border="1" cellspacing="0" cellpadding="5" bgcolor="#ffffff" class="s8">
                        <tr class='TableOtherLine'>
                        <td align="top" class="s8b i18n">Text15</td>
                        <td align="left">                            
                            &nbsp;<select id="Method" size="1"  style="z-index: 1;">
                                <option value="0" class="i18n" selected="selected">Text16</option>
                                <option value="1" class="i18n" >Text17</option>
                            </select>
                        </td>
                    </tr>                             
                     <tr class="s8">
                        <td align="top" class="s8b i18n">                            Text1                        </td>
                        <td align="left">                            &nbsp;
                            <input type="text" name="date" id="start_date_c" readonly="1" />
                            <img alt="start" src="./jscalendar/img.gif" id="start_trigger_c" style="cursor: pointer; border: 0px;" title="Start Date and Time" onmouseover="this.style.background='red';" onmouseout="this.style.background=''" />
                        </td>
                    </tr>
                    <tr class='TableOtherLine'>
                        <td align="top" class="s8b i18n">
                            Text2
                        </td>
                        <td align="left">
                            &nbsp;
                            <input type="text" name="date" id="end_date_c" readonly="1" />
                            <img alt="End" src="./jscalendar/img.gif" id="end_trigger_c" style="cursor: pointer; border: 0px;" title="End Date and Time" onmouseover="this.style.background='red';" onmouseout="this.style.background=''" />
                        </td>
                    </tr>
                    <tr class="s8">
                        <td align="top" class="s8b i18n">Text11</td>
                        <td align="left">                            
                            &nbsp;<select id="handleSubGroups" size="1"  style="z-index: 1;">
                                <option value="0" class="i18n" selected="selected">Text12</option>
                                <option value="1" class="i18n" >Text13</option>
                            </select>
                        </td>
                    </tr>                    
                    <tr class='TableOtherLine'>
                        <td align="top" class="s8b i18n">Text26</td>
                        <td align="left">                            
                            &nbsp;<select id="ApplyTo" size="1"  style="z-index: 1;">
                                <option value="0" class="i18n" selected="selected">Text27</option>
                                <option value="1" class="i18n" >Text28</option>
                            </select>
                        </td>
                    </tr>                    
                </table>
            </td>
        </tr>
        <tr class="s8">
            <td colspan="2">
                <button id="groupButton" class="MenuButton" onclick="SelectGroupObjects(1)"> <img src="../commonImg/group.png" /><br /> <span class="i18n">Text5</span></button>
<!--                <button id="cleanButton" class="MenuButton" onclick="SelectGroupObjects(2)"> <img src="clean.gif" /><br /> <span class="i18n">Text8</span></button>-->
                <button id="returnToTimeline" style="display:none;" class="MenuButton" onclick="showDiv(0);"><img src="img/BackToTimeline.gif" /><br /> <span class="i18n">Text23</span></button>
            </td>
        </tr>
    </table>
</div>

<object id="SGWorld" classid="CLSID:3a4f9199-65a8-11d5-85c1-0001023952c1" style="visibility:hidden;height:0 "></object>

<script language="javascript" src="../ToolsCommon.js" type="text/javascript"></script>
<!-- import the calendar script -->

<script type="text/javascript" src="./jscalendar/calendar.js"></script>
<script type="text/javascript">
    //-------------------
    // load lang file for calendar

    (function () {
        document.write("<script language='javascript' src='./jscalendar/calendar-lang.js'></" + "script>");
        var code = SGLang.getCode();
        document.write("<script  language='javascript' src='./jscalendar/" + code + "/calendar-lang.js'></" + "script>");
    })();
    
    window.onresize = function () {
        $("#visualization").height($(window).height() - 40);
    }
</script>
<script type="text/javascript" src="./jscalendar/calendar-setup.js"></script>
<script type="text/javascript" src="../vis.js"></script>
<script language="JavaScript" type="text/javascript">

var gGroup = "";
var gStartTime;
var gEndTime;
var gNumObjects;
var gNumObjectsTime;
var gObjWithoutTime;
var gObjNoTimeWarning = false;
var deltaTime;
var gPopup;
var gPopupCaption = "";
var gClickTimer = new Date();
var gData;
var timeline = null;
var gMinDate;
var gMaxDate;
var gPlay = false;
var gPlayTimer = null;
//--------------
// Init
function Init() {
    gPopupCaption = SGLang.i18n("PopupName");
    if (document.documentMode < 9) {
        alert(SGLang.i18n("Text19"));
        exit();
        return;
    }
    //debugger
    SGWorld.AttachEvent("OnDateTimeChanged", OnDateTimeChanged);
    var ret = CheckSelection();
    if (ret == 1) {
        showDiv(0); // graph
    }
    else if (ret == 0) {
        showDiv(1); // set group
    }
    else if (ret == -1) {
        exit();
    }
    SGWorld.Window.ShowControls(SGWorld.Window.GetControls() | 64); // Turn on the time control
}
//----------------
//  exit
function exit() {
    try {
        SGWorld.Window.RemovePopupByCaption(gPopupCaption);
    } catch (e) { }
}
//----------------
//  CheckSelection 
function CheckSelection() {

    gGroup = SGWorld.ProjectTree.GetNextItem(SGWorld.ProjectTree.RootID, 10);
    if (!SGWorld.ProjectTree.IsGroup(gGroup) || gGroup == SGWorld.ProjectTree.RootID || SGWorld.ProjectTree.IsLayer(gGroup)) {
        alert(SGLang.i18n("Text69"));
        return -1;
    }

    // add the group name to the popup caption
    gPopup = SGWorld.Window.GetPopupByCaption(gPopupCaption);
    gPopupCaption = SGLang.i18n("PopupName") + " - " + SGWorld.ProjectTree.GetItemName(gGroup);
    gPopup.Caption = gPopupCaption;

    try {
        var groupStartDate = new Date(SGWorld.ProjectTree.GetGroupStartTime(gGroup))
        var minDate = new Date(0);
        if (groupStartDate.getTime() == minDate.getTime()) {
            return 0;
        }
    }
    catch (e) {return 0;    }

    return 1;
}
//-----------
// showDiv
function showDiv(div) {

    switch (div) {
        case 0: // graph
            gPopup.Width = SGWorld.Window.Rect.Width - 20;
            gPopup.Align = "BottomLeft";
            $("#popupDiv").hide();
            $("#GraphDiv").show();
            $("#visualization").height($(window).height() - 40);
            $("#returnToTimeline").show();
            BuildTimeLine(gGroup);
            break;
        case 1: // set group
            gPopup.Width = 350;
            gPopup.Align = "BottomLeft";
            $("#popupDiv").show();
            $("#GraphDiv").hide();
            break;
    }
}
//-----------
// SelectGroupObjects
function SelectGroupObjects(action) {
    if (action == 2) {
        a = confirm(SGLang.i18n("Text22"));
        if (!a)
            return;
        $("#returnToTimeline").hide();

    }
    gStartTime = Date.parseDate($("#start_date_c").val(), "%b %e, %Y %H:%M").getTime();
    gEndTime = Date.parseDate($("#end_date_c").val(), "%b %e, %Y %H:%M").getTime();

    if (action == 1 && ($("#start_date_c").val() == "" || $("#end_date_c").val() == "")) {
        alert(SGLang.i18n("Text6"));
        return;
    }
    if (action == 1 && gStartTime > gEndTime) {
        alert(SGLang.i18n("Text20"));
        return;
    }

    $(event.srcElement).addClass("MenuButtonHighlight");
    SGWorld.Window.ShowMessageBarText(SGLang.i18n("Text7"), -1);
    SGWorld.Window.ShowControls(SGWorld.Window.GetControls() | 64); // Turn on the time control
    gNumObjects = 0;
    searchLeaf(gGroup, 0, 0);
    if ($("#Method").attr("value")==1)
        deltaTime = 0;
    else
        deltaTime = (gEndTime - gStartTime) / gNumObjects;
    searchLeaf(gGroup, action, 0);

    if (action == 1)
      showDiv(0);
    else
      showDiv(1);

}
//-------------------
// searchGeometries
function searchLeaf(parentNode, action, level) {
    var node = SGWorld.ProjectTree.GetNextItem(parentNode, 11);
    if (action == 1 || action == 2)
    {
        SGWorld.ProjectTree.SetGroupStartTime(parentNode, 0);
        SGWorld.ProjectTree.SetGroupEndTime(parentNode, 0);
    }
    while (node != "") {
     
     try {

        if (!SGWorld.ProjectTree.IsLayer(node)) {
            if (SGWorld.ProjectTree.IsGroup(node)) {
                searchLeaf(node, action, level + 1);
                if (action == 1 && level == 0 && $("#handleSubGroups").attr("value") == "1")
                    gStartTime += deltaTime
                if (action == 0 && level == 0 && $("#handleSubGroups").attr("value") == "1")
                    gNumObjects++;
            }
            else {
                var Object = SGWorld.ProjectTree.GetObject(node);
                if (Object != null && ( (Object.ObjectType >0 && Object.ObjectType < 19) || (Object.ObjectType > 22 && Object.ObjectType < 33) || (Object.ObjectType > 40)) ) {
                    switch (action) {
                        case 0: // count objects
                            if (level == 0 || $("#handleSubGroups").attr("value") == "0")
                                gNumObjects++;
                            break;
                        case 1: // Set time 
                            SetTimes(Object);
                            if (level == 0 || $("#handleSubGroups").attr("value") == "0")
                                gStartTime += deltaTime
                            break;
                        case 2:  // Clean    
                            CleanTimes(Object);
                            break;
                        case 3:   // get min max times
                        case 4:   // build timeline graph
                            if (Object.TimeSpan.Start == undefined || Object.TimeSpan.End == undefined)
                                gObjWithoutTime = true;
                            else {
                                gNumObjectsTime += 1;
                                var objStartDate = new Date(Object.TimeSpan.Start);
                                if (objStartDate < gMinDate)
                                    gMinDate = objStartDate;
                                var objEndDate = new Date(Object.TimeSpan.End);
                                if (objEndDate > gMaxDate)
                                    gMaxDate = objEndDate;
                                if (action == 4)
                                    gData.push({ id: Object.ID, content: Object.TreeItem.Name, start: objStartDate.getTime(), end: objEndDate.getTime() });
                                break;
                            }
                    }
                }
            }
        }
       } // try
       catch (e) { }
       
       node = SGWorld.ProjectTree.GetNextItem(node, 13);
    }
}
//-------------
// SetTimes
function SetTimes(Object) {
    try {
        if ($("#ApplyTo").attr("value") == "1" && Object.TimeSpan.Start != undefined && Object.TimeSpan.End != undefined) // Aply to objects without time
            return;

        Object.TimeSpan.Start = gStartTime;
        if ($("#Method").attr("value") == 1)
            Object.TimeSpan.End = gEndTime ;
        else
            Object.TimeSpan.End = gStartTime + deltaTime;
    }
    catch (e) { }
}

//-------------
// CleanTimes
function CleanTimes(Object) {
    try {
        Object.TimeSpan.Start = 0;
        Object.TimeSpan.End = 0;
    }
    catch (e) { }
}
//----------------
Calendar.setup({
    inputField: "start_date_c",     // id of the input field
    ifFormat: "%b %e, %Y %H:%M",      // format of the input field
    button: "start_trigger_c",  // trigger for the calendar (button ID)
    align: "Tl",           // alignment (defaults to "Bl")
    showsTime: true,            // will display a time selector
    singleClick: true
});
Calendar.setup({
    inputField: "end_date_c",     // id of the input field
    ifFormat: "%b %e, %Y %H:%M",      // format of the input field
    button: "end_trigger_c",  // trigger for the calendar (button ID)
    align: "Tl",           // alignment (defaults to "Bl")
    showsTime: true,            // will display a time selector
    singleClick: true
});

//--------------
// BuildTimeLine
function BuildTimeLine(group) {

    gMinDate = new Date("December 31, 2999 23:59:00");
    gMaxDate = new Date("January 1, 1970 01:00:00");
    var itemID = SGWorld.ProjectTree.GetNextItem(group, 11);  // first child
    
    if (timeline != null)
        timeline.destroy();

    gData = [];
    gNumObjects = 0;
    gObjWithoutTime = false;
    gNumObjectsTime = 0;
    searchLeaf(gGroup, 4, 0);

    if (gNumObjectsTime == 0) {
        alert(SGLang.i18n("Text24"));
        showDiv(1);
        return;
    }
    if (gObjWithoutTime && !gObjNoTimeWarning) {
        alert(SGLang.i18n("Text25"));
        gObjNoTimeWarning = true;
    }
    var container = document.getElementById('visualization');
    var options = {
        start: gMinDate.getTime(),
        end: gMaxDate.getTime(),
        orientation: 'top',
        height: '100%',
        editable: true,
        showCustomTime: true,
        showCurrentTime: false,

        editable: {
            add: false,
            updateTime: true,
            updateGroup: true,
            remove: true
        },

        onMove: function (item, callback) {
            try {
                var obj = SGWorld.ProjectTree.GetObject(item.id);
                obj.TimeSpan.Start = item.start;
                obj.TimeSpan.End = item.end;
            }
            catch (err) { }
        },
        onRemove: function (item, callback) {
            try {
                var obj = SGWorld.ProjectTree.GetObject(item.id);
                obj.TimeSpan.Start = undefined;
                obj.TimeSpan.End = undefined;
                callback(item);
            }
            catch (err) { }
        }
    };

    timeline = new vis.Timeline(container, gData, options);
    OnDateTimeChanged(SGWorld.DateTime.Current);

    timeline.on('timechange', function (properties) {
        SGWorld.DateTime.Current =  Math.max (SGWorld.DateTime.TimeRangeStart, Math.min(  SGWorld.DateTime.TimeRangeEnd, properties.time));
        OnDateTimeChanged(SGWorld.DateTime.Current);
    });

    timeline.on('timechange1', function (properties) {
        var CurrTime = new Date(SGWorld.DateTime.Current);
        var BuffTime = new Date(properties.time);
        var Buff = (BuffTime.getTime() - CurrTime.getTime()) / 1000;
        var EndRange = new Date(SGWorld.DateTime.TimeRangeEnd);
        var MaxBuff = (EndRange - CurrTime)/1000;

        SGWorld.DateTime.CurrentTimeBuffer = Math.max(0, Math.min(Buff, MaxBuff));
        OnDateTimeChanged(SGWorld.DateTime.Current);

    });

    timeline.on('select', function (properties) {
        var currTime = new Date();
        if (currTime - gClickTimer < 300) {
            try { SGWorld.Navigate.FlyTo(properties.items[0]); } catch (e) { }
        }
        gClickTimer = new Date();
    });
    zoomall();

}
//---------------------
// zoom
function zoom(percentage) {
    var range = timeline.getWindow();
    var interval = range.end - range.start;

    timeline.setWindow({
        start: range.start.valueOf() - interval * percentage,
        end: range.end.valueOf() + interval * percentage
    });
}
//--------------
// zoomall - reset zoom and pan
function zoomall() {
    timeline.fit();
}
//--------------
// OnDateTimeChanged
function OnDateTimeChanged(TEtime) {
    var CurrTime = new Date(TEtime);
    var BuffTime = new Date(SGWorld.DateTime.Current + SGWorld.DateTime.CurrentTimeBuffer * 1000);
    var Buff = (BuffTime.getTime() - CurrTime.getTime()) / 1000;
    var EndRange = new Date(SGWorld.DateTime.TimeRangeEnd);
    var MaxBuff = 9999999999999; //   For now I do not limit the max buffer if the user changes the Current Time. To limit use-> (EndRange - CurrTime) / 1000;
    SGWorld.DateTime.CurrentTimeBuffer = Math.max(0, Math.min(Buff, MaxBuff));

    BuffTime = new Date(SGWorld.DateTime.Current + SGWorld.DateTime.CurrentTimeBuffer * 1000);

    if (timeline != null) {
        timeline.setCustomTime(CurrTime.getTime());

        if (SGWorld.DateTime.CurrentTimeBuffer > 0) {
            timeline.setCustomTime1(BuffTime.getTime());
            $(".vis.timeline .customtime1").css("height", "100%");
        }
        else {
            timeline.setCustomTime1(CurrTime.getTime());
            $(".vis.timeline .customtime1").css("height", "20%");
        }

    }
}
//-------------------------
// PlayStop
function PlayStop() {
    //debugger;
    gPlay = !gPlay;
    if (gPlay) {
        $("#playID").attr("src", "img/Stop.png");
        gLastTime = new Date();
        gPlayTimer = setInterval("moveTime()", 50);
    }
    else {
        $("#playID").attr("src", "img/Play.png");
        if (gPlayTimer != null) {
            clearInterval(gPlayTimer);
            gPlayTimer = null;
        }
    }
}
var gLastTime = 0;
//-------------------------
// moveTime
function moveTime() {
    var CurrTime = new Date(SGWorld.DateTime.Current);
    var StartRange = new Date(SGWorld.DateTime.TimeRangeStart);
    var EndRange = new Date(SGWorld.DateTime.TimeRangeEnd);
    var SystemTime = new Date();

    var newTime = CurrTime.getTime() + (EndRange - StartRange) / ((1000/(SystemTime - gLastTime)) * parseInt($("#speed").val()));
    if (newTime > EndRange)
        newTime = StartRange;// + newTime - EndRange;

    var newCurr = new Date(newTime);

    SGWorld.DateTime.Current = newCurr;
    gLastTime = new Date();
}
//---------
// setSpeed
function setSpeed(delta) {
    var newVal = parseInt($("#speed").val());
    newVal = Math.max(1, newVal + delta);
    $("#speed").val(newVal);
}
</script>
</body>
</html>