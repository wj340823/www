angular.module("openlayers-directive",["ngSanitize"]).directive("openlayers",["$log","$q","$compile","olHelpers","olMapDefaults","olData",function(e,t,r,o,a,n){return{restrict:"EA",transclude:!0,replace:!0,scope:{center:"=olCenter",defaults:"=olDefaults",view:"=olView",events:"=olEvents"},template:'<div class="angular-openlayers-map" ng-transclude></div>',controller:["$scope",function(e){var r=t.defer();e.getMap=function(){return r.promise},e.setMap=function(e){r.resolve(e)},this.getOpenlayersScope=function(){return e}}],link:function(e,t,r){var l=o.isDefined,i=o.createLayer,s=o.setMapEvents,c=o.setViewEvents,u=o.setClickMarker,p=o.setOverMarker,d=o.createView,g=a.setDefaults(e),m=(o.createOverlay,o.removeOverlay);l(r.width)&&(isNaN(r.width)?t.css("width",r.width):t.css("width",r.width+"px")),l(r.height)&&(isNaN(r.height)?t.css("height",r.height):t.css("height",r.height+"px")),l(r.lat)&&(g.center.lat=parseFloat(r.lat)),l(r.lon)&&(g.center.lon=parseFloat(r.lon)),l(r.zoom)&&(g.center.zoom=parseFloat(r.zoom));var f=ol.control.defaults(g.controls),y=ol.interaction.defaults(g.interactions),v=d(g.view),h=new ol.Map({target:t[0],controls:f,interactions:y,renderer:g.renderer,view:v,loadTilesWhileAnimating:g.loadTilesWhileAnimating,loadTilesWhileInteracting:g.loadTilesWhileInteracting});if(e.$on("$destroy",function(){n.resetMap(r.id)}),!r.customLayers){var w={type:"Tile",source:{type:"OSM"}},k=i(w,v.getProjection(),"default");h.addLayer(k),h.set("default",!0)}if(!l(r.olCenter)){var S=ol.proj.transform([g.center.lon,g.center.lat],g.center.projection,v.getProjection());v.setCenter(S),v.setZoom(g.center.zoom)}s(g.events,h,e),c(g.events,h,e),e.setMap(h),n.setMap(h,r.id);var b;h.on("click",function(t){var r=h.forEachFeatureAtPixel(t.pixel,function(e){return e});g.view.projection;if(r){e.$emit("openlayers.map.clickFeature",r.get("id")||"multiFeature"),m(h,null,"clickLabel");var o,a,n=r.get("featureInfo");if(n&&(o=n.type,a=n.data),r.get("features")&&(o="clusterFeature"),"marker"===o){var l=a;if(l.ngClick&&("click"===t.type||"touchend"===t.type)){var i=l.ngClick;return i.triggerHandler("click"),t.preventDefault(),void t.stopPropagation()}l.clickLabel.title&&u(r,h,l,e.$parent)}else if("clusterFeature"===o){var s=r.get("features"),c=s.length;if(1==c){var p=s[0],l=a;l.clickLabel.title&&u(p,h,l,e.$parent)}else{var d=r.get("multiFeatureEvent");if(!d||d.indexOf("over")==-1){var f=r.get("overLay");f&&f.getMap()&&f.get("overLabel")&&(f.unset("overLabel"),f.set("clickLabel","true"));var y=h.getView();b=y.on("change:resolution",function(){m(h,null,"clickLabel")})}}}}else m(h,null,"clickLabel")}),e.locateFeature=function(e,t){m(h,null,"clickLabel"),h.unByKey(b);var r=[];r=t.split(",").map(function(e){return+e});var o=h.getView(),a=+new Date,n=ol.animation.zoom({duration:1e3,resolution:o.getResolution(),start:a}),l=ol.animation.pan({duration:1e3,source:o.getCenter(),start:a});h.beforeRender(n,l),o.setCenter(r),o.setZoom(18)},h.on("pointermove",function(t){var r=h.getEventPixel(t.originalEvent),o=h.forEachFeatureAtPixel(r,function(e){return e}),a=g.view.projection;if(o){e.$emit("openlayers.map.overFeature",o.get("id")||"multiFeature"),m(h,null,"overLabel");var n,l,i=o.get("featureInfo");if(i&&(n=i.type,l=i.data),o.get("features")&&(n="clusterFeature"),"marker"===n){var s=l;s.overLabel.title&&p(o,h,s,e.$parent)}if("clusterFeature"===n){var c=o.get("features"),u=c.length;if(1==u){var d=c[0],s=l;s.overLabel.title&&p(d,h,s,e.$parent)}else{var f=o.get("multiFeatureEvent ");if(!f||f.indexOf("over")==-1){if(o.get("overLay")&&o.get("overLay").getMap()&&o.get("overLay").get("clickLabel"))return;for(var s=angular.copy(c[0].get("featureInfo").data),y="<ul class='featureList'>",v=0;v<u;v++){var w=c[v].get("id"),s=c[v].get("featureInfo").data,k=ol.proj.transform(s.coord,s.projection,a).join(",");y+="<li ng-click='locateFeature("+w+',"'+k+"\")'>"+c[v].get("id")+"</li>"}y+="</ul>",s.overLabel={classNm:"clusterOver",title:"",placement:"right",message:y,id:""},p(o,h,s,e)}}}}else m(h,null,"overLabel")})}}}]),angular.module("openlayers-directive").directive("olCenter",["$log","$location","olMapDefaults","olHelpers",function(e,t,r,o){return{restrict:"A",scope:!1,replace:!1,require:"openlayers",link:function(a,n,l,i){var s=o.safeApply,c=o.isValidCenter,u=o.isDefined,p=o.isArray,d=o.isNumber,g=o.isSameCenterOnMap,m=o.setCenter,f=o.setZoom,y=i.getOpenlayersScope();y.getMap().then(function(a){var n=r.getDefaults(y),i=a.getView(),v=y.center;if(l.olCenter.search("-")!==-1)return e.error('[AngularJS - Openlayers] The "center" variable can\'t use a "-" on his key name: "'+l.center+'".'),void m(i,n.view.projection,n.center,a);u(v)||(v={}),c(v)||(e.warn("[AngularJS - Openlayers] invalid 'center'"),v.lat=n.center.lat,v.lon=n.center.lon,v.zoom=n.center.zoom,v.projection=n.center.projection),v.projection||("pixel"!==n.view.projection?v.projection=n.center.projection:v.projection="pixel"),d(v.zoom)||(v.zoom=1),m(i,n.view.projection,v,a),i.setZoom(v.zoom);var h;if(v.centerUrlHash===!0){var w=function(){var e,r=t.search();if(u(r.c)){var o=r.c.split(":");3===o.length&&(e={lat:parseFloat(o[0]),lon:parseFloat(o[1]),zoom:parseInt(o[2],10)})}return e};h=w(),y.$on("$locationChangeSuccess",function(){var e=w();e&&!g(e,a)&&s(y,function(t){t.center.lat=e.lat,t.center.lon=e.lon,t.center.zoom=e.zoom})})}var k;y.$watchCollection("center",function(t){if(t){if(t.projection||(t.projection=n.center.projection),t.autodiscover)return k||(k=new ol.Geolocation({projection:ol.proj.get(t.projection)}),k.on("change",function(){if(t.autodiscover){var e=k.getPosition();s(y,function(t){t.center.lat=e[1],t.center.lon=e[0],t.center.zoom=12,t.center.autodiscover=!1,k.setTracking(!1)})}})),void k.setTracking(!0);c(t)||(e.warn("[AngularJS - Openlayers] invalid 'center'"),t=n.center);var r=i.getCenter();if(r)if("pixel"===n.view.projection||"pixel"===t.projection)i.setCenter(t.coord);else{var o=ol.proj.transform(r,n.view.projection,t.projection);o[1]===t.lat&&o[0]===t.lon||m(i,n.view.projection,t,a)}i.getZoom()!==t.zoom&&f(i,t.zoom,a)}});var S=a.on("moveend",function(){s(y,function(e){if(u(e.center)){var r=a.getView().getCenter();if(e.center.zoom=i.getZoom(),"pixel"===n.view.projection||"pixel"===e.center.projection)return void(e.center.coord=r);if(e.center){var l=ol.proj.transform(r,n.view.projection,e.center.projection);if(e.center.lat=l[1],e.center.lon=l[0],o.notifyCenterUrlHashChanged(y,e.center,t.search()),p(e.center.bounds)){var s=i.calculateExtent(a.getSize()),c=e.center.projection,d=n.view.projection;e.center.bounds=ol.proj.transformExtent(s,d,c)}}}})});y.$on("$destroy",function(){a.unByKey(S)})})}}}]),angular.module("openlayers-directive").directive("olCluster",["$log","$q","olMapDefaults","olHelpers",function(e,t,r,o){return{restrict:"E",scope:{points:"=points",style:"=olStyle"},require:"^openlayers",link:function(e,t,r,a){var n=o.isDefined,l=a.getOpenlayersScope(),i=o.createStyle,s=o.createFeature;l.getMap().then(function(t){var a=o.createClusterLayer(r.zindex||0);a.set("cluster",!0),t.addLayer(a);var l=r.callbackEvent,c=function(t){var r,o=t.get("features").length;if(o>1)l&&t.set("multiFeatureEvent",l),r=i(e.style),r.getText()&&r.getText().setText(o.toString());else{var a=t.get("features")[0].get("pointStyle");r=i(angular.isDefined(a)?a:e.style)}return r||(r=new ol.style.Style({image:new ol.style.Circle({radius:10,stroke:new ol.style.Stroke({color:"#fcolor"}),fill:new ol.style.Fill({color:"#3399CC"})}),text:new ol.style.Text({text:o.toString(),fill:new ol.style.Fill({color:"#fcolor"})})})),r},u=r.projection?r.projection:"EPSG:4326",p=t.getView().getProjection().getCode();e.$watch("points",function(e,t){if(e){for(var r=e.length,o=new Array,l={projection:u,label:{title:"",message:"",classNm:"",placement:"top"},coord:[0,0],lat:0,lon:0,keepOneOverlayVisible:!0,clickLabel:{},overLabel:{}},i=0;i<r;i++){var d=e[i];if(d.lon&&d.lat){var g=s({projection:u,lat:parseFloat(d.lat),lon:parseFloat(d.lon),id:d.id},p);o.push(g);var m=angular.copy(l);if(m.coord=[parseFloat(e[i].lon),parseFloat(e[i].lat)],m.lon=m.coord[0],m.lat=m.coord[1],n(d.clickLabel)){var f=d.clickLabel;f.url?$.get(f.url,function(e){m.clickLabel={id:f.id?f.id:"",title:f.title?f.title:"",message:e,classNm:f.classNm?f.classNm:"",placement:f.placement?f.placement:"top"}}):m.clickLabel={id:f.id?f.id:"",title:f.title?f.title:"",message:f.message?f.message:"",classNm:f.classNm?f.classNm:"",placement:f.placement?f.placement:"top"},m.keepOneOverlayVisible=n(f.keepOneOverlayVisible)?f.keepOneOverlayVisible:m.keepOneOverlayVisible}if(n(d.ngClick),n(d.overLabel)){var y=d.overLabel;y.url?$.get(y.url,function(e){m.overLabel={title:y.title?y.title:"",message:e,classNm:y.classNm?y.classNm:"markerOver",placement:y.placement?y.placement:"top"}}):m.overLabel={title:y.title?y.title:"",message:y.message?y.message:"",classNm:y.classNm?y.classNm:"",placement:y.placement?y.placement:"top"}}g.set("featureInfo",{type:"clusterFeature",data:m}),angular.isDefined(e[i].pointStyle)&&g.set("pointStyle",e[i].pointStyle)}}a.getSource().getSource().clear(!0),a.getSource().getSource().addFeatures(o),a.setStyle(c)}},!0),e.$on("$destroy",function(){t.removeLayer(a)})})}}}]),angular.module("openlayers-directive").directive("olControl",["$log","$q","olData","olMapDefaults","olHelpers",function(e,t,r,o,a){return{restrict:"E",scope:{properties:"=olControlProperties"},replace:!1,require:"^openlayers",link:function(e,t,r,o){var n,l,i=a.isDefined,s=o.getOpenlayersScope();s.getMap().then(function(t){var o=a.getControlClasses,s=o();if(e.$on("$destroy",function(){t.removeControl(n)}),i(e.properties)&&i(e.properties.control))n=e.properties.control,t.addControl(n);else if(r.name){if(i(e.properties)&&(l=angular.copy(e.properties),"overviewmap"==r.name)){var c=[];l.layers.forEach(function(e){c.push(new ol.layer.Tile({source:new ol.source[e.source.type]({url:e.source.url})}))}),l.layers=c}n=new s[r.name](l),t.addControl(n)}})}}}]),angular.module("openlayers-directive").directive("olInteraction",["$log","$q","olData","olMapDefaults","olHelpers",function(e,t,r,o,a){var n=function(){function e(e){return t.map(function(e){return e.map}).indexOf(e)}var t=[],r=new ol.Collection;return{getInst:function(r,o){var n=e(o);if(n===-1){var l=a.createVectorLayer();l.set("draws",!0),o.addLayer(l),t.push({map:o,drawLayer:l,instScopes:[]}),n=t.length-1}return t[n].instScopes.push(r),t[n].drawLayer},getModifyColletion:function(){return r},setModifyColletion:function(e){r=e},deregisterScope:function(r,o){var a=e(o);if(a===-1)throw Error("This map has no features");var n=t[a].instScopes,l=n.indexOf(r);if(l===-1)throw Error("Scope wan't registered");n.splice(l,1),n.length||(delete t[a].drawLayer,delete t[a])}}}();return{restrict:"E",scope:{properties:"=olInteractionProperties"},replace:!1,require:"^openlayers",link:function(e,t,r,l){var i,s=a.isDefined,c=l.getOpenlayersScope(),u=(a.createFeature,a.createOverlay,a.createVectorLayer,a.createStyle),p=o.getDefaults(c),d="",g="",m="";c.getMap().then(function(t){var o=a.getInteractionClasses,l=o();if(e.$on("$destroy",function(){d&&t.removeInteraction(d),g&&t.removeInteraction(g),t.removeInteraction(m),t.un("click",e.delItem)}),s(e.properties)&&s(e.properties.interaction));else if(r.name&&s(e.properties))switch(i=angular.copy(e.properties),r.name){case"dragZoom":switch(i.condition){case"mouseOnly":i.condition=ol.events.condition.mouseOnly;break;case"shiftKeyOnly":i.condition=ol.events.condition.shiftKeyOnly}d=new l[r.name](i),t.addInteraction(d);break;case"draw":var c=n.getInst(e,t);if(s(i.style)){var f=u(i.style);i.style=f}d=new l[r.name](i),t.addInteraction(d),d.on("drawstart",function(t){var r=t.feature;if(i.changeStyle instanceof Function){if(i.changeStyle(),i=angular.copy(e.properties),s(i.style)){var o=u(i.style);r.setStyle(o),c.getSource().addFeature(r)}}else if(i.style){var o=u(i.style);r.setStyle(o),c.getSource().addFeature(r)}else{var o=u(p.styles.feature);r.setStyle(o),c.getSource().addFeature(r)}}),d.on("drawend",function(e){if(i.modify){var r=n.getModifyColletion();""==g&&(g=new l.modify({features:r}),t.addInteraction(g));var o=e.feature;r.push(o),n.setModifyColletion(r)}i.drawFinished instanceof Function&&i.drawFinished(e.feature)});break;case"del":var y=[];e.delItem=function(e){var r=t.forEachFeatureAtPixel(e.pixel,function(e){return e});r&&r.getGeometry().getType()&&(y.push(r),r.getStyle()&&r.getStyle().getFill()&&r.getStyle().getFill().setColor("rgba(255,0,0,1)"),r.getStyle()&&r.getStyle().getStroke()&&r.getStyle().getStroke().setColor("rgba(255,0,0,1)"),r.getStyle()&&r.getStyle().getImage()&&(r.getStyle().getImage().getFill().setColor("rgba(255,0,0,1)"),r.getStyle().getImage().getStroke().setColor("rgba(255,0,0,1)"))),e.preventDefault()},m=new l.select({wrapX:!1}),t.addInteraction(m),t.on("click",e.delItem),e.$watch("properties.del",function(r,o){r&&(y.forEach(function(r){n.getInst(e,t).getSource().removeFeature(r)}),y=[],e.properties.del=!1)})}})}}}]),angular.module("openlayers-directive").directive("olLayer",["$log","$q","olMapDefaults","olHelpers",function(e,t,r,o){return{restrict:"E",scope:{properties:"=olLayerProperties",onLayerCreated:"&"},replace:!1,require:"^openlayers",link:function(e,t,a,n){var l=o.isDefined,i=o.equals,s=n.getOpenlayersScope(),c=o.createLayer,u=o.setVectorLayerEvents,p=o.detectLayerType,d=o.createStyle,g=o.isBoolean,m=o.addLayerBeforeMarkers,f=o.isNumber,y=o.insertLayer,v=o.removeLayer,h=o.addLayerToGroup,w=o.removeLayerFromGroup,k=o.getGroup;s.getMap().then(function(t){var o,n=t.getView().getProjection(),S=r.setDefaults(s),b=t.getLayers();if(e.$on("$destroy",function(){e.properties.group?w(b,o,e.properties.group):v(b,o.index),t.removeLayer(o)}),l(e.properties))e.$watch("properties",function(r,a){if(l(r.source)&&l(r.source.type)){if(!l(r.visible))return void(r.visible=!0);if(!l(r.opacity))return void(r.opacity=1);var s,L,O;if(l(o)){var x=function(e){return function(t){return t!==e}}(o);if(l(a)&&!i(r.source,a.source)){var F=o.index;O=b,L=o.get("group"),L&&(O=k(b,L).getLayers()),O.removeAt(F),o=c(r,n,e.onLayerCreated),o.set("group",L),l(o)&&(y(O,F,o),"Vector"===p(r)&&u(S.events,t,e,r.name))}(l(a)&&r.opacity!==a.opacity||x(o))&&(f(r.opacity)||f(parseFloat(r.opacity)))&&o.setOpacity(r.opacity),l(r.index)&&r.index!==o.index&&(O=b,L=o.get("group"),L&&(O=k(b,L).getLayers()),v(O,o.index),y(O,r.index,o)),l(r.group)&&r.group!==a.group&&(w(b,o,a.group),h(b,o,r.group)),(l(a)&&g(r.visible)&&r.visible!==a.visible||x(o))&&o.setVisible(r.visible),(l(r.style)&&!i(r.style,a.style)||x(o))&&(s=angular.isFunction(r.style)?r.style:d(r.style),o.setStyle&&angular.isFunction(o.setStyle)&&o.setStyle(s)),i(r.minResolution,a.minResolution)&&!x(o)||l(r.minResolution)&&o.setMinResolution(r.minResolution),i(r.maxResolution,a.maxResolution)&&!x(o)||l(r.maxResolution)&&o.setMaxResolution(r.maxResolution)}else o=c(r,n,e.onLayerCreated),l(r.group)?h(b,o,r.group):l(r.index)?y(b,r.index,o):m(b,o),"Vector"===p(r)&&u(S.events,t,e,r.name),g(r.visible)&&o.setVisible(r.visible),r.opacity&&o.setOpacity(r.opacity),angular.isArray(r.extent)&&o.setExtent(r.extent),r.style&&(s=angular.isFunction(r.style)?r.style:d(r.style),o.setStyle&&angular.isFunction(o.setStyle)&&o.setStyle(s)),r.minResolution&&o.setMinResolution(r.minResolution),r.maxResolution&&o.setMaxResolution(r.maxResolution)}},!0);else if(l(a.sourceType)&&l(a.sourceUrl)){var L={source:{url:a.sourceUrl,type:a.sourceType}};o=c(L,n,a.layerName,e.onLayerCreated),"Vector"===p(L)&&u(S.events,t,e,a.name),m(b,o)}})}}}]),angular.module("openlayers-directive").directive("olMarker",["$log","$q","olMapDefaults","olHelpers",function(e,t,r,o){var a=function(){return{id:"",projection:"EPSG:4326",lat:0,lon:0,coord:[],show:!0,showOnMouseOver:!1,showOnMouseClick:!1,keepOneOverlayVisible:!0,ngClick:!1,clickLabel:{},overLabel:{}}},n=function(){function e(e){return t.map(function(e){return e.map}).indexOf(e)}var t=[];return{getInst:function(r,a){var n=e(a);if(n===-1){var l=o.createVectorLayer();l.set("markers",!0),a.addLayer(l),t.push({map:a,markerLayer:l,instScopes:[]}),n=t.length-1}return t[n].instScopes.push(r),t[n].markerLayer},deregisterScope:function(r,o){var a=e(o);if(a===-1)throw Error("This map has no markers");var n=t[a].instScopes,l=n.indexOf(r);if(l===-1)throw Error("Scope wan't registered");n.splice(l,1),n.length||(o.removeLayer(t[a].markerLayer),delete t[a].markerLayer,delete t[a])}}}();return{restrict:"E",scope:{lat:"=lat",lon:"=lon",properties:"=olMarkerProperties",style:"=olStyle"},transclude:!0,require:"^openlayers",replace:!0,template:'<div class="popup-label marker"><div ng-bind-html="message"></div><ng-transclude></ng-transclude></div>',link:function(t,l,i,s){var c=o.isDefined,u=s.getOpenlayersScope(),p=o.createFeature,d=o.createOverlay,g=o.createStyle,m=l.find("ng-transclude").children().length>0;u.getMap().then(function(o){var s=n.getInst(t,o);s.setZIndex(2);var f,y,v,h=a(),w=r.getDefaults(u),k=o.getView().getProjection().getCode();return t.$on("$destroy",function(){s.getSource().removeFeature(v),angular.forEach(o.getOverlays(),function(e){e.getId()==t.properties.clickLabel.id&&o.removeOverlay(e)}),n.deregisterScope(t,o)}),c(t.properties)?void t.$watch("properties",function(r){if(c(v)){var a;if(a="pixel"===r.projection?r.coord:ol.proj.transform([r.lon,r.lat],h.projection,o.getView().getProjection()),!angular.equals(v.getGeometry().getCoordinates(),a)){var n=new ol.geom.Point(a);v.setGeometry(n)}if(c(r.style)){var u=g(r.style);angular.equals(v.getStyle(),u)||v.setStyle(u)}v.get("overLay")&&v.get("overLay").getMap()&&v.get("overLay").setPosition(a),h.coord=r.coord?r.coord:h.coord,h.lat=r.lat?r.lat:h.lat,h.lon=r.lon?r.lon:h.lon,c(r.style)&&(h.style=r.style)}else{if(h.id=r.id?r.id:h.id,h.projection=r.projection?r.projection:h.projection,h.coord=r.coord?r.coord:h.coord,h.lat=r.lat?r.lat:h.lat,h.lon=r.lon?r.lon:h.lon,c(r.overLabel)){var m=r.overLabel;m.url?$.get(r.overLabel.url,function(e){h.overLabel={title:m.title?m.title:"",message:e,classNm:m.classNm?m.classNm:"markerOver",placement:m.placement?m.placement:"top"}}):m.message&&(h.overLabel={title:m.title?m.title:"",message:m.message?m.message:"",classNm:m.classNm?m.classNm:"",placement:m.placement?m.placement:"top"})}if(c(r.clickLabel)){var S=r.clickLabel;S.url?$.get(S.url,function(e){h.clickLabel={id:S.id?S.id:"",title:S.title?S.title:"",message:e,classNm:S.classNm?S.classNm:"",placement:S.placement?S.placement:"top"}}):S.message&&(h.clickLabel={id:S.id?S.id:"",title:S.title?S.title:"",message:S.message?S.message:"",classNm:S.classNm?S.classNm:"",placement:S.placement?S.placement:"top"}),h.keepOneOverlayVisible=c(S.keepOneOverlayVisible)?S.keepOneOverlayVisible:h.keepOneOverlayVisible}i.hasOwnProperty("ngClick")&&(h.ngClick=l),c(r.style)?h.style=r.style:h.style=w.styles.marker,v=p(h,k),c(v)||e.error("[AngularJS - Openlayers] Received invalid data on the marker."),v.set("featureInfo",{type:"marker",data:h}),s.getSource().addFeature(v)}if(c(f)&&o.removeOverlay(f),c(r.label)){if(c(r.label)){var b=r.label;b.url?$.get(b.url,function(e){t.message=e}):b.message&&(t.message=b.message)}r.label&&r.label.show===!0&&(y="pixel"===h.projection?h.coord:ol.proj.transform([r.lon,r.lat],h.projection,k),f=d(l,y),o.addOverlay(f)),f&&r.label&&r.label.show===!1&&(o.removeOverlay(f),f=void 0),r.clickLabel&&1==r.clickLabel.remove&&angular.forEach(o.getOverlays(),function(e){e.getId()==r.clickLabel.id&&(o.removeOverlay(e),delete t.properties.clickLabel.remove)})}},!0):(h.lat=t.lat?t.lat:h.lat,h.lon=t.lon?t.lon:h.lon,h.message=i.message,h.label={title:i.title?i.title:"",message:i.message?i.message:"",classNm:i.classNm?i.classNm:"",placement:i.placement?i.placement:"top"},h.style=t.style?t.style:w.styles.marker,i.hasOwnProperty("ngClick")&&(h.ngClick=!0),v=p(h,k),c(v)||e.error("[AngularJS - Openlayers] Received invalid data on the marker."),v.set("featureInfo",{type:"marker",data:h}),s.getSource().addFeature(v),void((h.message||m)&&(t.message=i.message,y=ol.proj.transform([h.lon,h.lat],h.projection,k),f=d(l,y),o.addOverlay(f))))})}}}]),angular.module("openlayers-directive").directive("olMeasure",["$log","$q","olMapDefaults","$interval","olHelpers","$compile",function(e,t,r,o,a,n){return{restrict:"E",require:"^openlayers",scope:{type:"=type"},link:function(e,t,r,o){var l,i,s,c,u,p,d,g,m,f,y=(a.isDefined,o.getOpenlayersScope()),v=a.createOverlay,h=a.createFeature,w=e.type,k=!0,S=0,b=[];y.getMap().then(function(t){function r(e){i&&i.parentNode.removeChild(i),i=document.createElement("div"),i.className="tooltip hidden",s=v($(i)),s.set("name",e),s.setOffset([15,30]),t.addOverlay(s)}function o(e){c&&c.parentNode.removeChild(c),c=document.createElement("div"),c.className="tooltip tooltip-measure",u=v($(c)),u.set("name",e),u.setOffset([15,30]),t.addOverlay(u)}function a(e){p&&p.parentNode.removeChild(p),p=document.createElement("div"),p.className="tooltip tooltip-distance",d=v($(p)),d.set("name",e),d.setOffset([10,0]),t.addOverlay(d)}function y(e,t){var r={coords:e,style:{image:new ol.style.Circle({radius:4,fill:new ol.style.Fill({color:"white"}),stroke:new ol.style.Stroke({color:"#005699",width:2})})}},o=h(r,O);o.set("id",t),C.addFeature(o)}function L(){b=[],b.push(M),g=new ol.interaction.Draw({source:C,type:w,style:b}),t.addInteraction(g),o("measure1"),r("measure");var i;g.on("drawstart",function(e){k=!0,S++,l=e.feature;var r="measure"+S;l.set("id",r);var o=e.coordinate;f=t.on("click",function(e){var t=l.getGeometry().getLastCoordinate();"LineString"==w&&(p=null,a(r),p.innerHTML="起点",d.setPosition(t)),y(t,r)}),i=l.getGeometry().on("change",function(e){var n=e.target,l="",i="";n instanceof ol.geom.Polygon?(i=F(n),l+="<div>面积："+i+"</div><div>单击继续绘制，双击结束</div>",o=n.getLastCoordinate()):n instanceof ol.geom.LineString&&(i=x(n),l="<div>总长："+i+"</div><div>单击继续绘制，双击结束</div>",o=n.getLastCoordinate()),c.innerHTML=l,u.setPosition(o),f&&ol.Observable.unByKey(f),f=t.on("click",function(e){"LineString"==w&&(p=null,a(r),p.innerHTML=i,d.setPosition(o)),y(o,r)})})},this),g.on("drawend",function(t){k=!1;var r,s,g=l.getGeometry(),m="";if(g instanceof ol.geom.Polygon){m+="<div>面积："+F(g)+"</div>";var y=g.getInteriorPoint().getCoordinates();r=g.getCoordinates()[0],s=r.length,u.setPosition(y),u.setOffset([0,-7])}else g instanceof ol.geom.LineString&&(r=g.getCoordinates(),s=r.length,m="<div>总长："+x(g)+"</div>",r[s-1][1]>r[s-2][1]?u.setOffset([-5,-25]):u.setOffset([-5,25]));c.innerHTML=m,c.className="tooltip tooltip-static",p&&2!=p.childNodes.length&&(p=null),a(l.get("id"));var v="<i class='fa fa-close' ng-click='delObj(\""+l.get("id")+"\")'></i>",h=n(v)(e);angular.element(p).html(h),p.className="tooltip tooltip-close",d.setPosition(g.getLastCoordinate()),r[s-1][0]>r[s-2][0]?d.setOffset([10,0]):d.setOffset([-25,0]),l=null,c=null,o("measure"+(S+1)),ol.Observable.unByKey(i),ol.Observable.unByKey(f)},this)}var O=t.getView().getProjection().getCode();$("canvas").css("cursor","url(./images/measure.png),auto"),e.$on("$destroy",function(){$("canvas").css("cursor","default"),t.removeLayer(E),t.removeInteraction(g);for(var e=t.getOverlays(),r=e.getLength(),o=r-1;o>=0;o--)e.item(o).get("name")&&e.item(o).get("name").indexOf("measure")!=-1&&e.removeAt(o);ol.Observable.unByKey(m),$(t.getViewport()).off("mouseout")});var x=function(e){var t,r=Math.round(100*e.getLength())/100;return t=r>100?"<span>"+Math.round(r/1e3*100)/100+"</span> km":"<span>"+Math.round(100*r)/100+"</span> m"},F=function(e){var t,r=e.getArea();return t=r>1e4?"<span>"+Math.round(r/1e6*100)/100+"</span> km<sup>2</sup>":"<span>"+Math.round(100*r)/100+"</span> m<sup>2</sup>"},j=function(e){e.dragging||(l?$(i).addClass("hidden"):(i.innerHTML="单击确定起点",s.setPosition(e.coordinate),$(i).removeClass("hidden")))};m=t.on("pointermove",j),$(t.getViewport()).on("mouseout",function(){$(i).addClass("hidden")});var C=new ol.source.Vector,M=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(142, 77, 209, 0.3)"}),stroke:new ol.style.Stroke({color:"rgba(142, 77, 209, 0.7)",lineDash:[10,5],width:2}),image:new ol.style.Circle({radius:2,fill:new ol.style.Fill({color:"white"}),stroke:new ol.style.Stroke({color:"#005699",width:2})})}),T=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(142, 77, 209, 0.3)"}),stroke:new ol.style.Stroke({color:"#8e4dd1",width:2})}),E=new ol.layer.Vector({source:C,style:T});t.addLayer(E),e.$watch("type",function(r,o){t.removeInteraction(g),w=e.type,L()}),e.delObj=function(e){for(var r=C.getFeatures(),o=r.length,a=o-1;a>=0;a--)r[a].get("id")==e&&C.removeFeature(r[a]);for(var n=t.getOverlays(),l=n.getLength(),a=l-1;a>=0;a--)n.item(a).get("name")==e&&n.removeAt(a)}})}}}]),angular.module("openlayers-directive").directive("olOverlay",["$log","$sce","$compile","olMapDefaults","olHelpers",function(e,t,r,o,a){return{restrict:"E",scope:{coord:"=coord",label:"=label"},require:"^openlayers",link:function(e,t,r,o){var n,l=a.isDefined,i=o.getOpenlayersScope(),s=(a.createOverlay,a.setMarkerEvent);r.projection||(r.projection="EPSG:4326");var c={projection:"EPSG:4326",coord:e.coord,label:e.label};i.getMap().then(function(t){e.changeProperty=function(){l(e.coord)?n?(t.removeOverlay(n),n=s(null,t,c,e.$parent)):(r.templateurl&&$.get(r.templateurl,function(e){c.label.message=e}),n=s(null,t,c,e.$parent)):console.log("coord不存在")},e.$watch("coord",function(t,r){angular.equals(t,r)||(c.coord=e.coord,e.changeProperty())}),e.$watch("label",function(t,r){angular.equals(t,r)||(c.label=e.label,e.changeProperty())},!0),e.$on("$destroy",function(){n&&t.removeOverlay(n)})})}}}]),angular.module("openlayers-directive").directive("olPath",["$log","$q","olMapDefaults","olHelpers",function(e,t,r,o){return{restrict:"E",scope:{properties:"=olGeomProperties",style:"=olStyle"},require:"^openlayers",replace:!0,template:'<div class="popup-label path" ng-bind-html="message"></div>',link:function(e,t,a,n){var l=o.isDefined,i=o.createFeature,s=o.createOverlay,c=o.createVectorLayer,u=o.insertLayer,p=(o.removeLayer,n.getOpenlayersScope());p.getMap().then(function(o){var n=r.getDefaults(p),d=o.getView().getProjection().getCode(),g=c(a.zindex||0),m=o.getLayers();if(u(m,m.getLength(),g),e.$on("$destroy",function(){o.removeLayer(g)}),l(a.coords)){var f=a.proj||"EPSG:4326",y=JSON.parse(a.coords),v=parseFloat(a.radius)||0,h=a.type?a.type:"Polygon",w=n.styles.path;"Point"==h&&(w=n.styles.feature);var k={type:h,coords:y,radius:v,projection:f,style:e.style?e.style:w},S=i(k,d);if(g.getSource().addFeature(S),a.message){e.message=a.message;var b=S.getGeometry().getExtent(),L=s(t,b);o.addOverlay(L)}}else;})}}}]),angular.module("openlayers-directive").directive("olPlot",["$log","$q","olMapDefaults","$interval","olHelpers","$compile",function(e,t,r,o,a,n){return{restrict:"E",require:"^openlayers",scope:{activate:"&"},link:function(e,t,r,o){var n,l,i,s,c=a.createVectorLayer;olScope.getMap().then(function(t){function r(e){var t=e.feature;i.getSource().addFeature(t),l.activate(t)}e.$on("$destroy",function(){l.deactivate(),ol.Observable.unByKey(u),i.setMap(null)}),n=new P.PlotDraw(t),n.on(P.Event.PlotDrawEvent.DRAW_END,r,!1,this),l=new P.PlotEdit(t);var o=new ol.style.Stroke({color:"#FF0000",width:2}),a=new ol.style.Fill({color:"rgba(0,255,0,0.4)"});s=new ol.style.Style({fill:a,stroke:o}),i=c(),i.setStyle(s),i.setMap(t);var u=t.on("click",function(e){if(!n.isDrawing()){var r=t.forEachFeatureAtPixel(e.pixel,function(e,t){return e});r?l.activate(r):l.deactivate()}})})}}}]),angular.module("openlayers-directive").directive("olRealtrack",["$log","$q","olMapDefaults","$compile","olHelpers",function(e,t,r,o,a){return{restrict:"E",require:"^openlayers",scope:{properties:"=olRealtrackProperties",data:"=data"},transclude:!0,replace:!0,template:'<ol-path coords="trackLine.coords" ol-style="trackLine.lineStyle" type="LineString" ng-repeat="trackLine in carTrack.trackLines"></ol-path><ol-marker ol-marker-properties="carTrack.car" ng-click="carTrack.car.clickFunc()"></ol-marker></div>',link:function(e,t,o,a){var n=a.getOpenlayersScope(),l=[],i=o.projection?o.projection:"EPSG:4326";e.carTrack={car:JSON.parse(o.carProperties),trackPoints:[],trackLines:[]},n.getMap().then(function(t){var a=r.getDefaults(n);e.drawRoute=function(t){if(!(t<1||t>total-1)){var r=JSON.parse(o.lineProperties);r.style||(r.style=a.styles.path),r.coords=[[parseFloat(l[t-1].lon),parseFloat(l[t-1].lat)],[parseFloat(l[t].lon),parseFloat(l[t].lat)]],r.projection=i;var n=getGreatCircleDistance(r.coords[1][1],r.coords[1][0],r.coords[0][1],r.coords[0][0]);n>34*o.interval?r.style.stroke.lineDash=[4,10]:isDefined(r.style.stroke.lineDash)&&delete r.style.stroke.lineDash,e.carTrack.trackLines.push(r)}},e.$watch("data",function(t){l.push(data);var r=l.length;e.drawRoute(r-1),e.carTrack.car.lat=data.lat,e.carTrack.car.lon=data.lon,e.carTrack.car.projection=i},!0)})}}}]),angular.module("openlayers-directive").directive("olTrack",["$log","$q","olMapDefaults","$interval","olHelpers",function(e,t,r,o,a){return{restrict:"E",require:"^openlayers",scope:{curIndex:"=curIndex",range:"=range",showRoute:"=showRoute"},transclude:!0,replace:!0,template:'<div><ol-marker ol-marker-properties="trackPoint" ng-click="trackPoint.clickFunc()" ng-repeat="trackPoint in carTrack.trackPoints"></ol-marker><ol-path coords="{{trackLine.coords}}" ol-style="trackLine.style" type="LineString" ng-repeat="trackLine in carTrack.trackLines"></ol-path><ol-marker ol-marker-properties="carTrack.car" ng-click="carTrack.car.clickFunc()"></ol-marker><ol-path coords="{{carTrack.route.coords}}" ol-style="carTrack.route.style" type="MultiLineString" ng-if="showRoute"></ol-path></div>',link:function(e,t,o,n){var l=n.getOpenlayersScope(),i=o.isCenter,s=JSON.parse(o.points),c=s.length,u=(o.interval,o.projection?o.projection:"EPSG:4326"),p=[];e.carTrack={car:{},trackPoints:[],trackLines:[],route:{toShowLine:!1,coords:[],style:JSON.parse(o.lineProperties).style}},angular.extend(e.carTrack.car,JSON.parse(o.carProperties));for(var d=1;d<c;d++){var g=[[parseFloat(s[d-1].lon),parseFloat(s[d-1].lat)],[parseFloat(s[d].lon),parseFloat(s[d].lat)]];e.carTrack.route.coords.push(g)}l.getMap().then(function(t){var n=r.getDefaults(l),d=n.view.projection,g=a.isDefined,m=a.getGreatCircleDistance;e.$on("$destroy",function(){e.curIndex=0,e.range=[0,0],e.carTrack.trackPoints=[],e.carTrack.trackLines=[],e.carTrack.route.coords=[]}),e.drawRoute=function(t){if(!(t<1||t>c-1)&&p.indexOf(t)==-1){var r={};r.lat=s[t].lat,r.lon=s[t].lon,r.projection=u,angular.extend(r,s[t].pointProperties),e.carTrack.trackPoints.push(r);var a=JSON.parse(o.lineProperties);if(a.style||(a.style=n.styles.path),a.coords=[[parseFloat(s[t-1].lon),parseFloat(s[t-1].lat)],[parseFloat(s[t].lon),parseFloat(s[t].lat)]],a.projection=u,s[t].timestamp){var l=m(u,a.coords[1],a.coords[0]);l>34*(s[t].timestamp-s[t-1].timestamp)/1e3?a.style.stroke.lineDash=[4,10]:g(a.style.stroke.lineDash)&&delete a.style.stroke.lineDash}e.carTrack.trackLines.push(a),p.push(t)}},e.$watchCollection("range",function(t,r){for(var o=parseInt(t[0]),a=parseInt(t[1]),n=o;n<=a;n++)e.drawRoute(n)}),e.$watch("curIndex",function(r,o){if(!(r<0)){var a=e.carTrack.car.style;a.image&&a.image.icon&&a.image.icon.rotation&&(a.image.icon.rotation=s[r].direction?parseFloat(s[r].direction)/180*Math.PI:0),e.carTrack.car.lat=s[r].lat,e.carTrack.car.lon=s[r].lon,e.carTrack.car.projection=u,e.drawRoute(r);var n;n="pixel"===u?[parseFloat(s[r].lon),parseFloat(s[r].lat)]:ol.proj.transform([parseFloat(s[r].lon),parseFloat(s[r].lat)],u,d);var l=t.getView();if(i)l.setCenter(n);else{var c=t.getSize(),p=l.calculateExtent(c);ol.extent.containsCoordinate(p,n)||l.setCenter(n)}}})})}}}]),angular.module("openlayers-directive").directive("olView",["$log","$q","olData","olMapDefaults","olHelpers",function(e,t,r,o,a){return{restrict:"A",scope:!1,replace:!1,require:"openlayers",link:function(e,t,r,n){var l=n.getOpenlayersScope(),i=a.isNumber,s=a.safeApply,c=a.createView;l.getMap().then(function(e){var t=o.getDefaults(l),r=l.view;r.projection||(r.projection=t.view.projection),r.maxZoom||(r.maxZoom=t.view.maxZoom),
r.minZoom||(r.minZoom=t.view.minZoom),r.rotation||(r.rotation=t.view.rotation);var a=c(r);e.setView(a),l.$watchCollection("view",function(e){i(e.rotation)&&a.setRotation(e.rotation)});var n=a.on("change:rotation",function(){s(l,function(t){t.view.rotation=e.getView().getRotation()})});l.$on("$destroy",function(){e.unByKey(n)})})}}}]),angular.module("openlayers-directive").service("olData",["$log","$q",function(e,t){function r(t,r){var o,a;if(angular.isDefined(r))o=r;else if(1===Object.keys(t).length)for(a in t)t.hasOwnProperty(a)&&(o=a);else 0===Object.keys(t).length?o="main":e.error("[AngularJS - Openlayers] - You have more than 1 map on the DOM, you must provide the map ID to the olData.getXXX call");return o}var o={},a=function(e,t){var o=r(e,t);e[o].resolvedDefer=!0},n=function(e,o){var a,n=r(e,o);return angular.isDefined(e[n])&&e[n].resolvedDefer!==!0?a=e[n].defer:(a=t.defer(),e[n]={defer:a,resolvedDefer:!1}),a},l=function(e,t){var o,a=r(e,t);return o=angular.isDefined(e[a])&&e[a].resolvedDefer!==!1?e[a].defer:n(e,t)};this.setMap=function(e,t){var r=n(o,t);r.resolve(e),a(o,t)},this.getMap=function(e){var t=l(o,e);return t.promise},this.resetMap=function(e){angular.isDefined(o[e])&&delete o[e]}}]),angular.module("openlayers-directive").factory("olHelpers",["$q","$log","$http","$compile",function(e,t,r,o){function a(e){return e*g/180}function n(e,t,r){var t=ol.proj.transform(t,e,"EPSG:4326"),r=ol.proj.transform(r,e,"EPSG:4326"),o=t[0],n=t[1],l=r[0],i=r[1],s=a(o),c=a(l),u=s-c,p=a(n)-a(i),g=2*Math.asin(Math.sqrt(Math.pow(Math.sin(u/2),2)+Math.cos(s)*Math.cos(c)*Math.pow(Math.sin(p/2),2)));return g*=d,g=Math.round(1e4*g)/1e4}function l(e,t,r){var t=ol.proj.transform(t,e,"EPSG:4326"),r=ol.proj.transform(r,e,"EPSG:4326"),o=new ol.Sphere(6378137),a=o.haversineDistance(t,r);return a}var i=function(e){return angular.isDefined(e)},s=function(e){return angular.isDefined(e)&&null!==e},c=function(e,t,r){e.on(t,function(o){var a=o.coordinate,n=e.getView().getProjection().getCode();"pixel"===n&&(a=a.map(function(e){return parseInt(e,10)}));var l="";if("singleclick"==t)var l=e.forEachFeatureAtPixel(o.pixel,function(e){return e});l=l?l:"",r.$emit("openlayers.map."+t,{coord:a,projection:n,event:o,feature:l})})},u=function(e,t,r){e.css("display","block");var o=new ol.Overlay({id:r,position:t,element:e[0],positioning:"center-left",insertFirst:!1});return o},p=function(e,t,r){var o=e.getOverlays(),a=o.getLength();if(t||r)if(t)for(var n=a-1;n>=0;n--)o.item(n).getId()==t&&o.removeAt(n);else for(var n=a-1;n>=0;n--)o.item(n).get(r)&&o.removeAt(n);else o.clear()},d=6378137,g=Math.PI,m=function(e,t,r,o){r.keepOneOverlayVisible&&p(t,null,"clickLabel");var a=angular.copy(r);a.label=angular.copy(r.clickLabel);var n=y(e,t,a,o);o.selectedLayid=a.label.id,n.set("clickLabel","true")},f=function(e,t,r,o){p(t,null,"overLabel");var a=angular.copy(r);a.label=angular.copy(r.overLabel),a.label.classNm="featureOver "+a.label.classNm;var n=y(e,t,a,o);n.set("overLabel","true")},y=function(e,t,r,a){var n,l=t.getView().getProjection().getCode();if(n=2==r.coord.length?ol.proj.transform(r.coord,r.projection,l):ol.proj.transform([r.lon,r.lat],r.projection,l),r.label&&r.label.message){var i="<div class='popover "+r.label.placement+"' style='display:block;background-color: white;'>";i+=r.label.placement&&"top"!=r.label.placement?"<div class='arrow'></div>":"<div class='arrow' style='left:50%;'></div>",r.label.title&&(i+="<h3 class='popover-title'>"+r.label.title+"</h3>"),i+="<div class='popover-content'>"+r.label.message+"</div>";var s=$('<div class="'+r.label.classNm+'"></div>'),c=o(i)(a);angular.element(s).html(c);var p=u(s,n,r.label.id);return t.addOverlay(p),e&&e.set("overLay",p),p}},v=["Road","Aerial","AerialWithLabels","collinsBart","ordnanceSurvey"],h=function(){return{attribution:ol.control.Attribution,fullscreen:ol.control.FullScreen,mouseposition:ol.control.MousePosition,overviewmap:ol.control.OverviewMap,rotate:ol.control.Rotate,scaleline:ol.control.ScaleLine,zoom:ol.control.Zoom,zoomslider:ol.control.ZoomSlider,zoomtoextent:ol.control.ZoomToExtent}},w=function(){return{dragZoom:ol.interaction.DragZoom,draw:ol.interaction.Draw,select:ol.interaction.Select,modify:ol.interaction.Modify}},k=["osm","sat","hyb"],S=["World_Imagery","World_Street_Map","World_Topo_Map","World_Physical_Map","World_Terrain_Base","Ocean_Basemap","NatGeo_World_Map"],b={style:ol.style.Style,fill:ol.style.Fill,stroke:ol.style.Stroke,circle:ol.style.Circle,icon:ol.style.Icon,image:ol.style.Image,regularshape:ol.style.RegularShape,text:ol.style.Text},L=function(e,t){return t&&e instanceof t?e:t?new t(e):e},O=function e(t,r){var o;if(r?o=t[r]:(r="style",o=t),"style"===r&&t instanceof Function)return t;if(!(o instanceof Object))return o;var a;if("[object Object]"===Object.prototype.toString.call(o)){a={};var n=b[r];if(n&&o instanceof n)return o;Object.getOwnPropertyNames(o).forEach(function(t,l,i){var s=b[t];return n&&s&&s.prototype instanceof b[r]?(console.assert(1===i.length,"Extra parameters for "+r),a=e(o,t),L(a,s)):(a[t]=e(o,t),void("text"!==t&&"string"!=typeof a[t]&&(a[t]=L(a[t],b[t]))))})}else a=o;return L(a,b[r])},x=function(e){if(e.type)return e.type;switch(e.source.type){case"ImageWMS":return"Image";case"ImageStatic":case"ImageArcGISRest":return"Image";case"GeoJSON":case"JSONP":case"TopoJSON":case"KML":case"WKT":case"EsriJson":return"Vector";case"TileVector":return"TileVector";default:return"Tile"}},F=function(e){var r;switch(e.projection){case"pixel":if(!i(e.extent))return void t.error("[AngularJS - Openlayers] - You must provide the extent of the image if using pixel projection");r=new ol.proj.Projection({code:"pixel",units:"pixels",extent:e.extent});break;default:r=new ol.proj.get(e.projection)}return r},j=function(e){return["watercolor","terrain","toner"].indexOf(e)!==-1},C=function(e,o){var a,n,l=new ol.format.GeoJSON;switch(e.type){case"MapBox":if(!e.mapId||!e.accessToken)return void t.error("[AngularJS - Openlayers] - MapBox layer requires the map id and the access token");n="http://api.tiles.mapbox.com/v4/"+e.mapId+"/{z}/{x}/{y}.png?access_token="+e.accessToken;var s=window.devicePixelRatio;s>1&&(n=n.replace(".png","@2x.png")),a=new ol.source.XYZ({url:n,tileLoadFunction:e.tileLoadFunction,attributions:T(e),tilePixelRatio:s>1?2:1});break;case"MapBoxStudio":if(!e.mapId||!e.accessToken||!e.userId)return void t.error("[AngularJS - Openlayers] - MapBox Studio layer requires the map id, user id  and the access token");n="https://api.mapbox.com/styles/v1/"+e.userId+"/"+e.mapId+"/tiles/{z}/{x}/{y}?access_token="+e.accessToken,a=new ol.source.XYZ({url:n,tileLoadFunction:e.tileLoadFunction,attributions:T(e),tileSize:e.tileSize||[512,512]});break;case"ImageWMS":e.url&&e.params||t.error("[AngularJS - Openlayers] - ImageWMS Layer needs valid server url and params properties"),a=new ol.source.ImageWMS({url:e.url,imageLoadFunction:e.imageLoadFunction,attributions:T(e),crossOrigin:"undefined"==typeof e.crossOrigin?"anonymous":e.crossOrigin,params:M(e.params),ratio:e.ratio});break;case"TileWMS":(e.url||e.urls)&&e.params||t.error("[AngularJS - Openlayers] - TileWMS Layer needs valid url (or urls) and params properties");var c={tileLoadFunction:e.tileLoadFunction,crossOrigin:"undefined"==typeof e.crossOrigin?"anonymous":e.crossOrigin,params:M(e.params),attributions:T(e)};e.serverType&&(c.serverType=e.serverType),e.url&&(c.url=e.url),e.urls&&(c.urls=e.urls),a=new ol.source.TileWMS(c);break;case"WMTS":(e.url||e.urls)&&e.tileGrid||t.error("[AngularJS - Openlayers] - WMTS Layer needs valid url (or urls) and tileGrid properties");var u={tileLoadFunction:e.tileLoadFunction,projection:o,layer:e.layer,attributions:T(e),matrixSet:"undefined"===e.matrixSet?o:e.matrixSet,format:"undefined"===e.format?"image/jpeg":e.format,requestEncoding:"undefined"===e.requestEncoding?"KVP":e.requestEncoding,tileGrid:new ol.tilegrid.WMTS({origin:e.tileGrid.origin,resolutions:e.tileGrid.resolutions,matrixIds:e.tileGrid.matrixIds}),style:"undefined"===e.style?"normal":e.style};i(e.url)&&(u.url=e.url),i(e.urls)&&(u.urls=e.urls),a=new ol.source.WMTS(u);break;case"OSM":a=new ol.source.OSM({tileLoadFunction:e.tileLoadFunction,attributions:T(e)}),e.url&&a.setUrl(e.url);break;case"BingMaps":if(!e.key)return void t.error("[AngularJS - Openlayers] - You need an API key to show the Bing Maps.");var p={key:e.key,tileLoadFunction:e.tileLoadFunction,attributions:T(e),imagerySet:e.imagerySet?e.imagerySet:v[0],culture:e.culture};e.maxZoom&&(p.maxZoom=e.maxZoom),a=new ol.source.BingMaps(p);break;case"MapQuest":if(!e.layer||k.indexOf(e.layer)===-1)return void t.error("[AngularJS - Openlayers] - MapQuest layers needs a valid 'layer' property.");a=new ol.source.MapQuest({attributions:T(e),layer:e.layer});break;case"EsriBaseMaps":if(!e.layer||S.indexOf(e.layer)===-1)return void t.error("[AngularJS - Openlayers] - ESRI layers needs a valid 'layer' property.");var d="http://services.arcgisonline.com/ArcGIS/rest/services/",g=d+e.layer+"/MapServer/tile/{z}/{y}/{x}";a=new ol.source.XYZ({attributions:T(e),tileLoadFunction:e.tileLoadFunction,url:g});break;case"TileArcGISRest":e.url||t.error("[AngularJS - Openlayers] - TileArcGISRest Layer needs valid url"),a=new ol.source.TileArcGISRest({attributions:T(e),tileLoadFunction:e.tileLoadFunction,url:e.url});break;case"GeoJSON":if(!e.geojson&&!e.url)return void t.error("[AngularJS - Openlayers] - You need a geojson property to add a GeoJSON layer.");if(i(e.url))a=new ol.source.Vector({format:new ol.format.GeoJSON,url:e.url});else{a=new ol.source.Vector;var m,f=o;m=i(e.geojson.projection)?new ol.proj.get(e.geojson.projection):o;var y=l.readFeatures(e.geojson.object,{featureProjection:f.getCode(),dataProjection:m.getCode()});a.addFeatures(y)}break;case"EsriJson":if(!e.url)return void t.error("[AngularJS - Openlayers] - You need a esrijson property to add a EsriJSON layer.");var h=new ol.format.EsriJSON;a=new ol.source.Vector({loader:function(t,r,o){console.log(2);var n=e.url;$.ajax({url:n,dataType:"jsonp",success:function(t){if(t.error)alert(t.error.message+"\n"+t.error.details.join("\n"));else{var r=h.readFeatures(t,{featureProjection:o});r.forEach(function(t){if("random"==e.style){var r={style0:new ol.style.Style({stroke:new ol.style.Stroke({color:"#FF0000",width:2})}),style1:new ol.style.Style({stroke:new ol.style.Stroke({color:"#FFFF00",width:2})}),style2:new ol.style.Style({stroke:new ol.style.Stroke({color:"#00FF00",width:2})}),style3:new ol.style.Style({stroke:new ol.style.Stroke({color:"#FF7D00",width:2})}),style4:new ol.style.Style({stroke:new ol.style.Stroke({color:"green",width:2})})},o=Math.random();o<.1?t.setStyle(r.style0):o<.3?t.setStyle(r.style1):t.setStyle(r.style2)}}),r.length>0&&a.addFeatures(r)}}})}});break;case"WKT":if(!e.wkt&&!e.wkt.data)return void t.error("[AngularJS - Openlayers] - You need a WKT property to add a WKT format vector layer.");a=new ol.source.Vector;var w,b=new ol.format.WKT;w=i(e.wkt.projection)?new ol.proj.get(e.wkt.projection):o;var L=b.readFeatures(e.wkt.data,{featureProjection:o.getCode(),dataProjection:w.getCode()});a.addFeatures(L);break;case"JSONP":if(!e.url)return void t.error("[AngularJS - Openlayers] - You need an url properly configured to add a JSONP layer.");i(e.url)&&(a=new ol.source.ServerVector({format:l,loader:function(){var o=e.url+"&outputFormat=text/javascript&format_options=callback:JSON_CALLBACK";r.jsonp(o,{cache:e.cache}).success(function(e){a.addFeatures(l.readFeatures(e))}).error(function(e){t(e)})},projection:o}));break;case"TopoJSON":if(!e.topojson&&!e.url)return void t.error("[AngularJS - Openlayers] - You need a topojson property to add a TopoJSON layer.");a=e.url?new ol.source.Vector({format:new ol.format.TopoJSON,url:e.url}):new ol.source.Vector(angular.extend(e.topojson,{format:new ol.format.TopoJSON}));break;case"TileJSON":a=new ol.source.TileJSON({url:e.url,attributions:T(e),tileLoadFunction:e.tileLoadFunction,crossOrigin:"anonymous"});break;case"TileVector":e.url&&e.format||t.error("[AngularJS - Openlayers] - TileVector Layer needs valid url and format properties"),a=new ol.source.VectorTile({url:e.url,projection:o,attributions:T(e),tileLoadFunction:e.tileLoadFunction,format:e.format,tileGrid:new ol.tilegrid.createXYZ({maxZoom:e.maxZoom||19})});break;case"TileTMS":e.url&&e.tileGrid||t.error("[AngularJS - Openlayers] - TileTMS Layer needs valid url and tileGrid properties"),a=new ol.source.TileImage({url:e.url,maxExtent:e.maxExtent,attributions:T(e),tileLoadFunction:e.tileLoadFunction,tileGrid:new ol.tilegrid.TileGrid({origin:e.tileGrid.origin,resolutions:e.tileGrid.resolutions}),tileUrlFunction:function(t){var r=t[0],o=t[1],a=t[2];if(o<0||a<0)return"";var n=e.url+r+"/"+o+"/"+a+".png";return n}});break;case"TileImage":a=new ol.source.TileImage({url:e.url,attributions:T(e),tileLoadFunction:e.tileLoadFunction,tileGrid:new ol.tilegrid.TileGrid({origin:e.tileGrid.origin,resolutions:e.tileGrid.resolutions}),tileUrlFunction:function(t){var r=t[0],o=t[1],a=-t[2]-1,n=e.url.replace("{z}",r.toString()).replace("{x}",o.toString()).replace("{y}",a.toString());return n}});break;case"KML":var O=e.extractStyles||!1;a=new ol.source.Vector({url:e.url,format:new ol.format.KML,radius:e.radius,extractStyles:O});break;case"Stamen":if(!e.layer||!j(e.layer))return void t.error("[AngularJS - Openlayers] - You need a valid Stamen layer.");a=new ol.source.Stamen({tileLoadFunction:e.tileLoadFunction,layer:e.layer});break;case"ImageStatic":if(!e.url||!angular.isArray(e.imageSize)||2!==e.imageSize.length)return void t.error("[AngularJS - Openlayers] - You need a image URL to create a ImageStatic layer.");a=new ol.source.ImageStatic({url:e.url,attributions:T(e),imageSize:e.imageSize,projection:o,imageExtent:e.imageExtent?e.imageExtent:o.getExtent(),imageLoadFunction:e.imageLoadFunction});break;case"XYZ":e.url||e.tileUrlFunction||t.error("[AngularJS - Openlayers] - XYZ Layer needs valid url or tileUrlFunction properties"),a=new ol.source.XYZ({url:e.url,attributions:T(e),minZoom:e.minZoom,maxZoom:e.maxZoom,projection:e.projection,tileUrlFunction:e.tileUrlFunction,tileLoadFunction:e.tileLoadFunction});break;case"Zoomify":e.url&&angular.isArray(e.imageSize)&&2===e.imageSize.length||t.error("[AngularJS - Openlayers] - Zoomify Layer needs valid url and imageSize properties"),a=new ol.source.Zoomify({url:e.url,size:e.imageSize})}return a||t.warn('[AngularJS - Openlayers] - No source could be found for type "'+e.type+'"'),a},M=function(e){var t=e;if(e&&"object"==typeof e){t="[object Array]"===Object.prototype.toString.call(e)?[]:{};for(var r in e)t[r]=M(e[r])}return t},T=function(e){var t=[];return i(e.attribution)&&t.unshift(new ol.Attribution({html:e.attribution})),t},E=function(e){var t=new ol.layer.Group;return t.set("name",e),t},P=function(e,t){var r;return angular.forEach(e,function(e){if(e instanceof ol.layer.Group&&e.get("name")===t)return void(r=e)}),r},A=function(e,t){for(var r,o=0;o<e.getLength();o++){var a=e.item(o);if(a.get("markers")){r=o;break}}if(i(r)){var n=e.item(r);t.index=r,e.setAt(r,t),n.index=e.getLength(),e.push(n)}else t.index=e.getLength(),e.push(t)},D=function(e,t){e.forEach(function(r,o){if(r.index===t)return void e.removeAt(o)})};return{isDefined:i,isNumber:function(e){return angular.isNumber(e)},createView:function(e){var t=F(e),r={projection:t,maxZoom:e.maxZoom,minZoom:e.minZoom};return e.center&&(r.center=e.center),e.extent&&(r.extent=e.extent),e.zoom&&(r.zoom=e.zoom),e.resolutions&&(r.resolutions=e.resolutions),new ol.View(r)},isDefinedAndNotNull:s,isString:function(e){return angular.isString(e)},isArray:function(e){return angular.isArray(e)},isObject:function(e){return angular.isObject(e)},equals:function(e,t){return angular.equals(e,t)},isValidCenter:function(e){return angular.isDefined(e)&&("boolean"==typeof e.autodiscover||angular.isNumber(e.lat)&&angular.isNumber(e.lon)||angular.isArray(e.coord)&&2===e.coord.length&&angular.isNumber(e.coord[0])&&angular.isNumber(e.coord[1])||angular.isArray(e.bounds)&&4===e.bounds.length&&angular.isNumber(e.bounds[0])&&angular.isNumber(e.bounds[1])&&angular.isNumber(e.bounds[1])&&angular.isNumber(e.bounds[2]))},safeApply:function(e,t){var r=e.$root.$$phase;"$apply"===r||"$digest"===r?e.$eval(t):e.$apply(t)},isSameCenterOnMap:function(e,t){var r=e.projection||"EPSG:4326",o=[e.lon,e.lat],a=t.getView().getProjection(),n=ol.proj.transform(t.getView().getCenter(),a,r),l=t.getView().getZoom();return n[1].toFixed(4)===o[1].toFixed(4)&&n[0].toFixed(4)===o[0].toFixed(4)&&l===e.zoom},setCenter:function(e,t,r,o){if(o&&e.getCenter()){var a=ol.animation.pan({duration:150,source:e.getCenter()});o.beforeRender(a)}if(r.projection===t)e.setCenter([r.lon,r.lat]);else{var n=[r.lon,r.lat];e.setCenter(ol.proj.transform(n,r.projection,t))}},setZoom:function(e,t,r){var o=ol.animation.zoom({duration:150,resolution:r.getView().getResolution()});r.beforeRender(o),e.setZoom(t)},isBoolean:function(e){return"boolean"==typeof e},createStyle:O,setMapEvents:function(e,t,r){if(i(e)&&angular.isArray(e.map))for(var o in e.map){var a=e.map[o];c(t,a,r)}},getGreatCircleDistance:n,getGeodesicDistance:l,setClickMarker:m,setOverMarker:f,setMarkerEvent:y,setVectorLayerEvents:function(e,t,r,o){i(e)&&angular.isArray(e.layers)&&angular.forEach(e.layers,function(e){angular.element(t.getViewport()).on(e,function(a){var n=t.getEventPixel(a),l=t.forEachFeatureAtPixel(n,function(e,t){return s(t)&&t.get("name")===o?e:null});s(l)&&r.$emit("openlayers.layers."+o+"."+e,l,a)})})},setViewEvents:function(e,t,r){if(i(e)&&angular.isArray(e.view)){var o=t.getView();angular.forEach(e.view,function(e){o.on(e,function(t){r.$emit("openlayers.view."+e,o,t)})})}},detectLayerType:x,createLayer:function(e,t,r,o){var a,n=x(e),l=C(e.source,t);if(l){"function"!=typeof r||o||(o=r,r=void 0),"Vector"===n&&e.clustering&&(l=new ol.source.Cluster({source:l,distance:e.clusteringDistance}));var c={source:l};switch(s(e.opacity)&&(c.opacity=e.opacity),s(e.visible)&&(c.visible=e.visible),s(e.extent)&&(c.extent=e.extent),s(e.zIndex)&&(c.zIndex=e.zIndex),s(e.minResolution)&&(c.minResolution=e.minResolution),s(e.maxResolution)&&(c.maxResolution=e.maxResolution),n){case"Image":a=new ol.layer.Image(c);break;case"Tile":a=new ol.layer.Tile(c);break;case"Heatmap":a=new ol.layer.Heatmap(c);break;case"Vector":a=new ol.layer.Vector(c);break;case"TileVector":a=new ol.layer.VectorTile(c)}if(i(r)?a.set("name",r):i(e.name)&&a.set("name",e.name),i(e.customAttributes))for(var u in e.customAttributes)a.set(u,e.customAttributes[u]);return o&&o({oLayer:a}),a}},createVectorLayer:function(){return new ol.layer.Vector({source:new ol.source.Vector,zIndex:arguments[0]||0})},createClusterLayer:function(){return new ol.layer.Vector({source:new ol.source.Cluster({distance:20,source:new ol.source.Vector}),zIndex:arguments[0]||0})},notifyCenterUrlHashChanged:function(e,t,r){if(t.centerUrlHash){var o=t.lat.toFixed(4)+":"+t.lon.toFixed(4)+":"+t.zoom;i(r.c)&&r.c===o||e.$emit("centerUrlHash",o)}},getControlClasses:h,detectControls:function(e){var t={},r=h();return e.forEach(function(e){for(var o in r)e instanceof r[o]&&(t[o]=e)}),t},getInteractionClasses:w,createFeature:function(e,t){var r;switch(e.type){case"Polygon":r=new ol.geom.Polygon(e.coords);break;case"LineString":r=new ol.geom.LineString(e.coords);break;case"MultiLineString":r=new ol.geom.MultiLineString(e.coords);break;case"Point":r=new ol.geom.Point(e.coords);break;case"Circle":r=new ol.geom.Circle(e.coords,e.radius);break;default:e.coords?r=new ol.geom.Point(e.coords):e.lat&&e.lon&&(r=new ol.geom.Point([e.lon,e.lat]))}i(e.projection)&&"pixel"!==e.projection&&(r=r.transform(e.projection,t));var o=new ol.Feature({id:e.id?e.id:"",geometry:r});if(i(e.style)){var a=O(e.style);o.setStyle(a)}return o},addLayerBeforeMarkers:A,getGroup:P,addLayerToGroup:function(e,t,r){var o=P(e,r);i(o)||(o=E(r),A(e,o)),t.set("group",r),A(o.getLayers(),t)},removeLayerFromGroup:function(e,t,r){var o=P(e,r);t.set("group"),D(o.getLayers(),t.index)},removeLayer:D,insertLayer:function(e,t,r){if(e.getLength()<t){for(;e.getLength()<t;){var o=new ol.layer.Image;o.index=e.getLength(),e.push(o)}r.index=t,e.push(r)}else{r.index=t,e.insertAt(r.index,r);for(var a=t+1;a<e.getLength();a++){var n=e.item(a);if(null===n){e.removeAt(a);break}n.index=a}}},createOverlay:u,removeOverlay:p}}]),angular.module("openlayers-directive").factory("olMapDefaults",["$q","olHelpers",function(e,t){var r="data:image/png;base64,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",o=function(){return{view:{projection:"EPSG:3857",minZoom:void 0,maxZoom:void 0,rotation:0,extent:void 0},center:{lat:0,lon:0,zoom:1,autodiscover:!1,bounds:[],centerUrlHash:!1,projection:"EPSG:4326"},styles:{path:{fill:{color:"rgba(255,0,0,0.2)"},stroke:{color:"blue",width:4}},marker:{image:new ol.style.Icon({anchor:[.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",opacity:.9,src:r})},feature:{fill:new ol.style.Fill({color:"#0099ff"}),stroke:new ol.style.Stroke({color:"#1F497D",width:1}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#0099ff"}),stroke:new ol.style.Stroke({color:"#1F497D",width:1})})}},events:{map:[],markers:[],layers:[]},controls:{attribution:!0,rotate:!1,zoom:!0},interactions:{mouseWheelZoom:!1},renderer:"canvas"}},a=t.isDefined,n={};return{getDefaults:function(e){if(!a(e))for(var t in n)return n[t];return n[e.$id]},setDefaults:function(e){var t=e.defaults,r=e.$id,l=o();return a(t)&&(a(t.layers)&&(l.layers=angular.copy(t.layers)),a(t.controls)&&(l.controls=angular.copy(t.controls)),a(t.events)&&(l.events=angular.copy(t.events)),a(t.interactions)&&(l.interactions=angular.copy(t.interactions)),a(t.renderer)&&(l.renderer=t.renderer),a(t.view)&&(l.view.maxZoom=t.view.maxZoom||l.view.maxZoom,l.view.minZoom=t.view.minZoom||l.view.minZoom,l.view.projection=t.view.projection||l.view.projection,l.view.extent=t.view.extent||l.view.extent,l.view.resolutions=t.view.resolutions||l.view.resolutions),a(t.styles)&&(l.styles=angular.extend(l.styles,t.styles)),a(t.loadTilesWhileAnimating)&&(l.loadTilesWhileAnimating=t.loadTilesWhileAnimating),a(t.loadTilesWhileInteracting)&&(l.loadTilesWhileInteracting=t.loadTilesWhileInteracting)),n[r]=l,l}}}]);