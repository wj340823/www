package com.sucsoft.gzhbyjwz.util;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import org.springframework.util.Assert;

import com.fasterxml.jackson.annotation.JsonIgnore;

public class Page<T> implements Serializable {
	private static final long serialVersionUID = 1L;
	private static int DEFAULT_PAGE_SIZE = 20;
	
	long totalCount = 0;
	int pageNo = 1;
	int pageSize = DEFAULT_PAGE_SIZE;

	private int pageCount;//一共的页数
	private int start;//起始数据位置
	private int end;//结束

	List<T> dataList = new ArrayList<T>();

	@JsonIgnore
	private String sql = "";
	@JsonIgnore
	private String hql = "";
	@JsonIgnore
	private String countHql = "";
	@JsonIgnore
	private String countSql = "";	 
	
	public Page(long totalCount, int pageNo, int pageSize, List<T> data) {
		Assert.isTrue(totalCount >= 0, "totalCount must be larger than or euqal with 0");
		Assert.isTrue(pageNo > 0, "pageNo must start from 1");
		Assert.isTrue(pageSize >= 0, "pageSize must be larger than or euqal with 0");
		this.totalCount = totalCount;		
		this.dataList = data;
		this.pageNo = pageNo;
		this.pageSize = pageSize;
		
	}

	public void setPage(){
      /*根count 和pageSize计算页数pageCount
       */
		int pageCount_x=(int)totalCount/pageSize;
		if(totalCount>=pageSize){
			this.pageCount=totalCount%pageSize==0?pageCount_x:pageCount_x+1;
		}else{
			this.pageCount=1;
		}
		//判断页数和当前页数
		if(pageNo>pageCount){
			pageNo=pageCount;
		}
		if(pageNo<1){
			pageNo=1;
		}
		//根据当前页计算起始和结束条目
		this.start=(pageNo-1)*pageSize+1;
		this.end=pageNo*pageSize>totalCount?(int)totalCount:pageNo*pageSize;

		List<T> initList = this.dataList;
		List<T> result = new ArrayList<>();
		if(!initList.isEmpty()){
			if(this.start==initList.size()){
				result.add(initList.get(this.end-1));
			}else{
				for(int i=this.start-1;i<this.end;i++){
					result.add(initList.get(i));
				}
			}
			this.setDataList(result);
		}
	}
	  
	public Page<T> setHql(String hql){
		this.hql = hql;
	    this.countHql = removeOrders(hql);
	    return this;
	}	  
	public Page<T> setSql(String sql) {
		this.sql = sql;
	    this.countSql = removeOrders(sql);
	    return this;
	}
	  
	private String removeOrders(String hql) {
		Pattern p = Pattern.compile("order\\s*by[\\w|\\W|\\s|\\S]*", Pattern.CASE_INSENSITIVE);
		Matcher m = p.matcher(hql);
		StringBuffer sb = new StringBuffer();
		while (m.find()) {
			m.appendReplacement(sb, "");
		}
		m.appendTail(sb);
		return sb.toString();
	}
	  
	public String getHql(){
		return this.hql;
	}	  
	public String getSql() {
	    return this.sql;
	}
	public String getCountHql() {
	    return this.countHql;
	}
	public String getCountSql() {
	    return this.countSql;
	}
	
	public long getTotalCount() {
		return totalCount;
	}

	public void setTotalCount(long totalCount) {
		this.totalCount = totalCount;
	}

	public List<T> getDataList() {
		return dataList;
	}
	public void setDataList(List<T> dataList) {
		this.dataList = dataList;
	}
	public int getTotalPageCount() {
		int totalPageCount = (int) Math.ceil((double)totalCount / this.pageSize);
		return totalPageCount;
	}
	public int getPageNo() {
		return pageNo;
	}
	public int getPageSize() {
		return pageSize;
	}

	public void setPageNo(int pageNo) {
		this.pageNo = pageNo;
	}

	public void setPageSize(int pageSize) {
		this.pageSize = pageSize;
	}
	
}