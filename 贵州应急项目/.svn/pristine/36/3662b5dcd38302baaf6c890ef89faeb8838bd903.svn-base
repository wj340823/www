package com.sucsoft.gzhbyjwz.controller;


import com.cgs.authox.starter.exception.BadRequest;
import com.sucsoft.gzhbyjwz.bean.common.ModelBean;
import com.sucsoft.gzhbyjwz.bean.common.Page;
import com.sucsoft.gzhbyjwz.bean.common.ResultBean;
import com.sucsoft.gzhbyjwz.service.PreplanService;
import com.sucsoft.gzhbyjwz.service.user.UserService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.util.HashMap;
import java.util.Map;

@RestController
@RequestMapping("/yaInfos")
@Api(value="PreplanController",description="预案信息")
public class PreplanController {

    @Autowired
    private PreplanService preplanService;
    @Autowired
    private UserService userService;

    @ApiOperation(value = "新增预案基础数据")
    @RequestMapping(value = "/get/preplan/{companyId}", method = RequestMethod.GET)
    public Map<String, Object> queryEnterprisePreplan(@PathVariable String companyId) throws Exception {
        return preplanService.queryEnterprisePreplan(companyId);
    }

    @ApiOperation(value = "新增待审核预案")
    @RequestMapping(value = "/add/preplan", method = RequestMethod.POST)
    public Map<String,String> addNewEnterprisePreplan(@RequestBody ModelBean modelBean) throws Exception {//EnterprisePreplan enterprisePreplan

        return preplanService.addNewEnterprisePreplan(modelBean);
    }

    @ApiOperation(value = "查询待审核预案")
    @RequestMapping(value = "/query/preplan", method = RequestMethod.GET)
    public Map<String,Object> queryNewEnterprisePreplan(String yaid, String companyId) throws Exception {//EnterprisePreplan enterprisePreplan

        return preplanService.queryNewEnterprisePreplan(yaid, companyId);
    }

    @ApiOperation(value = "更新待审核预案")
    @RequestMapping(value = "/update/preplan", method = RequestMethod.POST)
    public Map<String,String> updateNewEnterprisePreplan(@RequestBody ModelBean modelBean) throws Exception {//EnterprisePreplan enterprisePreplan

        return preplanService.updateNewEnterprisePreplan(modelBean);
    }

    @ApiOperation(value = "查询预案备案清单")
    @RequestMapping(value = "/query/yabaqd", method = RequestMethod.GET)
    public Map<String,Object> queryYabaqd(String xzqyId) throws Exception {//EnterprisePreplan enterprisePreplan
        Map<String, Object> map = new HashMap<>();
        map.put("data", preplanService.queryYabaqd(xzqyId));
        return map;
    }

    @ApiOperation(value = "导出预案备案清单")
    @RequestMapping(value = "/excel/yabaqd", method = RequestMethod.GET)
    public void exportedExcel(HttpServletResponse response, HttpServletRequest request, HttpSession session) throws Exception {
        String xzqyId = (String) session.getAttribute("xzqyId");
        preplanService.exportedExcel(response, request, xzqyId);
    }

    @ApiOperation(value = "预案备案清单导入",httpMethod = "POST",notes = "EXCEL导入")
    @RequestMapping(value = "/excel/import",method = RequestMethod.POST)
    public ResultBean importExcel(MultipartFile file) throws Exception{
//        if (!userService.isAdmin()){
//            throw  new BadRequest("无导入权限");
//        }
        return preplanService.importExcel(file);
    }

    @RequestMapping(value="/downModel",method= RequestMethod.GET)
    @ApiOperation(httpMethod="GET",value="下载Excel模板",notes="下载Excel模板",
            response= Page.class,produces= MediaType.TEXT_PLAIN_VALUE)
    public void downModel(HttpServletResponse response, HttpServletRequest request) throws Exception{
        preplanService.downModel(response);
    }
}
