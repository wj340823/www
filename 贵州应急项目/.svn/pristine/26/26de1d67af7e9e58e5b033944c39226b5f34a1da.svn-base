---
  grammer: SQL
  queries:
    #根据条件查询任务列表
    - name: listTaskByStatus
      resultType: Map
      statement:
        "
        select
          t.*,
          i1.status as status1,
          i2.status as status2
        from
          emergencytask t
        LEFT JOIN riskinventory i1 ON i1.TASKID = t.ID
        LEFT JOIN riskinventory i2 ON i2.TASKID = t.ID
        where
          1=1
        #if($status)
          and t.status =:status
        #end
        #if($notStatus)
          and t.status <>:notStatus
        #end
        #if($completetimeStart)
          and t.completetime >=:completetimeStart
        #end
        #if($completetimeEnd)
          and t.completetime <=:completetimeEnd
        #end
        #if($name)
          and t.name like :name
        #end
        #if($enterpriseId)
          and i1.enterpriseId = :enterpriseId and i2.enterpriseId = :enterpriseId
        #end
        ORDER BY DEADLINE DESC
        "

    #根据条件查询任务列表
    - name: listEmergencyTask
      resultType: Map
      statement:
        "
        SELECT
        	t.*,
        	s.releaseStatus,
        	COUNT(DISTINCT e.ID) as sum,
        	COUNT(DISTINCT e1.ID) as csum
        FROM
        	emergencytask t
        LEFT JOIN enterprisetask e ON e.EMERGENCYTASKID = t.ID
        LEFT JOIN enterpriseinformation e1 ON e1.COMPANYID = e.ENTERPRISEID
        LEFT JOIN (
            select
              *
            from
              taskxzqystatus
            where
              1=1
              #if($xzqyId)
                and XZQYID =:xzqyId
              #end
            ) s on s.taskId = t.ID
        LEFT JOIN (
        	SELECT
        		e1.ID,
        		e1.EMERGENCYTASKID
        	FROM
        		enterprisetask e1
        	WHERE
        		e1. STATUS = 100
        	#if($xzqyIdList)
                and ( e1.XZQYID #qin($xzqyIdList 'xzqyIdList') or e1.XZQYID is NULL)
            #end
        ) e1 ON e1.EMERGENCYTASKID = t.ID
        where
          1=1
        #if($xzqyIdList)
          and ( e1.XZQYID #qin($xzqyIdList 'xzqyIdList') or e1.XZQYID is NULL)
        #end
        #if($strTime)
          and t.DEADLINE >= :strTime
        #end
        #if($endTime)
          and t.DEADLINE <= :endTime
        #end
        #if($keywords)
          and (t.NAME like :keywords )
        #end
        GROUP BY t.ID
        ORDER BY t.DEADLINE DESC
        "
    #根据条件查询任务列表
    - name: listTaskToEnterprise
      resultType: Map
      statement:
        "
        select
          t.*,
          i1.status as status1,
          i2.status as status2
        from
          enterprisetask t
        LEFT JOIN enterpriseinformation e ON e.COMPANYID = t.ENTERPRISEID
        LEFT JOIN riskinventory i1 ON t.emergencyManagementId = i1.ID
        LEFT JOIN riskinventory i2 ON t.riskManagementId = i2.ID
        where
          1=1
        #if($status)
          and t.status =:status
        #end
        #if($notStatus)
          and t.status <>:notStatus
        #end
        #if($statusList)
          and t.status #qin($statusList 'statusList')
        #end
        #if($completetimeStart)
          and t.completetime >=:completetimeStart
        #end
        #if($completetimeEnd)
          and t.completetime <=:completetimeEnd
        #end
        #if($name)
          and t.name like :name
        #end
        #if($enterpriseId)
          and e.COMPANYID = :enterpriseId
        #end
        #if($emergencyTaskId)
          and t.emergencyTaskId = :emergencyTaskId
        #end
        ORDER BY DEADLINE DESC
        "

    #获取排查表详情
    - name: getRiskinventoryDetails
      resultType: Map
      statement:
        "
        select
          i.ID,
          i. STATUS,
          i.TIME,
          i.RESPONSIBLEPERSON,
          COUNT(*) as sum
        from
          riskinventory i
        LEFT JOIN hiddendanger h ON h.INVENTORYID = i.ID
        where
          1=1
        #if($id)
          and i.ID =:id
        #end
        ORDER BY i.ID
        "
    #审批任务列表
    - name: listTaskToExam
      resultType: Map
      statement:
        "
        select
          t.*,
          e2.companyName as companyName,
          x.name as xaqyName,
          i.ID as iId,
          COUNT(DISTINCT t1.ID) AS sum1,
          COUNT(DISTINCT t2.ID) AS sum2
        from
          enterprisetask t
        LEFT JOIN enterpriseinformation e2 ON e2.COMPANYID = t.ENTERPRISEID
        LEFT JOIN xzqy x on x.ID = e2.XZQYID
        LEFT JOIN riskinventory i ON (t.EMERGENCYMANAGEMENTID = i.ID OR t.RISKMANAGEMENTID = i.ID)
        LEFT JOIN (
          SELECT
            ID,
            h.level,
            h.INVENTORYID
          FROM
            hiddendanger h
          WHERE
            h.LEVEL = 3
            AND h.RESULT = 1
        ) t1 ON t1.INVENTORYID = i.ID
        LEFT JOIN (
          SELECT
            ID,
            h.level,
            h.INVENTORYID
          FROM
            hiddendanger h
          WHERE
            h.LEVEL = 2
            AND h.RESULT = 1
        ) t2 ON t2.INVENTORYID = i.ID
        where
          1=1
        #if($starttime)
          and t.completetime >:starttime
        #end
        #if($endtime)
          and t.completetime <:endtime
        #end
        #if($name)
          and (t.name like :name or e2.companyName like :name)
        #end
        #if($xzqyId)
          and t.xzqyId =:xzqyId
        #end
        #if($xzqyIdList)
          and e2.XZQYID #qin($xzqyIdList 'xzqyIdList')
        #end
        #if($level)
          and (t1.level =:level or t2.level =:level)
        #end
        #if($status)
          and t.status =:status
        #end
        #if($notStatus)
          and t.status <>:notStatus
        #end
        #if($statusList)
          and t.status #qin($statusList 'statusList')
        #end
        group by t.ID
        order BY t.DEADLINE DESC
        "

    #审批记录列表
    - name: listExamLog
      resultType: Map
      statement:
        "
        SELECT
        	*
        FROM
        	(
        		SELECT
        			t.*,
        			x. NAME AS xaqyName,
        			i.ID AS iId,
        			e2.companyName as companyName,
        			COUNT(DISTINCT t1.ID) AS sum1,
        			COUNT(DISTINCT t2.ID) AS sum2
        		FROM
        			enterprisetask t
        		LEFT JOIN enterpriseinformation e2 ON e2.COMPANYID = t.ENTERPRISEID
        		LEFT JOIN xzqy x ON x.ID = e2.XZQYID
        		LEFT JOIN riskinventory i ON (
        			t.EMERGENCYMANAGEMENTID = i.ID
        			OR t.RISKMANAGEMENTID = i.ID
        		)
        		LEFT JOIN (
        			SELECT
        				ID,
        				h. LEVEL,
        				h.INVENTORYID
        			FROM
        				hiddendanger h
        			WHERE
        				h. LEVEL = 3
        			AND h.RESULT = 1
        		) t1 ON t1.INVENTORYID = i.ID
        		LEFT JOIN (
        			SELECT
        				ID,
        				h. LEVEL,
        				h.INVENTORYID
        			FROM
        				hiddendanger h
        			WHERE
        				h. LEVEL = 2
        			AND h.RESULT = 1
        		) t2 ON t2.INVENTORYID = i.ID
        		WHERE
        			1 = 1
        		#if($starttime)
                  and t.completetime >:starttime
                #end
                #if($endtime)
                  and t.completetime <:endtime
                #end
                #if($keywords)
                  and (t.name like :keywords or e2.companyName like :keywords)
                #end
                #if($xzqyId)
                  and e2.xzqyId =:xzqyId
                #end
                #if($xzqyIdList)
                  and e2.xzqyId #qin($xzqyIdList 'IDS')
                #end
                #if($status)
                  and t.status =:status
                #end
        		GROUP BY
        			t.ID
        		order by t.DEADLINE DESC
        	) t
        WHERE
          1=1
        #if($hasSignificant)
          and t.sum2 > 0
        #end
        #if($hasEmergency)
          and t.sum1 > 0
        #end
        "
    - name: listEmergencyInfo
      resultType: Map
      statement:
        "
        select
          e.status,
          e.name,
          e.xzqyId,
          e2.companyname
        from
          EnterpriseTask e
        left join enterpriseinformation e2 ON e2.COMPANYID = e.ENTERPRISEID
        WHERE
          1=1
        #if($taskId)
          and e.emergencyTaskId = :taskId
        #end
        #if($xzqyList)
          and e.xzqyid #qin($xzqyList 'xzqyList')
        #end
        "