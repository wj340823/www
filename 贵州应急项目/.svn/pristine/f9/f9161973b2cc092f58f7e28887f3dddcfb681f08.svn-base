package com.sucsoft.gzhbyjwz.service;

import com.sucsoft.gzhbyjwz.bean.common.Page;
import com.sucsoft.gzhbyjwz.bean.dc12.ExampleAttachement;
import com.sucsoft.gzhbyjwz.bean.param.ExampleParam;
import com.sucsoft.gzhbyjwz.service.common.BasicQueryService;
import com.sucsoft.gzhbyjwz.util.HttpUtil;
import com.sucsoft.gzhbyjwz.util.StringUtils;
import com.sucsoft.gzhbyjwz.util.UploadUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.util.FileCopyUtils;
import org.springframework.web.multipart.MultipartFile;

import javax.servlet.http.HttpServletResponse;
import java.io.FileInputStream;
import java.io.IOException;
import java.nio.file.Paths;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

@Service
public class EmergencyExampleService {

  @Value("${emergencyExample.filePath}")
  private String filePath;

  @Autowired
  private BasicQueryService queryService;

  public Object listEmergencyExample(ExampleParam exampleParam, Integer pageNo, Integer pageSize)
      throws Exception {
    Map param = exampleParam.toParam();
    Page page =
        queryService.queryForPage("listEmergencyExample", param, Map.class, pageNo, pageSize);
    return page;
  }

  // 添加附件
  public void addExampleAttachment(MultipartFile file, ExampleAttachement attachment)
      throws IOException {
    int size = file.getInputStream().available();
    String url = UploadUtil.saveMultipartFile(file, filePath);
    if (url != null) {
      attachment.setUrl(url);
      attachment.setSize(String.valueOf(size));
      attachment.setLastupdatetime(new Date());
      attachment.setName(file.getOriginalFilename());
      queryService.save(attachment);
    }
  }

  // 附件下载
  public void downExampleAttachment(String attachmentId, HttpServletResponse response)
      throws IOException {
    ExampleAttachement attachment = queryService.get(attachmentId, ExampleAttachement.class);
    String url = attachment.getUrl();
    HttpUtil.download(Paths.get(filePath, url).toFile(), attachment.getUrl(), response);

  }

  // 根据预案id查询附件列表
  public Page listAttachementByExampleId(String exampleId, Integer pageNo, Integer pageSize)
      throws Exception {
    Map<String, Object> param = new HashMap<>();
    param.put("exampleId", exampleId);

    return queryService.queryForPage("listAttachementByExampleId", param, Map.class, pageNo,
        pageSize);
  }

}
