package com.sucsoft.gzhbyjwz.controller.riskManage;

import com.sucsoft.gzhbyjwz.bean.common.Page;
import com.sucsoft.gzhbyjwz.bean.constant.TaskStatus;
import com.sucsoft.gzhbyjwz.bean.dc12.ExaminationLog;
import com.sucsoft.gzhbyjwz.bean.param.riskManage.EmergencyTaskParam;
import com.sucsoft.gzhbyjwz.bean.param.riskManage.TaskParam;
import com.sucsoft.gzhbyjwz.service.XzqyService;
import com.sucsoft.gzhbyjwz.service.riskmanage.EmergencyTaskService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;

import java.util.Date;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/examTask")
@Api(value="ExamController",description="风险任务审批管理")
public class ExamController {

    @Autowired
    private EmergencyTaskService taskService;

    @Autowired
    private XzqyService xzqyService;

    @RequestMapping(value="/exam",method= RequestMethod.POST)
    @ApiOperation(httpMethod="POST",value="审批",notes="type:1-通过，2-驳回",
            produces= MediaType.TEXT_PLAIN_VALUE)
    public void pass(@RequestBody ExaminationLog log) throws Exception{
        log.setUpdatetime(new Date());
        taskService.pass(log);
    }

    @RequestMapping(value="/listTaskToBeExam",method= RequestMethod.GET)
    @ApiOperation(httpMethod="GET",value="列出带审批任务列表",notes="列出带审批任务列表,带分页",
            response= Page.class,produces= MediaType.TEXT_PLAIN_VALUE)
    public Page listTaskToBeExam(@RequestParam(value = "pageNo", defaultValue = "1")   Integer pageNo,
                                 @RequestParam(value = "pageSize", defaultValue = "15")Integer pageSize,
                                 @RequestParam(required = false) @ApiParam("关键字")String keywords) throws Exception{
        TaskParam param = new TaskParam();
        param.setName(keywords);
        param.setStatus(TaskStatus.CountyAndDistrict);
        //按行政区域划分数据权限
        param.setXzqyIdList(xzqyService.getChildrenLeafId(param.getXzqyId()));

        return taskService.listTaskToExam(param,pageNo,pageSize);
    }

    @RequestMapping(value="/listTaskBeExamed",method= RequestMethod.GET)
    @ApiOperation(httpMethod="GET",value="列出已审批任务列表",notes="列出已审批任务列表,带分页",
            response= Page.class,produces= MediaType.TEXT_PLAIN_VALUE)
    public Page listTaskBeExamed(@RequestParam(value = "pageNo", defaultValue = "1")    Integer pageNo,
                                 @RequestParam(value = "pageSize", defaultValue = "15")  Integer pageSize,
                                 TaskParam param) throws Exception{

        param.getStatusList().add(TaskStatus.Pass);
        param.getStatusList().add(TaskStatus.Reject);

        //按行政区域划分数据权限
        param.setXzqyIdList(xzqyService.getChildrenLeafId(param.getXzqyId()));
        return taskService.listTaskToExam(param,pageNo,pageSize);
    }

    @RequestMapping(value="/listExamLog",method= RequestMethod.GET)
    @ApiOperation(httpMethod="GET",value="排查记录列表",notes="排查记录列表,带分页",
            response= Page.class,produces= MediaType.TEXT_PLAIN_VALUE)
    public Page listExamLog(@RequestParam(value = "pageNo", defaultValue = "1")   Integer pageNo,
                            @RequestParam(value = "pageSize", defaultValue = "15")Integer pageSize,
                            EmergencyTaskParam param ) throws Exception{
        //TaskParam param = new TaskParam();
        param.setTaskStatus(TaskStatus.Pass);
        //按行政区域划分数据权限
        param.setXzqyIdList(xzqyService.getChildrenLeafId(param.getXzqyId()));

        return taskService.listExamLog(param,pageNo,pageSize);
    }


}
