define(['app'], function (app) {

	app.controller("emerHeadCtrl", function ($rootScope, $scope, $http, $stateParams, $uibModal, mapSet, chartSet) {
		$rootScope.system = "new";
		$scope.$on("$destroy", function () {
			$rootScope.system = "";
		});
	});

	app.controller("emerPlanCtrl", function ($rootScope, $scope, $http, $stateParams, $uibModal, mapSet, chartSet) {

		// 获取select地区数据
		$scope.getArea = function () {
			$http.get("basicData/listXzqy").then(function (response) {
				$scope.itAreas = response.data;
			});
		};

		//查询按钮功能，查询并回显
		$scope.searchInfo = function () {
			$('.loader').show();  //加载查询动态条
            $http.post("preplan/listEnterprisePreplan?" + "&pageNo=" + $scope.page.currentPage,
                {
                    "companyName": $scope.search.companyName,
                    "level": $scope.search.level,
                    "recordStatus": $scope.search.recordStatus,
                    "xzqyId": $scope.search.xzqyId
                }
            ).then(function (data) {
									$('.loader').hide();
									$scope.page.list = data.data;
									$scope.page.totalCount = data.data.totalCount;
									$scope.page.pageSize = data.data.pageSize;
				});
		};

		$scope.searchCountry = function () {
			$('.loader').show();  //加载查询动态条
            $http.post("preplan/listEnterprisePreplan?" + "&pageNo=" + $scope.page.currentPage,
                {
                    "companyName": $scope.search.companyName,
                    "level": $scope.search.level,
                    "recordStatus": $scope.search.recordStatus,
                    "xzqyId": $scope.search.xzqyId
                }
            ).then(function (data) {
				$('.loader').hide();
				$scope.page.list = data.data;
				$scope.page.totalCount = data.data.totalCount;
				$scope.page.pageSize = data.data.pageSize;
				});
		};

		$scope.xzqyId = '15';
		$scope.exzqyId = '15';

		// 初始化
		function init() {
			$scope.page = {
				url: "preplan/listEnterprisePreplan",
				totalCount: 10,
				currentPage: 1,
				pageSize: 10,
				list: []
			};
			$scope.search = {
				xzqyId: '-1',
				level: '-1',
				recordStatus: '-1',
				strDate:new Date().getFullYear()+'/01/01',
				endDate:new Date().getFullYear()+1+'/01/01',
				companyName: ''
			};
			$scope.getArea();
			$scope.searchInfo();
		}

		// 调用初始化
		init();
	});

	app.controller("emerDetailCtrl", function ($rootScope, $scope, $http, $stateParams, mapSet, chartSet, $timeout) {
		console.log($rootScope.userList.ID)
		$scope.comName  = $rootScope.userList.companyName;
		$scope.getDatail = function () {
			$http.get("preplan/getBycompanyId?" + "companyId=" + encodeURIComponent($rootScope.userList.companyId)).then(function (data) {
				$scope.detail = data.data;
				$scope.ID = $scope.detail.ID;
				console.log($scope.ID)
			})
		}
		// 获取文件数据
		$scope.getFileDetail = function () {
			$http({
				method: "get",
				url: $scope.page.url + "?planId=" + $scope.ID,
				params: {
					"pageNo": $scope.page.currentPage,
					"pageSize": $scope.page.pageSize,

				}
			}).then(function (response) {
				$scope.page.list = response.data;
				$scope.page.total = response.data.totalCount;
				$scope.page.pageSize = response.data.pageSize;
				$scope.page.list.dataList.forEach(function (item) {
          item.URLS = "preplan/downPlanAttachment?attachmentId=" + item.ID;
        });
			});
		};
		//删除按钮
		$scope.deleteTask = function (ID) {
			$("#haha").fadeIn(200);
			$('.tasks-alert').fadeIn(300);
			$scope.textContent = '确定删除吗?删除记录不可恢复！';
			$scope.deleteId = ID;
			console.log($scope.deleteId);
		};
		//删除按钮--确认操作
		$scope.yesAlert = function () {
			$http({
				url: 'preplan/deletePlanAttachment?attachmentId=' + $scope.deleteId,
				method: 'GET',
				transformResponse: function (data) {
					return data;
				}
			}).then(function () {
				$('.tasks-alert').fadeOut(200);
			}).then(function () {
				$('.tasks-alerts').fadeIn(300);
				$scope.getFileDetail();
			});
		};
		//删除按钮--取消操作
		$scope.noAlert = function (text) {
			$("#haha").fadeOut(200);
			$('.tasks-alert').fadeOut(300);
		};
		//删除按钮
		$scope.sureAlert = function () {
			$("#haha").fadeOut(200);
			$(".task-alert").fadeOut(300);
			$('.tasks-alerts').hide();
		};
		// 格式化SIZE
		$scope.input = function (input) {
			return input = (input / (1024 * 1024)).toFixed(2) + "Mb";
		};

		// 初始化
		function init() {
			$scope.page = {
				url: "preplan/listAttachmentByPlan",
				totalCount: 10,
				currentPage: 1,
				pageSize: 10,
				list: []
			};
			$scope.COMPANYNAME = $stateParams.COMPANYNAME;
			// $scope.detail = {};
			$scope.getDatail();
			$timeout(function () {
				$scope.getFileDetail();
			}, 500)
		}
		init();
	});
	app.controller('emerfileCtrl',function ($scope,$http,$rootScope,$stateParams) {
		$scope.type = "1";
		$scope.saveEmeFile = function () {
			var fd = new FormData();
			var fileValue = document.querySelector('input[type=text]');
			var file = document.querySelector('input[type=file]').files[0];
			//判断文件大小
			if (file.size / 1024 > 100000) {
				$("#haha").fadeIn(200);
				$(".task-alert").fadeIn(300);
				setTimeout(function () {
					$(".task-alert").fadeOut(200);
					$("#haha").fadeOut(300);
				}, 2000);
				fileValue.value = "请重新选择文件！注意大小！";
				return;
			}

			fd.append("file", file);
			/**
			 * 必须false才会避开jQuery对 formdata 的默认处理
			 * XMLHttpRequest会对 formdata 进行正确的处理
			 */
			$.ajax({
				type: "POST",
				url: "preplan/addPlanAttachment?planId=" +$stateParams.id + "&type=" + $scope.type,
				data: fd,
				processData: false,
				//必须false才会自动加上正确的Content-Type
				contentType: false,
				xhr: function () {
					var xhr = $.ajaxSettings.xhr();
					if (onprogress && xhr.upload) {
						xhr.upload.addEventListener("progress", onprogress, false);
						return xhr;
					}
				}
			});
			function onprogress(evt) {
				var loaded = evt.loaded; //已经上传大小情况
				var tot = evt.total; //附件总大小
				var per = Math.floor(100 * loaded / tot); //已经上传的百分比
				$("#number").html(per + "%");
				$("#son").css("width", per + "%");
				if (per == 100) {
					$("#haha").fadeIn(200);
					$(".tasks-alerts").fadeIn(300);
				}
			}

			$scope.closeModal1 = function () {
				$(".task-alert").fadeOut(200);
				$("#haha").fadeOut(230);
			};
			$scope.closeModal2 = function () {
				$(".tasks-alert").fadeOut(200);
				$("#haha").fadeOut(230);
			};
			$scope.closeModal3 = function () {
				$(".tasks-alerts").fadeOut(200);
				$("#haha").fadeOut(230);
			};
		}
	})
});
