package com.sucsoft.gzhbyjwz.util;

import org.springframework.util.FileCopyUtils;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.sql.Blob;
import java.util.Date;
import java.util.UUID;

import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServletResponse;

public final class UploadUtil {

	public static String saveMultipartFile(MultipartFile file,String filePath) throws IOException {

		if(!file.isEmpty()){
			String fileName = System.currentTimeMillis()+file.getOriginalFilename();
			// 获取文件的后缀名
			//String suffixName = fileName.substring(fileName.lastIndexOf("."));
			Path path = Paths.get(filePath,fileName);
			File dest = path.toFile();
			if (!dest.getParentFile().exists()){
				dest.getParentFile().mkdirs();
			}
			while (dest.exists()){
				fileName = System.currentTimeMillis()+fileName;
				dest = Paths.get(filePath,fileName).toFile();
			}
			file.transferTo(dest);// 文件写入
			return fileName;
		}
		return null;
	}
	
	public static final String getRealFileName(String realFileName) {
		int index = realFileName.lastIndexOf("\\");// E:/aaa/bb/c.jsp
		if (index >= 0) {
			// IE6浏览器
			realFileName.substring(index + 1);
		}
		return realFileName;
	}
	
	/*uploadPath= "/upload"
	 * uuidFileName= "abcli9srej_a.jpg"
	 * return upload/8/11
	 */
	public static final String makeUuidFilePath(String uploadPath, String uuidFileName) {
		String uuidFilePath = null;
		int code = uuidFileName.hashCode();//8
		int dir1 =code & 0xF;//3
		int dir2 =(code>>4) & 0xF;//10
		File file = new File(uploadPath+"/"+dir1+"/"+dir2);
		if(!file.exists()){//如果该目录不存在
			file.mkdirs();//创建N层目录
		}
		uuidFilePath=file.getPath();
		return uuidFilePath;
	}
	
	/*realFileName = " a.jpg"
	 * return "abcli9srej_a.jpg"
	 */
	public static final String makeUuidFileName(String realFileName) {
		return UUID.randomUUID().toString()+"_"+realFileName;
	}
	
	// 文件复制
	public static void dosave(InputStream is, String uuidFilePath,
			String uuidFileName) {
		OutputStream os = null;
		try {
			os = new FileOutputStream(uuidFilePath + "/" + uuidFileName);
			byte[] buf = new byte[1024];
			int len = 0;
			while ((len = is.read(buf)) > 0) {
				os.write(buf, 0, len);
			}
		} catch (IOException e) {
			e.printStackTrace();
		} finally {
			if (is != null) {
				try {
					is.close();
				} catch (IOException e) {
					e.printStackTrace();
				}
			}
			if (os != null) {
				try {
					os.close();
				} catch (IOException e) {
					e.printStackTrace();
				}
			}
		}
	}
	
	public static void downRead(HttpServletResponse response,InputStream is){
		ServletOutputStream sos =null;
		
			try {
				sos = response.getOutputStream();
				byte [] buffer = new byte[1024];
				int len = 0;
				while((len=is.read(buffer))>0){
					sos.write(buffer,0,len);
				}
			} catch (IOException e1) {
				e1.printStackTrace();
			}finally{
				if(sos!=null){
					try{
					is.close();
				}catch(Exception e){
					e.printStackTrace();
				}
				}
				if(is!=null){
					try{
					is.close();
				}catch(Exception e){
					e.printStackTrace();
				}
				}
			} 
		
		
	}
}
